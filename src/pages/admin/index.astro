---
import { actions } from 'astro:actions';
import { supabase } from '../../lib/supabase';
import AdminLayout from '../../layouts/AdminLayout.astro';
import EventCard from '../../components/EventCard.astro';
import ConfirmationModal from '../../components/ConfirmationModal.astro';

// Handle Actions
const createResult = Astro.getActionResult(actions.createEvent);
const signoutResult = Astro.getActionResult(actions.signout);

if (signoutResult && !signoutResult.error) {
  return Astro.redirect('/login');
}

// Pagination & Filtering
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const search = Astro.url.searchParams.get('search') || '';

// Date Filter Defaults (First and Last day of current month)
const now = new Date();
const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

const startDate = Astro.url.searchParams.get('startDate') || firstDay;
const endDate = Astro.url.searchParams.get('endDate') || lastDay;

const limit = 10;
const start = (page - 1) * limit;
const end = start + limit - 1;

let query = supabase
  .from('events')
  .select('*', { count: 'exact' });

if (search) {
  query = query.or(`title.ilike.%${search}%,location.ilike.%${search}%`);
}

if (startDate && endDate) {
  // Add time to end date to cover the full day
  query = query.gte('date', startDate).lte('date', `${endDate}T23:59:59`);
}

const { data: events, count, error } = await query
  .order('date', { ascending: true })
  .range(start, end);

const totalPages = count ? Math.ceil(count / limit) : 1;

// Handle Edit Mode
const editId = Astro.url.searchParams.get('edit');
let eventToEdit = null;
if (editId) {
  const { data } = await supabase
    .from('events')
    .select('*')
    .eq('id', editId)
    .single();
  eventToEdit = data;
}

const isEditMode = !!eventToEdit;
---

<AdminLayout title="Admin - Gestión de Eventos">

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Formulario (Columna Izquierda 1/3) -->
        <div class="md:col-span-1">
          <input type="checkbox" id="admin-form-toggle" class="hidden peer" checked={isEditMode} />
          
          <div class={`bg-white rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.05)] md:sticky md:top-24 border border-gray-100 flex flex-col md:max-h-[calc(100vh-120px)] transition-all peer-checked:[&_svg]:rotate-180 peer-checked:[&_.collapsible-content]:max-h-[2000px] ${isEditMode ? 'ring-2 ring-green-500 animate-form-highlight' : ''}`}>
            
            <!-- Accordion Header -->
            <label for="admin-form-toggle" class="flex items-center justify-between p-6 cursor-pointer md:cursor-default md:pointer-events-none group">
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        {isEditMode && <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>}
                        {isEditMode ? 'Editar Evento' : 'Publicar Nuevo Evento'}
                    </h2>
                    <p class="text-slate-500 text-sm mt-1">
                        {isEditMode ? 'Modifica los detalles del evento.' : 'Completa los datos para un nuevo evento.'}
                    </p>
                </div>
            <!-- Toggle Icon (Mobile Only) -->
                <div class="md:hidden w-10 h-10 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 group-hover:bg-slate-100 transition-all">
                    <svg class="w-6 h-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </label>

            <!-- Collapsible Content -->
            <div class="collapsible-content max-h-0 md:max-h-none overflow-hidden transition-all duration-500 ease-in-out md:flex-1 md:flex md:flex-col md:min-h-0">
                <div class="p-6 pt-0 md:pt-6 overflow-y-auto custom-scrollbar md:flex-1">
            
            <form method="POST" action={actions.createEvent} enctype="multipart/form-data" class="modern-form space-y-4" id="event-form">
              {isEditMode && <input type="hidden" name="id" value={eventToEdit.id} />}
              
              <div class="form-group">
                <label for="title">Título</label>
                <input type="text" name="title" id="title" required value={eventToEdit?.title} placeholder="Ej. Torneo Local" />
              </div>

              <div class="form-group">
                <label for="date">Fecha</label>
                <input type="datetime-local" name="date" id="date" required value={eventToEdit?.date ? new Date(eventToEdit.date).toISOString().slice(0, 16) : ''} />
              </div>

              <div class="form-group">
                <label for="location">Ubicación</label>
                <input type="text" name="location" id="location" required value={eventToEdit?.location} placeholder="Ej. Estadio Principal" />
              </div>

              <div class="form-group">
                <label for="description">Descripción</label>
                <textarea name="description" id="description" rows="3" placeholder="Detalles...">{eventToEdit?.description}</textarea>
              </div>

              <div class="form-group">
                <label for="image">Imagen</label>
                {eventToEdit?.image_url && (
                  <div class="mb-2 p-2 bg-slate-50 rounded border flex items-center gap-2">
                      <img src={eventToEdit.image_url} alt="Current" class="h-10 w-10 object-cover rounded"/>
                      <span class="text-xs text-gray-500">Actual</span>
                  </div>
                )}
                <input 
                  type="file" 
                  name="image" 
                  id="image" 
                  accept="image/*" 
                  onchange="if(this.files[0] && this.files[0].size > 2 * 1024 * 1024) { alert('La imagen es muy pesada (Max 2MB).'); this.value = ''; }" 
                />
              </div>

              <div class="pt-2 flex gap-2">
                  <button type="submit" class="submit-btn flex-1">
                    {isEditMode ? 'Guardar' : 'Publicar'}
                  </button>
                  {isEditMode && (
                      <a href="/admin" class="cancel-btn bg-gray-100 flex-none px-4 flex items-center justify-center rounded-lg hover:bg-gray-200 text-gray-600">
                          ✕
                      </a>
                  )}
              </div>
            </form>
                </div>
            </div>
          </div>
        </div>

        <!-- Lista de Eventos (Columna Derecha 2/3) -->
        <div class="md:col-span-2 space-y-6">
          
          <!-- Filtros y Busqueda -->
          <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <form method="GET" class="flex flex-col xl:flex-row gap-4">
                  <div class="flex-1 relative min-w-[200px]">
                       <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                       <input 
                         type="text" 
                         name="search" 
                         value={search} 
                         placeholder="Buscar..." 
                         class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       />
                  </div>
                  <div class="flex gap-2 flex-col sm:flex-row">
                      <div class="flex items-center gap-2">
                          <span class="text-sm text-gray-500">Desde:</span>
                          <input 
                            type="date" 
                            name="startDate" 
                            value={startDate}
                            class="px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-slate-600 text-sm"
                          />
                      </div>
                      <div class="flex items-center gap-2">
                          <span class="text-sm text-slate-500">Hasta:</span>
                          <input 
                            type="date" 
                            name="endDate" 
                            value={endDate}
                            class="px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-slate-600 text-sm"
                          />
                      </div>
                  </div>
                  <button type="submit" class="w-full xl:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-all shadow-md active:scale-95">
                      Filtrar
                  </button>
                  {(search || startDate !== firstDay || endDate !== lastDay) && (
                    <a href="/admin" class="w-full xl:w-auto px-4 py-3 border border-slate-200 text-slate-500 font-bold rounded-xl hover:bg-slate-50 flex items-center justify-center text-sm transition-all">
                        Limpiar
                    </a>
                  )}
              </form>
          </div>

          <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold text-slate-800">Eventos ({count || 0})</h2>
              <span class="text-sm text-gray-500">Página {page} de {totalPages}</span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {events?.map((event) => (
              <EventCard event={event} isAdmin={true} />
            ))}
            {(!events || events.length === 0) && (
              <div class="col-span-full py-16 text-center text-slate-600 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                  <p class="text-lg font-medium">No se encontraron eventos.</p>
                  <p class="text-sm text-slate-400 mt-1">Prueba ajustando los filtros o la búsqueda.</p>
              </div>
            )}
          </div>

          <!-- Paginacion -->
          {totalPages > 1 && (
            <div class="flex justify-center gap-3 mt-8 pb-8">
                <a 
                  href={`?page=${page - 1}${search ? `&search=${search}` : ''}&startDate=${startDate}&endDate=${endDate}`}
                  class={`flex-1 sm:flex-none flex items-center justify-center px-6 py-3 border rounded-xl font-bold transition-all shadow-sm ${page <= 1 ? 'pointer-events-none opacity-40 bg-slate-100 text-slate-400 border-slate-200' : 'bg-white text-slate-700 hover:bg-green-600 hover:text-white hover:border-green-600'}`}
                >
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    <span class="hidden sm:inline">Anterior</span>
                </a>
                <span class="flex-none px-6 py-3 text-sm font-bold text-slate-600 bg-white border border-slate-200 rounded-xl flex items-center shadow-sm">
                    {page} <span class="mx-1 text-slate-300">/</span> {totalPages}
                </span>
                <a 
                  href={`?page=${page + 1}${search ? `&search=${search}` : ''}&startDate=${startDate}&endDate=${endDate}`}
                  class={`flex-1 sm:flex-none flex items-center justify-center px-6 py-3 border rounded-xl font-bold transition-all shadow-sm ${page >= totalPages ? 'pointer-events-none opacity-40 bg-slate-100 text-slate-400 border-slate-200' : 'bg-white text-slate-700 hover:bg-green-600 hover:text-white hover:border-green-600'}`}
                >
                    <span class="hidden sm:inline">Siguiente</span>
                    <svg class="w-4 h-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
            </div>
          )}
        </div>
      </div>
      
      <ConfirmationModal />
</AdminLayout>

<script>
  import { actions } from 'astro:actions';

  const form = document.getElementById('event-form') as HTMLFormElement;
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const isEdit = !!formData.get('id');
      
      submitBtn.disabled = true;
      submitBtn.innerText = 'Guardando...';

      try {
        const result = await actions.createEvent(formData);

        if (!result.error && result.data) {
          window.showToast(isEdit ? 'Evento actualizado correctamente.' : 'Evento publicado con éxito.', 'success');
          
          setTimeout(() => {
            // After save, redirect to admin clean (to clear edit mode and refresh list)
            window.location.href = '/admin';
          }, 1500);
        } else {
          window.showToast('Error: ' + (result.error?.message || 'Error desconocido'), 'error');
          submitBtn.disabled = false;
          submitBtn.innerText = isEdit ? 'Guardar' : 'Publicar';
        }
      } catch (err) {
        window.showToast('Error de red o servidor.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerText = isEdit ? 'Guardar' : 'Publicar';
      }
    });
  }

  // Deletion logic
  const deleteButtons = document.querySelectorAll('.delete-event-btn');
  deleteButtons.forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const eventId = target.getAttribute('data-event-id');
      const eventTitle = target.getAttribute('data-event-title');

      if (!eventId) return;

      window.showConfirm(
        'Eliminar Evento',
        `¿Estás seguro de que deseas eliminar el evento "${eventTitle}"? Se borrarán también todos sus participantes. Esta acción no se puede deshacer.`,
        async () => {
          target.disabled = true;
          const originalHTML = target.innerHTML;
          target.innerHTML = '<svg class="animate-spin w-5 h-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

          try {
            const formData = new FormData();
            formData.append('id', eventId);
            
            const result = await actions.deleteEvent(formData);

            if (!result.error) {
              window.showToast('Evento y participantes eliminados correctamente.', 'success');
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              window.showToast('Error al eliminar: ' + (result.error?.message || 'Error desconocido'), 'error');
              target.disabled = false;
              target.innerHTML = originalHTML;
            }
          } catch (err) {
            window.showToast('Error de red al intentar eliminar.', 'error');
            target.disabled = false;
            target.innerHTML = originalHTML;
          }
        }
      );
    });
  });
</script>

<style>
  :root {
    --primary-color: #16a34a;
    --border-color: #e2e8f0;
    --radius: 12px;
  }
  
  @keyframes formHighlight {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); }
    50% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
  }

  .animate-form-highlight {
    animation: formHighlight 1.5s ease-out;
  }

  .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
  .form-group label { font-size: 0.875rem; font-weight: 600; color: #334155; }
  input[type="text"], input[type="datetime-local"], textarea, input[type="file"] {
    width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius);
    font-size: 0.95rem; outline: none; transition: all 0.2s; background-color: #f8fafc;
  }
  input:focus, textarea:focus { border-color: var(--primary-color); background-color: white; box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.1); }
  textarea { field-sizing: content; min-height: 5rem; max-height: 15rem; }
  .submit-btn {
    background-color: var(--primary-color); color: white; padding: 0.75rem; border-radius: var(--radius);
    font-weight: 700; font-size: 0.95rem; border: none; cursor: pointer; transition: all 0.2s;
    box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.2);
  }
  .submit-btn:hover { background-color: #15803d; transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(22, 163, 74, 0.3); }
  .submit-btn:active { transform: translateY(0); }
</style>

