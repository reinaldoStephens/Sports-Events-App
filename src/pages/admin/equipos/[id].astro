---
import AdminSidebarLayout from '../../../layouts/AdminSidebarLayout.astro';
import SmartImage from '../../../components/SmartImage.astro';
import { supabase } from '../../../lib/supabase';
import { actions } from 'astro:actions';
import ConfirmationModal from '../../../components/ConfirmationModal.astro';
import PlayerRegistrationForm from '../../../components/PlayerRegistrationForm.astro';

const { id } = Astro.params;
const torneoId = Astro.url.searchParams.get('torneoId');

if (!id) return Astro.redirect('/admin/dashboard');

// Fetch Team
const { data: equipo, error: eError } = await supabase
  .from('equipos')
  .select('*')
  .eq('id', id)
  .single();

if (eError || !equipo) return Astro.redirect('/admin/dashboard');

// Fetch Context Tournament if exists
let torneoContext = null;
if (torneoId) {
    const { data: t } = await supabase.from('torneos').select('id, nombre').eq('id', torneoId).single();
    torneoContext = t;
}

const { data: members, error: dError } = await supabase
  .from('equipo_deportistas')
  .select('*, deportistas!inner(*)') // !inner ensuring we only get valid linked players
  .eq('equipo_id', id);

// Sort players by position (field order: Portero ‚Üí Defensa ‚Üí Medio ‚Üí Delantero)
const positionWeight: Record<string, number> = {
  'Portero': 1,
  'Defensa': 2,
  'Medio': 3,
  'Delantero': 4
};

const athletes = members 
  ? members.map((m: any) => ({
      ...m.deportistas, // nombre, cedula, etc
      dorsal: m.dorsal,
      posicion: m.posicion,
      equipo_id: m.equipo_id, // keep context
      es_capitan: m.es_capitan // strictly from relation
  })).sort((a: any, b: any) => {
      const weightA = positionWeight[a.posicion || ''] || 999;
      const weightB = positionWeight[b.posicion || ''] || 999;
      return weightA - weightB;
  })
  : [];

// Position badge colors for display
const positionColors: Record<string, string> = {
  'Portero': 'bg-purple-100 text-purple-700',
  'Defensa': 'bg-blue-100 text-blue-700',
  'Medio': 'bg-green-100 text-green-700',
  'Delantero': 'bg-orange-100 text-orange-700'
};

// Handle Edit Mode via URL
const editCedula = Astro.url.searchParams.get('edit');
let playerToEdit: any = null;

if (editCedula) {
  playerToEdit = athletes.find((p: any) => p.numero_cedula === editCedula);
}
---

<AdminSidebarLayout title={`Administrar: ${equipo.nombre}`}>
    <div class="space-y-8 pb-20">
        <!-- Header / Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-slate-400 font-bold uppercase tracking-widest">
            <a href="/admin/dashboard" class="hover:text-blue-600">Dashboard</a>
            <span>/</span>
            {torneoContext ? (
                <a href={`/admin/torneo/${torneoContext.id}?tab=equipos`} class="hover:text-blue-600">{torneoContext.nombre}</a>
            ) : (
                 <a href="/admin/equipos" class="hover:text-blue-600">Equipos</a>
            )}
            <span>/</span>
            <span class="text-slate-900">{equipo.nombre}</span>
        </div>

        <!-- Team Details Card -->
        <div class="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-100 flex flex-col md:flex-row gap-8 items-start relative overflow-hidden">
            
            <div class="w-32 h-32 rounded-3xl bg-slate-50 shadow-inner flex-shrink-0">
                <SmartImage 
                    entityId={equipo.id} 
                    entityType="team" 
                    currentImage={equipo.logo_url} 
                    fallbackInitial={equipo.nombre[0]}
                    bucket="logos" 
                    className="w-full h-full rounded-3xl"
                />
            </div>

            <div class="flex-1 space-y-6 w-full max-w-2xl">
                <div>
                     <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter leading-none">{equipo.nombre}</h1>
                     <p class="text-slate-400 text-sm font-bold uppercase mt-2">{athletes.length} Jugadores Inscritos</p>
                </div>

                <div class="space-y-4 pt-4 border-t border-slate-50">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2">Tel√©fono Contacto</label>
                            <div class="flex items-center gap-2">
                                <span class="bg-slate-50 text-slate-700 font-bold px-4 py-2 rounded-xl text-sm w-full block border border-slate-100">
                                    {equipo.telefono_contacto || 'No registrado'}
                                </span>
                            </div>
                        </div>
                        
                         <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2">Direcci√≥n de Cancha</label>
                            <div class="bg-slate-50 text-slate-700 font-bold px-4 py-2 rounded-xl text-sm w-full block border border-slate-100">
                                {equipo.direccion_cancha || 'No registrada'}
                            </div>
                        </div>


                    </div>

                    <!-- Coaching Staff Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                         <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2">Director T√©cnico</label>
                            <div class="bg-slate-50 text-slate-700 font-bold px-4 py-2 rounded-xl text-sm w-full block border border-slate-100">
                                {equipo.director_tecnico_nombre ? (
                                    <div class="flex flex-col">
                                        <span>{equipo.director_tecnico_nombre}</span>
                                        <span class="text-xs text-slate-500 font-normal">C√©dula: {equipo.director_tecnico_cedula}</span>
                                    </div>
                                ) : 'No asignado'}
                            </div>
                        </div>
                        
                         <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2">Asistente T√©cnico</label>
                            <div class="bg-slate-50 text-slate-700 font-bold px-4 py-2 rounded-xl text-sm w-full block border border-slate-100">
                                {equipo.asistente_tecnico_nombre ? (
                                    <div class="flex flex-col">
                                        <span>{equipo.asistente_tecnico_nombre}</span>
                                        <span class="text-xs text-slate-500 font-normal">C√©dula: {equipo.asistente_tecnico_cedula}</span>
                                    </div>
                                ) : 'No asignado'}
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-start pt-2">
                        <button onclick="document.getElementById('edit-team-modal').showModal()" class="px-6 py-3 bg-blue-600 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            Editar Informaci√≥n
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="absolute top-0 right-0 p-8">
                 <button onclick={`deleteItem('Team', '${id}')`} class="text-red-200 hover:text-red-500 transition-colors p-2 rounded-xl hover:bg-red-50" title="Eliminar Equipo">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        </div>

        <!-- Roster / Players -->
        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Plantilla de Jugadores</h3>
                <div class="flex flex-wrap items-center gap-2">
                    <button onclick="downloadExcelTemplate()" class="px-5 py-2.5 bg-green-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-green-700 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        Descargar Template
                    </button>
                    <button onclick="document.getElementById('excel-file-input').click()" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        Importar desde Excel
                    </button>
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="hidden" />

                     <button 
                        id="bulk-delete-btn" 
                        class="hidden bg-red-100 text-red-700 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-red-200 transition-all flex items-center gap-2"
                        onclick="deleteSelectedPlayers()"
                     >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        Eliminar Seleccionados
                     </button>

                    <button onclick="document.getElementById('player-form-container').scrollIntoView({ behavior: 'smooth' })" class="px-5 py-2.5 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                        A√±adir Jugador
                    </button>
                </div>
            </div>

            {athletes.length > 0 ? (
                <div class="overflow-x-auto bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50">
                                <th class="px-6 py-4 w-10">
                                    <input type="checkbox" id="select-all-players" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                </th>
                                <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">#</th>
                                <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Jugador</th>
                                <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Edad</th>
                                <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Posici√≥n</th>
                                <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {athletes.map((player, index) => (
                                <tr class={`border-b border-slate-50 hover:bg-blue-50/50 transition-colors group ${playerToEdit?.numero_cedula === player.numero_cedula ? 'bg-blue-50 ring-2 ring-blue-500/20' : ''}`}>
                                    <td class="px-6 py-5">
                                        <input 
                                            type="checkbox" 
                                            class="player-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500" 
                                            value={player.numero_cedula}
                                        />
                                    </td>
                                    <td class="px-6 py-5 font-black text-slate-400 text-sm">
                                        {player.dorsal || 'N/A'}
                                    </td>
                                    <td class="px-6 py-5">
                                        <div>
                                            <h4 class="font-bold text-slate-900 flex items-center gap-2">
                                                {player.nombre}
                                                {equipo.capitan_id === player.numero_cedula && (
                                                    <span title="Capit√°n del Equipo" class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full border border-amber-200 uppercase tracking-wider font-extrabold flex items-center gap-1">
                                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg> 
                                                        Capit√°n
                                                    </span>
                                                )}
                                            </h4>
                                            <p class="text-[10px] text-slate-400 font-semibold mt-0.5">
                                                {player.numero_cedula || 'Sin c√©dula'}
                                            </p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-5 font-bold text-slate-700">
                                        {player.edad ? `${player.edad} a√±os` : 'N/A'}
                                    </td>
                                    <td class="px-6 py-5">
                                        <span class={`inline-block px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-wider ${positionColors[player.posicion || ''] || 'bg-slate-100 text-slate-700'}`}>
                                            {player.posicion || 'N/A'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-5">
                                        <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            {equipo.capitan_id === player.numero_cedula ? (
                                                 <button 
                                                    onclick={`setCaptain('${player.numero_cedula}', true)`} 
                                                    class="p-2 text-amber-500 hover:text-amber-700 hover:bg-amber-50 rounded-lg transition-colors"
                                                    title="Quitar capitan√≠a"
                                                >
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                                </button>
                                            ) : (
                                                <button 
                                                    onclick={`setCaptain('${player.numero_cedula}', false)`} 
                                                    class="p-2 text-slate-300 hover:text-amber-500 hover:bg-amber-50 rounded-lg transition-colors"
                                                    title="Designar Capit√°n"
                                                >
                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                                                </button>
                                            )}
                                            <a 
                                                href={`?edit=${player.numero_cedula}#player-form-container`}
                                                class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                title="Editar jugador"
                                            >
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                            </a>
                                            <button 
                                                onclick={`deleteItem('Athlete', '${player.numero_cedula}')`} 
                                                class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Eliminar jugador"
                                            >
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            ) : (
                <div class="py-12 text-center bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-200">
                    <p class="text-slate-400 font-bold mb-4 text-sm">Este equipo a√∫n no tiene jugadores.</p>
                </div>
            )}
        </div>

        <!-- Excel Import Error Modal -->
        <dialog id="import-errors-modal" class="rounded-3xl shadow-2xl backdrop:bg-black/50 max-w-3xl w-full">
            <div class="bg-white rounded-3xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">Errores de Importaci√≥n</h3>
                    </div>
                    <button onclick="document.getElementById('import-errors-modal').close()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <div id="error-details-content" class="space-y-4">
                    <!-- Will be filled by JavaScript -->
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('import-errors-modal').close()" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-colors">
                        Entendido
                    </button>
                </div>
            </div>
        </dialog>

        <!-- Unified Player Form (Reused from Delegate View) -->
        <div id="player-form-container" class="pt-8 border-t border-slate-200">
             {playerToEdit && (
                <div class="flex items-center justify-between mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white rounded-lg">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </div>
                        <h3 class="text-sm font-black text-blue-900 uppercase tracking-wide">Modo Edici√≥n Activado</h3>
                    </div>
                    <a href={`/admin/equipos/${id}`} class="text-[10px] font-black uppercase tracking-widest text-blue-500 hover:text-blue-700 hover:bg-blue-100 px-3 py-2 rounded-lg transition-colors">
                        Cancelar Edici√≥n
                    </a>
                </div>
            )}
            
        <dialog id="import-errors-modal" class="rounded-3xl shadow-2xl backdrop:bg-black/50 max-w-3xl w-full">
            <div class="bg-white rounded-3xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">Errores de Importaci√≥n</h3>
                    </div>
                    <button onclick="document.getElementById('import-errors-modal').close()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <div id="error-details-content" class="space-y-4">
                    <!-- Will be filled by JavaScript -->
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('import-errors-modal').close()" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-colors">
                        Entendido
                    </button>
                </div>
            </div>
        </dialog>        <PlayerRegistrationForm 
                equipoId={id} 
                editMode={!!playerToEdit} 
                playerData={playerToEdit}
                redirectUrl={`/admin/equipos/${id}`}
            />
        </div>

    </div>



    <ConfirmationModal />

    <script>
        import { actions } from 'astro:actions';

        declare global {
            interface Window {
                showToast: (message: string, type?: 'success' | 'error') => void;
                deleteItem: (type: string, id: string) => Promise<void>;
                openEditAthlete: (cedula: string, nombre: string, fecha_nacimiento: string, posicion: string) => void;
                setCaptain: (playerId: string, isRemove: boolean) => Promise<void>;
            }
        }

        // Check for toast params on load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const msg = urlParams.get('msg');
            const type = urlParams.get('type') as 'success' | 'error' | null;

            if (msg && type) {
                window.showToast(msg, type);
                // Clean URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }
            
            // Auto-scroll to form if editing
            if (urlParams.get('edit')) {
                const form = document.getElementById('player-form-container');
                if (form) setTimeout(() => form.scrollIntoView({ behavior: 'smooth' }), 100);
            }

            // Phone formatting
            const setupPhoneInput = (id: string) => {
                const phoneInput = document.getElementById(id) as HTMLInputElement;
                if (phoneInput) {
                    phoneInput.addEventListener('input', (e) => {
                        const target = e.target as HTMLInputElement;
                        let value = target.value.replace(/\D/g, '');
                        
                        if (value.length > 8) {
                            value = value.slice(0, 8);
                        }
                        
                        if (value.length > 4) {
                            value = value.slice(0, 4) + '-' + value.slice(4);
                        }
                        
                        target.value = value;
                    });
                }
            };
            
            // Setup regular edit input if exists (legacy)
            setupPhoneInput('edit-telefono-input');
            // Setup new modal input
            setupPhoneInput('modal-telefono-input');
        });


        // Global interface extension for window
        declare global {
            interface Window {
                deleteSelectedPlayers: () => Promise<void>;
                showConfirm: (title: string, msg: string, onConfirm: () => void) => void;
            }
        }

        // Bulk Delete Logic
        const selectAll = document.getElementById('select-all-players');
        const checkboxes = document.querySelectorAll('.player-checkbox');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        function updateBulkActionUI() {
            const selected = Array.from(checkboxes).filter((cb: any) => cb.checked);
            if (bulkDeleteBtn) {
                if (selected.length > 0) {
                    bulkDeleteBtn.classList.remove('hidden');
                    // Update button text to show count
                    const textNode = Array.from(bulkDeleteBtn.childNodes).find(node => node.nodeType === 3);
                    if(textNode) textNode.textContent = ` Eliminar (${selected.length})`;
                    else bulkDeleteBtn.innerHTML = bulkDeleteBtn.innerHTML.replace(/Eliminar.*$/, `Eliminar (${selected.length})`);
                } else {
                    bulkDeleteBtn.classList.add('hidden');
                }
            }
        }

        if (selectAll) {
            selectAll.addEventListener('change', (e: any) => {
                checkboxes.forEach((cb: any) => cb.checked = e.target.checked);
                updateBulkActionUI();
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                 const allChecked = Array.from(checkboxes).every((c: any) => c.checked);
                 if (selectAll) (selectAll as HTMLInputElement).checked = allChecked;
                 updateBulkActionUI();
            });
        });

        window.deleteSelectedPlayers = async () => {
            const selected = Array.from(document.querySelectorAll('.player-checkbox:checked'))
                .map((cb: any) => cb.value);
            
            if (selected.length === 0) return;

            window.showConfirm(
                'Eliminar Jugadores', 
                `¬øEst√°s seguro de eliminar ${selected.length} jugador(es)? Esta acci√≥n no se puede deshacer.`,
                async () => {
                    try {
                        const formData = new FormData();
                        formData.append('cedulas', JSON.stringify(selected));
                        // Add context
                        const teamId = document.querySelector('input[name="id"]')?.getAttribute('value') || '';
                        formData.append('equipo_id', teamId);
                        
                        const result = await actions.deletePlayers(formData);
                        
                        if (result.error) {
                            window.showToast(result.error.message, 'error');
                        } else {
                             // Reload with toast params
                             const currentUrl = new URL(window.location.href);
                             currentUrl.searchParams.set('msg', 'Jugadores eliminados correctamente');
                             currentUrl.searchParams.set('type', 'success');
                             window.location.href = currentUrl.toString();
                        }

                    } catch (error: any) {
                        window.showToast(error.message, 'error');
                    }
                }
            );
        };

        window.deleteItem = async (type: string, id: string) => {
            window.showConfirm(
                `Eliminar ${type === 'Athlete' ? 'Jugador' : 'Equipo'}`,
                `¬øEst√°s seguro de que deseas eliminar este ${type === 'Athlete' ? 'jugador' : 'equipo'}? Esta acci√≥n no se puede deshacer.`,
                async () => {
                    const fd = new FormData();
                    
                    let result;
                    if (type === 'Athlete') {
                         fd.append('numero_cedula', id);
                         // Add context
                         const teamId = document.querySelector('input[name="id"]')?.getAttribute('value') || '';
                         fd.append('equipo_id', teamId);

                         result = await actions.deletePlayer(fd);
                    }
                    else if (type === 'Team') {
                        fd.append('id', id);
                        result = await actions.deleteTeam(fd);
                        if (!result?.error) {
                            window.location.href = `/admin/equipos?msg=Equipo eliminado correctamente&type=success`;
                            return;
                        }
                    }
                    
                    if (result?.error) {
                        window.showToast(result.error.message, 'error');
                    } else {
                        // Reload with success message
                        const msg = type === 'Athlete' ? 'Jugador eliminado correctamente' : 'Elemento eliminado';
                        window.location.href = `${window.location.pathname}?msg=${encodeURIComponent(msg)}&type=success`;
                    }
                }
            );
        };

        window.setCaptain = async (cedula: string, isRemove: boolean) => {
            const teamId = document.querySelector('input[name="id"]')?.getAttribute('value');
            if (!teamId) return;

            const actionName = isRemove ? 'removeCaptain' : 'setCaptain';
            const formData = new FormData();
            formData.append('equipo_id', teamId);
            if (!isRemove) formData.append('numero_cedula', cedula);

            try {
                const action = (actions as any)[actionName];
                const { error } = await action(formData);

                if (error) {
                    window.showToast(error.message, 'error');
                } else {
                    const msg = isRemove ? 'Capit√°n removido correctamente' : 'Capit√°n asignado correctamente';
                    window.location.href = `${window.location.pathname}?msg=${encodeURIComponent(msg)}&type=success`;
                }
            } catch (err: any) {
                window.showToast(err.message || 'Error al actualizar capit√°n', 'error');
            }
        };

         const handleForm = (formId: string, actionName: string, successMsg: string) => {
            const form = document.getElementById(formId) as HTMLFormElement;
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const action = (actions as any)[actionName];
                const { error } = await action(formData);

                if (error) {
                    window.showToast(error.message, 'error');
                } else {
                     window.location.href = `${window.location.pathname}?msg=${encodeURIComponent(successMsg)}&type=success`;
                }
            });
        };

        handleForm('update-team-form', 'updateTeam', 'Equipo actualizado correctamente');
        // create and update athlete forms are now handled by PlayerRegistrationForm component logic


        // Modal Close Logic
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const dialog = btn.closest('dialog');
                dialog?.close();
            });
        });

         document.querySelectorAll('dialog').forEach(dialog => {
            dialog.addEventListener('click', (e) => {
                const rect = dialog.getBoundingClientRect();
                const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
                  rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
                if (!isInDialog) {
                    dialog.close();
                }
            });
        });

        // Excel Import Functionality
        declare global {
            interface Window {
                downloadExcelTemplate: () => void;
                handleExcelImport: (file: File) => Promise<void>;
                confirmImport: () => Promise<void>;
                previewData: any;
            }
        }

        window.downloadExcelTemplate = async () => {
            try {
                // Dynamic import to avoid SSR issues
                const { generatePlayerTemplate } = await import('../../../lib/excel-helpers');
                const buffer = generatePlayerTemplate();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'template_jugadores.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                window.showToast('Template descargado correctamente', 'success');
            } catch (error) {
                window.showToast(`Error al generar template: ${error}`, 'error');
            }
        };

        window.handleExcelImport = async (file: File) => {
            try {
                // Read file as base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const base64 = e.target?.result as string;
                        const teamId = window.location.pathname.split('/').pop() || '';
                        
                        const formData = new FormData();
                        formData.append('excelFile', base64);
                        formData.append('equipo_id', teamId);
                        
                        window.showToast('Procesando archivo Excel...', 'success');
                        
                        const result = await actions.importPlayersFromExcel(formData);
                        
                        if (result.error) {
                            window.showToast(result.error.message, 'error');
                        } else if (result.data) {
                            const { imported, skipped, errors, totalRows, coachingStaffUpdated } = result.data;
                            
                            if (errors && errors.length > 0) {
                                // Show error modal with details
                                showImportErrorsModal(imported, skipped, totalRows, errors, coachingStaffUpdated);
                            } else {
                                // Build success message
                                let msgParts = [];
                                
                                if (imported > 0) {
                                    msgParts.push(`${imported} jugador${imported !== 1 ? 'es' : ''} importado${imported !== 1 ? 's' : ''}`);
                                }
                                
                                if (skipped > 0) {
                                    msgParts.push(`${skipped} ya exist√≠an (omitidos)`);
                                }
                                
                                if (coachingStaffUpdated) {
                                    msgParts.push('Cuerpo t√©cnico actualizado');
                                }
                                
                                const msg = msgParts.length > 0 
                                    ? msgParts.join('. ') + '.'
                                    : 'Importaci√≥n completada';
                                    
                                window.location.href = `${window.location.pathname}?msg=${encodeURIComponent(msg)}&type=success`;
                            }
                        }
                    } catch (error) {
                        window.showToast(`Error al procesar archivo: ${error}`, 'error');
                    }
                };
                
                reader.onerror = () => {
                    window.showToast('Error al leer el archivo', 'error');
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                window.showToast(`Error: ${error}`, 'error');
            }
        };

        function showImportErrorsModal(imported: number, skipped: number, totalRows: number, errors: any[], coachingStaffUpdated?: boolean) {
            const errorContent = document.getElementById('error-details-content');
            if (!errorContent) return;

            let html = `
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div>
                                <p class="text-sm font-bold text-blue-900">Resumen de Importaci√≥n</p>
                                <p class="text-xs text-blue-700 mt-1">
                                    ‚úÖ <strong>${imported}</strong> jugador${imported !== 1 ? 'es' : ''} importado${imported !== 1 ? 's' : ''} correctamente<br/>
                                    ${skipped > 0 ? `‚è≠Ô∏è <strong>${skipped}</strong> ya exist√≠an (omitidos)<br/>` : ''}
                                    ${coachingStaffUpdated ? `üëî Cuerpo t√©cnico actualizado<br/>` : ''}
                                    üìä Total procesado: <strong>${totalRows}</strong> filas
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                        <p class="text-sm font-bold text-red-900 mb-3">‚ùå ${errors.length} error${errors.length !== 1 ? 'es' : ''} encontrado${errors.length !== 1 ? 's' : ''}:</p>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
            `;

            errors.forEach((error, index) => {
                html += `
                    <div class="flex items-start gap-2 text-xs bg-white p-3 rounded-lg border border-red-100">
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-red-100 text-red-700 font-bold flex items-center justify-center text-[10px]">${index + 1}</span>
                        <div class="flex-1">
                            ${error.row ? `<p class="font-semibold text-red-800">Fila ${error.row}</p>` : ''}
                            <p class="text-red-600 ${error.row ? 'mt-0.5' : ''}">${error.message}</p>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <p class="text-xs text-amber-800">
                            <strong>üí° Sugerencia:</strong> Corrige los errores en tu archivo Excel. Los jugadores v√°lidos ya fueron importados, puedes reimportar el archivo completo con las correcciones.
                        </p>
                    </div>
                </div>
            `;

            errorContent.innerHTML = html;

            // Show modal
            const modal = document.getElementById('import-errors-modal') as HTMLDialogElement;
            modal?.showModal();
        }

        // Attach file input handler
        const fileInput = document.getElementById('excel-file-input') as HTMLInputElement;
        if (fileInput) {
            fileInput.addEventListener('change', async (e) => {
                const file = (e.target as HTMLInputElement).files?.[0];
                if (file) {
                    await window.handleExcelImport(file);
                    // Reset input so same file can be selected again
                    fileInput.value = '';
                }
            });
        }
    </script>

    <!-- Edit Team Modal -->
    <dialog id="edit-team-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-2xl relative backdrop:bg-slate-900/60 focus:outline-none overflow-hidden" role="dialog" aria-modal="true" tabindex="-1">
        <button onclick="document.getElementById('edit-team-modal').close()" class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Editar Equipo</h3>
        
        <div class="h-full max-h-[70vh] overflow-y-auto pr-2 pb-6 custom-scrollbar">
            <form id="edit-team-form" class="space-y-6">
                <input type="hidden" name="id" value={id} />
                
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Nombre del Equipo</label>
                        <input type="text" name="nombre" value={equipo.nombre} required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-slate-300" />
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Tel√©fono Contacto</label>
                            <input type="tel" name="telefono_contacto" value={equipo.telefono_contacto || ''} placeholder="8888-8888" pattern="[0-9]{4}-?[0-9]{4}" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-slate-300" />
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Direcci√≥n de Cancha</label>
                        <textarea name="direccion_cancha" rows="3" placeholder="Ej: Estadio Municipal de..." class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-blue-500 transition-all resize-none placeholder:text-slate-300">{equipo.direccion_cancha || ''}</textarea>
                    </div>

                    <!-- Coaching Staff Section -->
                    <div class="border-t border-slate-200 pt-4 mt-2">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4 mb-3">Cuerpo T√©cnico</h4>
                        
                        <!-- Director T√©cnico -->
                        <div class="space-y-2 mb-3">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wide pl-4">Director T√©cnico</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" name="director_tecnico_cedula" value={equipo.director_tecnico_cedula || ''} pattern="[0-9]{9,12}" placeholder="C√©dula" class="w-full bg-slate-50 border-none px-4 py-3 rounded-xl font-bold text-slate-900 text-sm focus:ring-2 focus:ring-slate-900 transition-all" />
                                <input type="text" name="director_tecnico_nombre" value={equipo.director_tecnico_nombre || ''} placeholder="Nombre" class="w-full bg-slate-50 border-none px-4 py-3 rounded-xl font-bold text-slate-900 text-sm focus:ring-2 focus:ring-slate-900 transition-all" />
                            </div>
                        </div>

                        <!-- Asistente T√©cnico -->
                        <div class="space-y-2">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wide pl-4">Asistente T√©cnico</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" name="asistente_tecnico_cedula" value={equipo.asistente_tecnico_cedula || ''} pattern="[0-9]{9,12}" placeholder="C√©dula" class="w-full bg-slate-50 border-none px-4 py-3 rounded-xl font-bold text-slate-900 text-sm focus:ring-2 focus:ring-slate-900 transition-all" />
                                <input type="text" name="asistente_tecnico_nombre" value={equipo.asistente_tecnico_nombre || ''} placeholder="Nombre" class="w-full bg-slate-50 border-none px-4 py-3 rounded-xl font-bold text-slate-900 text-sm focus:ring-2 focus:ring-slate-900 transition-all" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-50">
                    <button type="button" onclick="document.getElementById('edit-team-modal').close()" class="px-6 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Cancelar</button>
                    <button type="submit" class="px-8 py-3 bg-blue-600 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </dialog>

    <script>
        import { actions } from 'astro:actions';

        // Handle edit team form submission
        const editTeamForm = document.getElementById('edit-team-form') as HTMLFormElement;
        if (editTeamForm) {
            editTeamForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(editTeamForm);
                
                try {
                    const result = await actions.updateTeam(formData);
                    
                    if (result.error) {
                        window.showToast(result.error.message, 'error');
                    } else {
                        // Close modal and reload with success message
                        (document.getElementById('edit-team-modal') as HTMLDialogElement)?.close();
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('msg', 'Equipo actualizado correctamente');
                        currentUrl.searchParams.set('type', 'success');
                        window.location.href = currentUrl.toString();
                    }
                } catch (error: any) {
                    window.showToast(error.message || 'Error al actualizar equipo', 'error');
                }
            });
        }
    </script>
</AdminSidebarLayout>
