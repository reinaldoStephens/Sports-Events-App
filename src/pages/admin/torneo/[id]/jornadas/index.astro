---
import AdminSidebarLayout from '../../../../../layouts/AdminSidebarLayout.astro';
import { actions } from 'astro:actions';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/dashboard');
}

// Obtener torneo
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const torneoResponse = await fetch(
  `${supabaseUrl}/rest/v1/torneos?id=eq.${id}&select=*`,
  {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${supabaseAnonKey}`,
    }
  }
);

const torneos = await torneoResponse.json();
const torneo = torneos[0];

if (!torneo) {
  return Astro.redirect('/admin/dashboard');
}

// Obtener jornadas
const jornadasResponse = await fetch(
  `${supabaseUrl}/rest/v1/jornadas?torneo_id=eq.${id}&select=*,partidos(*,local:equipo_local_id(nombre,logo_url),visitante:equipo_visitante_id(nombre,logo_url))&order=numero_jornada`,
  {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${supabaseAnonKey}`,
    }
  }
);

const jornadas = await jornadasResponse.json();

// Verificar si la configuraci√≥n incluye doble vuelta
const config = (torneo.config || {}) as { double_round?: boolean; use_seeding?: boolean };
const doubleRound = config.double_round || false;
const useSeeding = config.use_seeding || false;
---

<AdminSidebarLayout title={`Gesti√≥n de Jornadas - ${torneo.nombre}`}>
  <main class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <a href={`/admin/torneo/${id}?tab=jornadas`} class="text-blue-600 hover:underline">‚Üê Volver al Dashboard</a>
      <h1 class="text-3xl font-bold mt-4">{torneo.nombre}</h1>
      <p class="text-gray-600">Tipo: {torneo.tipo === 'liga' ? 'Liga (Round-Robin)' : 'Eliminaci√≥n Simple'}</p>
    </div>

    {/* Botones de Acci√≥n */}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Gesti√≥n de Fixture</h2>
      
      <div class="flex flex-wrap gap-4">
        {jornadas.length === 0 ? (
          <div class="flex gap-4 flex-wrap">
            <button
              id="generate-fixture-btn"
              class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
              data-id={id}
              data-tipo={torneo.tipo}
              data-nombre={torneo.nombre}
            >
              ü§ñ Generar Fixture Autom√°tico
              {torneo.tipo === 'liga' && doubleRound && <span class="text-sm">(Ida y Vuelta)</span>}
              {torneo.tipo === 'eliminacion_simple' && useSeeding && <span class="text-sm">(Con Seeding)</span>}
            </button>
            <a 
              href={`/admin/torneo/${id}/jornadas/crear`}
              class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition"
            >
              + Crear Jornada Manual
            </a>
          </div>
        ) : (
          <div class="flex gap-4">
            <a 
              href={`/admin/torneo/${id}/jornadas/crear`}
              class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition"
            >
              + Crear Jornada Manual
            </a>
            <button
              type="button"
              id="btn-delete-all-manual"
              class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition"
              data-id={id}
            >
              üóëÔ∏è Eliminar Todas las Jornadas
            </button>
          </div>
        )}
      </div>

      {jornadas.length === 0 && (
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-sm text-blue-800">
            <strong>Generaci√≥n Autom√°tica:</strong> Usa el bot√≥n "Generar Fixture Autom√°tico" para crear todas las jornadas y partidos 
            basados en el tipo de torneo ({torneo.tipo}). 
            {torneo.tipo === 'eliminacion_simple' && ' Se generar√° un bracket de eliminaci√≥n con seeding autom√°tico si est√° habilitado.'}
          </p>
          <p class="text-sm text-blue-800 mt-2">
            <strong>Creaci√≥n Manual:</strong> Si el torneo ya comenz√≥ o requiere configuraci√≥n personalizada, 
            puedes crear jornadas y partidos manualmente.
          </p>
        </div>
      )}
    </div>

    {/* Lista de Jornadas */}
    {jornadas.length > 0 && (
      <div class="space-y-4">
        <h2 class="text-2xl font-bold">Jornadas ({jornadas.length})</h2>
        
        {jornadas.map((jornada: any) => (
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold">
                {jornada.nombre_fase || `Jornada ${jornada.numero_jornada}`}
              </h3>
              <a 
                href={`/admin/torneo/${id}/jornadas/${jornada.id}/partidos/crear`}
                class="text-blue-600 hover:underline"
              >
                + Agregar Partido
              </a>
            </div>

            {jornada.partidos && jornada.partidos.length > 0 ? (
              <div class="space-y-2">
                {jornada.partidos.map((partido: any) => (
                  <div class="flex items-center justify-between p-3 bg-gray-50 rounded border">
                    <div class="flex items-center gap-4 flex-1">
                      <div class="flex items-center gap-2 w-2/5 justify-end">
                        {partido.local?.logo_url && (
                          <img src={partido.local.logo_url} alt="" class="w-6 h-6 rounded" />
                        )}
                        <span class="font-medium">{partido.local?.nombre || 'TBD'}</span>
                      </div>
                      <div class="text-center w-1/5">
                        {partido.estado_partido === 'finalizado' ? (
                          <span class="font-bold text-lg">
                            {partido.puntos_local} - {partido.puntos_visitante}
                          </span>
                        ) : (
                          <span class="text-gray-400">vs</span>
                        )}
                      </div>
                      <div class="flex items-center gap-2 w-2/5">
                        <span class="font-medium">{partido.visitante?.nombre || 'TBD'}</span>
                        {partido.visitante?.logo_url && (
                          <img src={partido.visitante.logo_url} alt="" class="w-6 h-6 rounded" />
                        )}
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class={`px-2 py-1 rounded text-xs ${
                        partido.estado_partido === 'finalizado' ? 'bg-green-100 text-green-800' :
                        partido.estado_partido === 'en_curso' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {partido.estado_partido}
                      </span>
                      {torneo.tipo === 'eliminacion_simple' && partido.ronda && (
                        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
                          {partido.ronda}
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-gray-500 italic">No hay partidos en esta jornada</p>
            )}
          </div>
        ))}
      </div>
    )}

    {jornadas.length === 0 && (
      <div class="bg-gray-50 rounded-lg p-12 text-center">
        <p class="text-gray-600 text-lg">No hay jornadas creadas para este torneo.</p>
        <p class="text-gray-500 mt-2">Usa los botones arriba para generar el fixture autom√°ticamente o crear jornadas manualmente.</p>
      </div>
    )}
  </main>
  
  <script>
    declare global {
        interface Window {
            showToast: (message: string, type?: 'success' | 'error') => void;
            showConfirm: (title: string, message: string, onConfirm: () => void) => void;
        }
    }

    // Success message check (if coming from redirect)
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const msg = urlParams.get('msg');
        const type = urlParams.get('type') as 'success' | 'error' | null;

        if (msg && type && typeof window.showToast === 'function') {
           window.showToast(msg, type);
           const newUrl = window.location.pathname;
           window.history.replaceState({}, '', newUrl);
        }
    });

    const btnGenerate = document.getElementById('generate-fixture-btn');
    if (btnGenerate) {
        btnGenerate.addEventListener('click', () => {
            const id = btnGenerate.dataset.id;
            const tipo = btnGenerate.dataset.tipo;
            const nombre = btnGenerate.dataset.nombre;
            const actionType = tipo === 'liga' ? 'round-robin' : 'single-elimination';

            const confirmMsg = tipo === 'liga' 
                ? `¬øGenerar fixture autom√°tico para "${nombre}"?\n\nSe crear√°n todas las jornadas y partidos del torneo tipo Liga.`
                : `¬øGenerar fixture autom√°tico para "${nombre}"?\n\nSe crear√° el bracket de eliminaci√≥n simple con todos los partidos.`;

            const onConfirm = async () => {
                try {
                    // Loading state
                    const originalText = btnGenerate.innerHTML;
                    btnGenerate.innerHTML = '‚è≥ Generando...';
                    (btnGenerate as HTMLButtonElement).disabled = true;

                    const response = await fetch(`/api/generate-fixture/${id}`, {
                        method: 'POST',
                        body: new URLSearchParams({ action: actionType })
                    });
                    
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        // Reload with success param
                         const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('msg', 'Fixture generado correctamente');
                        currentUrl.searchParams.set('type', 'success');
                        window.location.href = currentUrl.toString();
                    } else {
                        // Try to parse error message
                        let errorMsg = 'Error en la respuesta del servidor';
                        try {
                            const errorData = await response.json();
                            if (errorData.message) errorMsg = errorData.message;
                        } catch (e) {
                            console.error('Cant parse error json', e);
                        }
                        throw new Error(errorMsg);
                    }
                } catch (error: any) {
                    console.error(error);
                    if (typeof window.showToast === 'function') {
                        window.showToast(error.message || 'Error al generar fixture', 'error');
                    } else {
                        alert(error.message || 'Error al generar fixture');
                    }
                    // Reset button
                    (btnGenerate as HTMLButtonElement).disabled = false;
                    btnGenerate.innerHTML = 'ü§ñ Generar Fixture Autom√°tico';
                }
            };

            if (typeof window.showConfirm === 'function') {
                window.showConfirm('Generar Fixture', confirmMsg, onConfirm);
            } else if (confirm(confirmMsg)) {
                onConfirm();
            }
        });
    }

    const btnDelete = document.getElementById('btn-delete-all-manual');
    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
             const id = btnDelete.dataset.id;
             const confirmMsg = '¬øEst√°s seguro de eliminar TODAS las jornadas y partidos? Esta acci√≥n no se puede deshacer.';

             const onConfirm = async () => {
                 try {
                     const originalText = btnDelete.innerHTML;
                     btnDelete.innerHTML = '‚è≥ Eliminando...';
                     (btnDelete as HTMLButtonElement).disabled = true;

                     const response = await fetch(`/api/delete-all-jornadas/${id}`, { method: 'POST' });
                     
                     if (response.redirected) {
                         window.location.href = response.url;
                     } else if (response.ok) {
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('msg', 'Jornada eliminada correctamente');
                        currentUrl.searchParams.set('type', 'success');
                        window.location.href = currentUrl.toString();
                     } else {
                         throw new Error('Error al eliminar');
                     }
                 } catch (error) {
                     console.error(error);
                     if (typeof window.showToast === 'function') {
                         window.showToast('Error al eliminar jornadas', 'error');
                     } else {
                         alert('Error al eliminar');
                     }
                     (btnDelete as HTMLButtonElement).disabled = false;
                     btnDelete.innerHTML = 'üóëÔ∏è Eliminar Todas las Jornadas';
                 }
             };

             if (typeof window.showConfirm === 'function') {
                  window.showConfirm('Eliminar Todo', confirmMsg, onConfirm);
             } else if (confirm(confirmMsg)) {
                  onConfirm();
             }
        });
    }
  </script>
</AdminSidebarLayout>

<style>
  .container {
    max-width: 1200px;
  }
</style>
