---
import AdminSidebarLayout from '../../../../../layouts/AdminSidebarLayout.astro';
import { actions } from 'astro:actions';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/dashboard');
}

// Obtener torneo
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const torneoResponse = await fetch(
  `${supabaseUrl}/rest/v1/torneos?id=eq.${id}&select=*`,
  {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${supabaseAnonKey}`,
    }
  }
);

const torneos = await torneoResponse.json();
const torneo = torneos[0];

if (!torneo) {
  return Astro.redirect('/admin/dashboard');
}

// Obtener el siguiente número de jornada
const jornadasResponse = await fetch(
  `${supabaseUrl}/rest/v1/jornadas?torneo_id=eq.${id}&select=numero_jornada&order=numero_jornada.desc&limit=1`,
  {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${supabaseAnonKey}`,
    }
  }
);

const jornadas = await jornadasResponse.json();
const siguienteNumero = jornadas.length > 0 ? jornadas[0].numero_jornada + 1 : 1;
---

<AdminSidebarLayout title={`Crear Jornada - ${torneo.nombre}`}>
  <main class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="mb-6">
      <a href={`/admin/torneo/${id}/jornadas`} class="text-blue-600 hover:underline">← Volver a Jornadas</a>
      <h1 class="text-3xl font-bold mt-4">Crear Jornada Manual</h1>
      <p class="text-gray-600">{torneo.nombre}</p>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <form id="create-jornada-manual-form" class="space-y-4">
        <input type="hidden" name="torneo_id" value={id} />

        <div>
          <label for="numero_jornada" class="block text-sm font-medium text-gray-700 mb-2">
            Número de Jornada *
          </label>
          <input
            type="number"
            id="numero_jornada"
            name="numero_jornada"
            value={siguienteNumero}
            min="1"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p class="text-sm text-gray-500 mt-1">
            Última jornada creada: {jornadas.length > 0 ? jornadas[0].numero_jornada : 'Ninguna'}
          </p>
        </div>

        <div>
          <label for="nombre_fase" class="block text-sm font-medium text-gray-700 mb-2">
            Nombre/Fase (opcional)
          </label>
          <input
            type="text"
            id="nombre_fase"
            name="nombre_fase"
            placeholder="Ej: Jornada 1, Cuartos de Final, etc."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p class="text-sm text-gray-500 mt-1">
            Si se deja vacío, se usará "Jornada {siguienteNumero}"
          </p>
        </div>

        <div class="flex gap-4 pt-4">
          <button
            type="submit"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-medium"
          >
            Crear Jornada
          </button>
          <a
            href={`/admin/torneo/${id}/jornadas`}
            class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition font-medium"
          >
            Cancelar
          </a>
        </div>
      </form>
    </div>

    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-sm text-blue-800">
        <strong>Nota:</strong> Después de crear la jornada, podrás agregar partidos manualmente.
      </p>
    </div>
  </main>
</AdminSidebarLayout>

<script>
  import { actions } from 'astro:actions';

  // Manejar respuesta de la action
  const form = document.getElementById('create-jornada-manual-form') as HTMLFormElement;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    try {
      const { data, error } = await actions.createJornada(formData);
      
      if (error) {
        if (typeof window.showToast === 'function') {
            window.showToast(`Error: ${error.message}`, 'error');
        } else {
            console.error(error.message);
        }
      } else if (data?.success) {
        const torneoId = formData.get('torneo_id');
        if (typeof window.showToast === 'function') {
            window.showToast('Jornada creada exitosamente', 'success');
        }
        setTimeout(() => {
             window.location.href = `/admin/torneo/${torneoId}/jornadas`;
        }, 1000);
      }
    } catch (err) {
      console.error(err);
      if (typeof window.showToast === 'function') {
         window.showToast('Error al crear jornada', 'error');
      }
    }
  });
</script>
