---
import AdminSidebarLayout from '../../../layouts/AdminSidebarLayout.astro';
import SmartImage from '../../../components/SmartImage.astro';
import StandingsTable from '../../../components/StandingsTable.astro';
import MatchEventsManager from '../../../components/MatchEventsManager.tsx';
import DeleteCascadeManager from '../../../components/DeleteCascadeManager.tsx';
import ConfirmationModal from '../../../components/ConfirmationModal.astro';
import LeagueFixtureModal from '../../../components/LeagueFixtureModal.astro';
import GroupsFixtureModal from '../../../components/GroupsFixtureModal.astro';
import { supabase } from '../../../lib/supabase';
import { calculateStandings, type StandingRow } from '../../../lib/standings';

const { id } = Astro.params;
const tab = Astro.url.searchParams.get('tab') || 'dashboard';

// Create Admin Client for RLS Bypass
import { createClient } from '@supabase/supabase-js';
import type { Database } from '../../../lib/database.types';

const supabaseAdmin = createClient<Database>(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY
);

if (!id) return Astro.redirect('/admin/dashboard');

// Interfaces
interface Torneo {
  id: string;
  nombre: string;
  descripcion: string | null;
  imagen_portada: string | null;
  logo_url: string | null;
  fecha_inicio: string;
  fecha_fin?: string | null;
  estado: string;
  tipo: 'liga' | 'eliminacion_simple' | 'grupos_eliminacion';
  config: {
    double_round?: boolean;
    use_seeding?: boolean;
    num_grupos?: number;
    clasificados_por_grupo?: number;
    playoff_config?: {
      usa_ida_vuelta?: boolean;
      fases_ida_vuelta?: string[];
      final_ida_vuelta?: boolean;
      usa_gol_visitante?: boolean;
      penales_si_empate_agregado?: boolean;
    };
  } | null;
}

interface Equipo {
  id: string;
  nombre: string;
  logo_url: string | null;
  creado_at: string;
}

interface Jornada {
  id: string;
  numero_jornada: number;
  nombre_fase: string | null;
  torneo_id: string;
  fecha_inicio?: string;
  fecha_fin?: string;
}

interface Partido {
  id: string;
  equipo_local_id: string | null;
  equipo_visitante_id: string | null;
  puntos_local: number | null;
  puntos_visitante: number | null;
  estado_partido: 'pendiente' | 'en_curso' | 'finalizado';
  fecha_partido: string | null;
  jornada_id: string;
  local?: Equipo;
  visitante?: Equipo;
  jornada?: Jornada;
  goles_local_tiempo_extra?: number | null;
  goles_visitante_tiempo_extra?: number | null;
  penales_jugados?: boolean;
  penales_local?: number | null;
  penales_visitante?: number | null;
  es_partido_vuelta?: boolean;
  marcador_agregado_local?: number | null;
  marcador_agregado_visitante?: number | null;
  ganador_agregado_id?: string | null;
}

interface Noticia {
  id: string;
  titulo: string;
  contenido: string | null;
  imagen_url: string | null;
  created_at: string;
}

// 1. Fetch Tournament
const { data: torneoRaw, error: tError } = await supabaseAdmin
  .from('torneos')
  .select('*')
  .eq('id', id)
  .single();

if (tError || !torneoRaw) return Astro.redirect('/admin/dashboard');

const torneo = torneoRaw as Torneo;

// 2. Fetch Helper Data (Jornadas, Teams)
const { data: jornadasRaw } = await supabaseAdmin
  .from('jornadas')
  .select('*')
  .eq('torneo_id', id)
  .order('numero_jornada', { ascending: true });

const jornadas = (jornadasRaw || []) as Jornada[];

const { data: participantesRaw } = await supabaseAdmin
  .from('torneo_participantes')
  .select(`
    equipo_id,
    grupo,
    equipo:equipos!torneo_participantes_equipo_id_fkey (
      id,
      nombre,
      logo_url,
      creado_at
    )
  `)
  .eq('torneo_id', id);

const equipos = (participantesRaw?.map((p: any) => p.equipo).filter(Boolean) || []).sort((a: any, b: any) => a.nombre.localeCompare(b.nombre)) as Equipo[];

// Moved group logic down
const { data: allTeamsRaw } = await supabaseAdmin
  .from('equipos')
  .select('id, nombre, logo_url')
  .order('nombre');

const allTeams = (allTeamsRaw || []) as Equipo[];

// 3. Fetch Matches
const jornadaIds = jornadas.map(j => j.id);
let matches: Partido[] = [];

console.log('üîç [AdminDebug] Jornadas found:', jornadas.length);
if (jornadas.length > 0) {
    console.log('üîç [AdminDebug] Jornada IDs:', jornadaIds);
}

if (jornadaIds.length > 0) {
    const { data: m, error: mError } = await supabaseAdmin
        .from('partidos')
        .select(`
            *,
            local:equipos!partidos_equipo_local_id_fkey(id, nombre, logo_url),
            visitante:equipos!partidos_equipo_visitante_id_fkey(id, nombre, logo_url)
        `)
        .in('jornada_id', jornadaIds)
        .order('fecha_partido', { ascending: false });
    
    if (mError) {
        console.error('üî¥ [AdminDebug] Error fetching matches:', mError);
    } else {
        console.log('üîç [AdminDebug] Matches found:', m?.length);
        if (m && m.length > 0) {
           console.log('üîç [AdminDebug] First match sample:', JSON.stringify(m[0], null, 2));
           console.log('üîç [AdminDebug] Aggregate fields present?', 'marcador_agregado_local' in m[0]);
           const returnMatches = m.filter((x: any) => x.es_partido_vuelta);
           console.log('üîç [AdminDebug] Return matches count:', returnMatches.length);
           if (returnMatches.length > 0) {
               console.log('üîç [AdminDebug] First return match:', JSON.stringify(returnMatches[0], null, 2));
           }
        }
    }
    matches = (m || []) as Partido[];
} else {
    console.log('‚ö†Ô∏è [AdminDebug] No jornadas found, skipping match fetch');
}

// Group assignments for grupos_eliminacion tournaments
const groupAssignments = new Map<string, string[]>();
const teamGroupMap = new Map<string, string>(); // Reverse map for O(1) lookup

if (torneo.tipo === 'grupos_eliminacion' && participantesRaw) {
  participantesRaw.forEach((p: any) => {
    if (p.grupo) {
      if (!groupAssignments.has(p.grupo)) groupAssignments.set(p.grupo, []);
      groupAssignments.get(p.grupo)!.push(p.equipo_id);
      teamGroupMap.set(p.equipo_id, p.grupo);
    }
  });
}
const sortedGroupNames = Array.from(groupAssignments.keys()).sort();

// Calculate per-group standings
const groupStandings = new Map<string, StandingRow[]>();
if (torneo.tipo === 'grupos_eliminacion' && sortedGroupNames.length > 0) {
  const groupPhaseMatches = matches.filter((m: Partido) => !(m as any).ronda);
  for (const groupName of sortedGroupNames) {
    const groupTeamIds = groupAssignments.get(groupName) || [];
    const groupEquipos = equipos.filter(e => groupTeamIds.includes(e.id));
    const groupMatches = groupPhaseMatches.filter((m: Partido) =>
      m.equipo_local_id && m.equipo_visitante_id &&
      groupTeamIds.includes(m.equipo_local_id) &&
      groupTeamIds.includes(m.equipo_visitante_id)
    );
    groupStandings.set(groupName, calculateStandings(groupEquipos, groupMatches));
  }
}

// Check if all group phase matches are finalized (for playoff generation)
const allGroupMatchesFinalized = torneo.tipo === 'grupos_eliminacion' && matches.length > 0 &&
  matches.filter((m: Partido) => !(m as any).ronda).every((m: Partido) => m.estado_partido === 'finalizado');
const hasPlayoffMatches = matches.some((m: any) => m.ronda);

// 4. Fetch Match Events
const matchIds = matches.map(m => m.id);
let allEvents: any[] = [];

if (matchIds.length > 0) {
    // Use Admin Client
    const { data: eventsRaw } = await supabaseAdmin
        .from('eventos_partido')
        .select('*')
        .in('partido_id', matchIds)
        .order('minuto', { ascending: true });
    
    allEvents = eventsRaw || [];
}

// 5. Fetch Players from all teams in tournament
const equipoIds = equipos.map(e => e.id);
let allPlayers: any[] = [];

if (equipoIds.length > 0) {
    // Use Admin Client
    const { data: playersRaw } = await supabaseAdmin
        .from('equipo_deportistas')
        .select(`
            equipo_id,
            dorsal,
            deportista:deportista_cedula (
                numero_cedula,
                nombre
            )
        `)
        .in('equipo_id', equipoIds);
    
    allPlayers = (playersRaw || []).map((p: any) => ({
        numero_cedula: p.deportista.numero_cedula,
        nombre: p.deportista.nombre,
        dorsal: p.dorsal,
        equipo_id: p.equipo_id
    }));
}

// 6. Fetch News
const { data: noticiasRaw } = await supabase
    .from('noticias')
    .select('*')
    .eq('torneo_id', id)
    .order('created_at', { ascending: false });

const noticias = (noticiasRaw || []) as Noticia[];

// 7. Calculate Standings
const standings = calculateStandings(equipos, matches);

---

<AdminSidebarLayout title={`Admin: ${torneo.nombre}`}>
  <div class="space-y-8 pb-20">
    
    <!-- Header -->
    <div class="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-6">
            <div class="w-20 h-20 rounded-2xl bg-slate-900 shadow-lg flex-shrink-0">
                <SmartImage 
                    entityId={torneo.id} 
                    entityType="tournament" 
                    currentImage={torneo.logo_url} 
                    fallbackInitial={torneo.nombre[0]}
                    bucket="logos" 
                    className="w-full h-full rounded-2xl"
                />
            </div>
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <span class={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${torneo.estado === 'activo' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>
                        {torneo.estado}
                    </span>
                    <span class="text-slate-400 text-xs font-bold uppercase">{Array.isArray(equipos) ? equipos.length : 0} Equipos</span>
                </div>
                <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter margin-0 leading-none">{torneo.nombre}</h1>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('edit-tournament-modal').showModal()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-xs font-black uppercase tracking-widest transition-all">
                Configuraci√≥n
            </button>
            <a href={`/torneo/${id}`} target="_blank" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 transition-all">
                Ver P√∫blico
            </a>
            <button onclick={`deleteItem('Tournament', '${id}')`} class="px-3 py-3 bg-red-50 hover:bg-red-100 text-red-500 border border-red-100 hover:border-red-200 rounded-xl transition-all" title="Eliminar Torneo">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-slate-200">
        <nav class="flex space-x-8 -mb-px overflow-x-auto">
            <a href="?tab=dashboard" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'dashboard' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Dashboard
            </a>
            <a href="?tab=jornadas" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'jornadas' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Jornadas y Partidos
            </a>
            <a href="?tab=equipos" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'equipos' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Equipos
            </a>
            <a href="?tab=noticias" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'noticias' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Noticias
            </a>
        </nav>
    </div>

    <!-- DASHBOARD TAB -->
    {tab === 'dashboard' && (
        <div class="space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300">

            {/* Groups Standings (for grupos_eliminacion) */}
            {torneo.tipo === 'grupos_eliminacion' && sortedGroupNames.length > 0 && (
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Fase de Grupos</h3>
                        {allGroupMatchesFinalized && !hasPlayoffMatches && (
                            <button
                                id="generate-playoff-btn"
                                data-id={id}
                                class="px-5 py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-orange-500/30 hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                Generar Playoff
                            </button>
                        )}
                        {hasPlayoffMatches && (
                            <span class="px-4 py-2 bg-green-50 text-green-600 border border-green-200 rounded-xl text-[10px] font-black uppercase tracking-widest">‚úÖ Playoff Generado</span>
                        )}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {sortedGroupNames.map(groupName => {
                            const gStandings = groupStandings.get(groupName) || [];
                            const clasificados = torneo.config?.clasificados_por_grupo || 2;
                            return (
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <span class="w-8 h-8 bg-emerald-600 text-white rounded-lg flex items-center justify-center font-black text-sm">{groupName}</span>
                                        <span class="text-sm font-black text-slate-700 uppercase tracking-wider">Grupo {groupName}</span>
                                    </div>
                                    <StandingsTable standings={gStandings} highlightTop={clasificados} />
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* General standings (for liga or as fallback) */}
                {(torneo.tipo !== 'grupos_eliminacion' || sortedGroupNames.length === 0) && (
                    <div class="space-y-4">
                        <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Tabla General</h3>
                        <StandingsTable standings={standings} />
                    </div>
                )}

                <!-- Matches Section -->
                <div class="space-y-6">
                    <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">√öltimos Resultados</h3>
                    <div class="space-y-3">
                        {matches.slice(0, 5).map((match: Partido) => (
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                                <div class="flex items-center gap-4 text-xs font-bold text-slate-600">
                                    <span class="bg-slate-100 px-2 py-1 rounded text-[9px] uppercase tracking-widest">{match.jornada?.nombre_fase || 'Jornada ' + match.jornada?.numero_jornada}</span>
                                    <span>{match.local?.nombre}</span>
                                    <span class="font-black text-slate-900">{match.puntos_local ?? '-'}</span>
                                    <span class="text-slate-300">vs</span>
                                    <span class="font-black text-slate-900">{match.puntos_visitante ?? '-'}</span>
                                    <span>{match.visitante?.nombre}</span>
                                </div>
                            </div>
                        ))}
                         {matches.length === 0 && <p class="text-slate-400 text-sm">No hay partidos registrados.</p>}
                    </div>
                </div>
            </div>
        </div>
    )}

    <!-- JORNADAS TAB -->
    {tab === 'jornadas' && (

        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
             <div class="flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Gesti√≥n de Partidos</h3>
                <div class="flex gap-2">
                    {jornadas.length === 0 ? (
                        <button 
                            id="generate-fixture-btn" 
                            data-id={id}
                            data-tipo={torneo.tipo}
                            data-nombre={torneo.nombre}
                            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/30 hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            Generar Fixture Autom√°tico
                        </button>
                    ) : (
                        <button 
                            id="delete-all-jornadas-btn"
                            data-id={id}
                            class="px-4 py-2 bg-white border border-red-200 hover:border-red-500 hover:bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                        >
                            üóëÔ∏è Eliminar Todas
                        </button>
                    )}

                    {torneo.tipo === 'grupos_eliminacion' && jornadas.length > 0 && (
                        <button 
                            id="generate-playoff-btn"
                            data-id={id}
                            data-nombre={torneo.nombre}
                            class="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-orange-500/30 hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                            Generar Playoff
                        </button>
                    )}
                    <button onclick="document.getElementById('new-jornada-modal').showModal()" class="px-4 py-2 bg-white border border-slate-200 hover:border-blue-500 text-slate-600 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                        + Nueva Jornada
                    </button>
                    <button onclick="document.getElementById('new-match-modal').showModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all">
                        + Programar Partido
                    </button>
                </div>
             </div>

            {jornadas && jornadas.length > 0 ? (
                <div class="space-y-6">
                    {/* Group Filter Tabs (Only for group tournaments) */}
                    {sortedGroupNames.length > 0 && (
                         <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-2 flex flex-wrap gap-2">
                            <button 
                                class="group-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all bg-slate-900 text-white shadow-lg"
                                data-group="all"
                            >
                                Todos
                            </button>
                            {sortedGroupNames.map(group => (
                                <button 
                                    class="group-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all bg-slate-50 text-slate-400 hover:bg-slate-100"
                                    data-group={group}
                                >
                                    Grupo {group}
                                </button>
                            ))}
                         </div>
                    )}

                    <!-- Horizontal Scroll Navigation -->
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-2 sticky top-4 z-20">
                         <div class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide" id="jornadas-nav">
                            {jornadas.map((jornada, index) => (
                                <button 
                                    data-target={`jornada-${jornada.id}`}
                                    class={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all whitespace-nowrap jornada-tab-btn ${index === 0 ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                                >
                                    Jornada {jornada.numero_jornada}
                                </button>
                            ))}
                         </div>
                    </div>

                    <!-- Match Containers -->
                    <div class="space-y-4 min-h-[400px]">
                        {jornadas.map((jornada, index) => (
                            <div id={`jornada-${jornada.id}`} class={`jornada-container bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden animate-in fade-in duration-300 ${index !== 0 ? 'hidden' : ''}`}>
                                <div class="bg-slate-50/50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                                    <h4 class="font-black text-slate-600 uppercase tracking-widest text-xs flex items-center gap-2">
                                        <span class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded text-[10px]">J{jornada.numero_jornada}</span>
                                        {jornada.nombre_fase || 'Fase Regular'}
                                        <span class="text-slate-300 font-normal mx-2">|</span>
                                        <span class="text-slate-400 font-normal">
                                            {jornada.fecha_inicio ? new Date(jornada.fecha_inicio).toLocaleDateString(undefined, { timeZone: 'UTC' }) : 'Sin fecha'} - {jornada.fecha_fin ? new Date(jornada.fecha_fin).toLocaleDateString(undefined, { timeZone: 'UTC' }) : 'Sin fecha'}
                                        </span>
                                    </h4>
                                    <div class="flex items-center gap-2">
                                        <button 
                                            onclick={`openEditJornadaModal('${jornada.id}', ${jornada.numero_jornada}, '${jornada.nombre_fase || ''}', '${jornada.fecha_inicio || ''}', '${jornada.fecha_fin || ''}')`}
                                            class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-200 transition-colors"
                                            title="Editar jornada"
                                        >
                                            ‚úèÔ∏è Editar
                                        </button>
                                            <button 
                                                class="delete-btn-trigger px-3 py-1.5 text-red-500 hover:bg-red-50 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors"
                                                title="Eliminar jornada"
                                                data-delete-type="Jornada"
                                                data-delete-id={jornada.id}
                                            >
                                                üóëÔ∏è
                                            </button>
                                    </div>
                                </div>
                                <div class="divide-y divide-slate-50">
                                    {matches.filter((m: Partido) => m.jornada_id === jornada.id).length > 0 ? 
                                        matches.filter((m: Partido) => m.jornada_id === jornada.id).map((match: Partido) => {
                                            const localGroup = teamGroupMap.get(match.equipo_local_id || '') || '';
                                            const visitorGroup = teamGroupMap.get(match.equipo_visitante_id || '') || '';
                                            return (
                                            <div 
                                                class="match-card p-4 flex items-center justify-between hover:bg-blue-50/20 transition-colors group"
                                                data-group-local={localGroup}
                                                data-group-visitor={visitorGroup}
                                            >
                                                <div class="flex items-center gap-4 w-full md:w-2/3">
                                                    <div class="text-center w-14 flex-shrink-0 flex flex-col items-center gap-1">
                                                        {match.fecha_partido ? (
                                                            <>
                                                                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{new Date(match.fecha_partido).toLocaleDateString(undefined, {weekday: 'short'})}</div>
                                                                <div class="text-lg font-black text-slate-900 leading-none">{new Date(match.fecha_partido).getDate()}</div>
                                                                <div class="text-[9px] font-bold text-slate-400 uppercase">{new Date(match.fecha_partido).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                            </>
                                                        ) : (
                                                            <div class="text-[10px] font-black text-slate-300 uppercase tracking-widest leading-tight">Por<br/>Definir</div>
                                                        )}
                                                        {/* Badge always shows if finalizado, regardless of fecha */}
                                                        {match.estado_partido === 'finalizado' && (
                                                            <span class="bg-green-500 text-white text-[8px] font-black uppercase px-2 py-1 rounded-full shadow-sm mt-1">
                                                                ‚úì Final
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    <div class="flex flex-col gap-2 w-full">
                                                        <!-- Local -->
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex items-center gap-3">
                                                                <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center p-0.5">
                                                                     {match.local?.logo_url ? <img src={match.local.logo_url} class="w-full h-full object-contain" /> : <span class="text-[10px] font-black text-slate-300">{match.local?.nombre[0]}</span>}
                                                                </div>
                                                                <span class={`font-bold text-sm ${(match.puntos_local ?? -1) > (match.puntos_visitante ?? -1) ? 'text-slate-900' : 'text-slate-600'}`}>{match.local?.nombre}</span>
                                                            </div>
                                                            <div class="flex flex-col items-end">
                                                                <span class="font-black text-slate-900 text-lg">{match.puntos_local ?? '-'}</span>
                                                                {match.penales_jugados && match.penales_local !== null && (
                                                                    <span class="text-[9px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded border border-green-100 mt-1">
                                                                        ({match.penales_local})
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <!-- Visitante -->
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex items-center gap-3">
                                                                 <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center p-0.5">
                                                                     {match.visitante?.logo_url ? <img src={match.visitante.logo_url} class="w-full h-full object-contain" /> : <span class="text-[10px] font-black text-slate-300">{match.visitante?.nombre[0]}</span>}
                                                                </div>
                                                                <span class={`font-bold text-sm ${(match.puntos_visitante ?? -1) > (match.puntos_local ?? -1) ? 'text-slate-900' : 'text-slate-600'}`}>{match.visitante?.nombre}</span>
                                                            </div>
                                                            <div class="flex flex-col items-end">
                                                                <span class="font-black text-slate-900 text-lg">{match.puntos_visitante ?? '-'}</span>
                                                                {match.penales_jugados && match.penales_visitante !== null && (
                                                                    <span class="text-[9px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded border border-green-100 mt-1">
                                                                        ({match.penales_visitante})
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="hidden md:flex flex-col items-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    {torneo.estado === 'finalizado' ? (
                                                        <div class="px-3 py-1.5 bg-slate-50 text-slate-400 rounded-lg text-[10px] font-black uppercase tracking-widest w-full text-center flex items-center justify-center gap-1">
                                                            üîí Torneo Finalizado
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <button onclick={`openEditMatchModal('${match.id}', '${match.equipo_local_id}', '${match.equipo_visitante_id}', '${match.fecha_partido || ''}')`} class="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 w-full text-center">
                                                                ‚öôÔ∏è Editar Partido
                                                            </button>
                                                            <button onclick={`openMatchManager('${match.id}')`} class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-200 w-full text-center">
                                                                üìä Goles y Eventos
                                                            </button>
                                                            <button 
                                                                class="delete-btn-trigger px-3 py-1.5 text-red-500 hover:bg-red-50 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors w-full text-center"
                                                                data-delete-type="Match"
                                                                data-delete-id={match.id}
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                                
                                                {match.es_partido_vuelta && match.marcador_agregado_local !== null && match.marcador_agregado_visitante !== null && (
                                                    <div class="mt-3 pt-2 border-t border-slate-100 flex justify-center">
                                                        <span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-widest border border-slate-200">
                                                            Global: {match.marcador_agregado_local} - {match.marcador_agregado_visitante}
                                                            {match.ganador_agregado_id === null && match.estado_partido === 'finalizado' && (
                                                                <span class="text-amber-600 ml-1">(Empate)</span>
                                                            )}
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                        }) : (
                                        <div class="py-12 flex flex-col items-center justify-center text-center">
                                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
                                                <svg class="w-8 h-8 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                            </div>
                                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">No hay partidos en esta jornada</p>
                                            <button onclick="document.getElementById('new-match-modal').showModal()" class="text-blue-600 font-black uppercase text-[10px] tracking-widest hover:underline">+ Programar Partido</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
             ) : (
                <div class="py-20 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                    <p class="text-slate-400 font-bold mb-4">No hay jornadas creadas</p>
                    <button onclick="document.getElementById('new-jornada-modal').showModal()" class="text-blue-600 font-black uppercase text-xs tracking-widest hover:underline">Crear Primera Jornada</button>
                </div>
             )}
        </div>
    )}

    <!-- EQUIPOS TAB -->
    {tab === 'equipos' && (
        <div class="animate-in fade-in slide-in-from-bottom-2 duration-300 space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Equipos Inscritos</h3>
                {(torneo.tipo === 'eliminacion_simple' || torneo.tipo === 'grupos_eliminacion') && torneo.estado !== 'pendiente' ? (
                    <div class="px-4 py-2 bg-slate-100 text-slate-400 rounded-xl text-[10px] font-black uppercase tracking-widest cursor-not-allowed flex items-center gap-2 border border-slate-200" title="El torneo ya ha comenzado">
                        üîí Inscripci√≥n Cerrada
                    </div>
                ) : (
                    <button onclick="document.getElementById('new-team-modal').showModal()" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-slate-800 transition-all">
                        + Inscribir Equipo
                    </button>
                )}
            </div>
            
            <div class="overflow-x-auto bg-white rounded-2xl border border-slate-100 shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Equipo</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Fecha Registro</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {equipos?.map((equipo: Equipo) => (
                            <tr class="hover:bg-blue-50/50 transition-colors group">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center font-black text-slate-400 text-sm overflow-hidden flex-shrink-0">
                                            {equipo.logo_url ? (
                                                <img src={equipo.logo_url} class="w-full h-full object-cover" alt={equipo.nombre} />
                                            ) : (
                                                equipo.nombre.substring(0, 2).toUpperCase()
                                            )}
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-900 group-hover:text-blue-600 transition-colors">{equipo.nombre}</h4>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ID: {equipo.id.split('-')[0]}...</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex flex-col">
                                        <span class="font-bold text-slate-700 text-sm">{new Date(equipo.creado_at).toLocaleDateString()}</span>
                                        <span class="text-[10px] text-slate-400 font-bold">{new Date(equipo.creado_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <a 
                                            href={`/admin/equipos/${equipo.id}?torneoId=${id}`} 
                                            class="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all flex items-center gap-2"
                                        >
                                            Gestionar
                                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                        </a>
                                        {(torneo.tipo === 'eliminacion_simple' || torneo.tipo === 'grupos_eliminacion') && torneo.estado !== 'pendiente' ? (
                                            <button 
                                                disabled 
                                                class="p-2 bg-slate-50 border border-slate-100 text-slate-300 rounded-lg cursor-not-allowed"
                                                title="Desinscripci√≥n no permitida en torneos iniciados"
                                            >
                                                 üîí
                                            </button>
                                        ) : (
                                            <button 
                                                class="delete-btn-trigger p-2 bg-white border border-slate-200 text-slate-400 rounded-lg hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all"
                                                title="Desinscribir del torneo"
                                                data-delete-type="TeamParticipation"
                                                data-delete-id={equipo.id}
                                            >
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                        {(!equipos || equipos.length === 0) && (
                             <tr>
                                <td colspan="3" class="px-6 py-12 text-center bg-slate-50/50 border-2 border-dashed border-slate-200 rounded-b-2xl">
                                    <p class="text-slate-400 font-bold mb-2">No hay equipos inscritos</p>
                                    {(torneo.tipo === 'eliminacion_simple' || torneo.tipo === 'grupos_eliminacion') && torneo.estado !== 'pendiente' ? (
                                         <p class="text-xs text-amber-600 bg-amber-50 border border-amber-200 rounded-lg p-2 mt-2 inline-block font-bold">
                                            üîí Inscripci√≥n Cerrada (Torneo Iniciado)
                                        </p>
                                    ) : (
                                        <button onclick="document.getElementById('new-team-modal').showModal()" class="text-blue-600 font-black uppercase text-xs tracking-widest hover:underline">Inscribir Primer Equipo</button>
                                    )}
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    )}

    <!-- NOTICIAS TAB -->
    {tab === 'noticias' && (
        <div class="animate-in fade-in slide-in-from-bottom-2 duration-300 space-y-6">
             <div class="flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Noticias y Anuncios</h3>
                <button onclick="document.getElementById('new-news-modal').showModal()" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-slate-800 transition-all">
                    + Nueva Noticia
                </button>
            </div>
             <div class="grid grid-cols-1 gap-4">
                {noticias?.map((noticia: Noticia) => (
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex gap-6 group hover:border-blue-200 transition-all relative">
                         {noticia.imagen_url && (
                            <div class="w-32 h-24 rounded-2xl bg-slate-100 overflow-hidden flex-shrink-0">
                                <img src={noticia.imagen_url} class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                            </div>
                        )}
                        <div class="flex-1">
                             <div class="flex justify-between items-start">
                                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-lg text-[10px] uppercase font-black tracking-widest mb-2 inline-block">
                                    {new Date(noticia.created_at).toLocaleDateString()}
                                </span>
                                <button 
                                    class="delete-btn-trigger text-slate-300 hover:text-red-500 transition-colors p-1"
                                    data-delete-type="News"
                                    data-delete-id={noticia.id}
                                >
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                             </div>
                            <h4 class="font-bold text-lg text-slate-900 leading-tight mb-2">{noticia.titulo}</h4>
                            <p class="text-sm text-slate-500 line-clamp-2">{noticia.contenido}</p>
                        </div>
                    </div>
                ))}
                 {(!noticias || noticias.length === 0) && (
                    <div class="py-20 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                        <p class="text-slate-400 font-bold mb-4">No hay noticias publicadas</p>
                        <button onclick="document.getElementById('new-news-modal').showModal()" class="text-blue-600 font-black uppercase text-xs tracking-widest hover:underline">Crear Primera Noticia</button>
                    </div>
                )}
             </div>
        </div>
    )}

    <!-- ... MODALS ... -->
    <!-- (No changes to modals html, jumping to script where deleteItem is defined) -->
    <!-- I will use a separate replace_file_content for script updates to avoid huge context -->
<script>
// ...
</script>

    <!-- MODALS -->

    <!-- 1. Edit Tournament -->
    <dialog id="edit-tournament-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-lg relative animate-in fade-in zoom-in duration-200 backdrop:bg-slate-900/60 focus:outline-none overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title-edit" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-edit" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Configurar Torneo</h3>
        
        <div class="h-full max-h-[70vh] overflow-y-auto pr-2 pb-6 custom-scrollbar">
            <form id="edit-tournament-form" class="space-y-4">
            <input type="hidden" name="id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Nombre</label>
                <input type="text" name="nombre" value={torneo.nombre} required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Descripci√≥n</label>
                <textarea name="descripcion" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-medium text-slate-600 h-24">{torneo.descripcion}</textarea>
            </div>
            
             <div class="grid grid-cols-2 gap-4">
                 <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Inicio</label>
                    <input 
                        type="date" 
                        name="fecha_inicio" 
                        class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900"
                        value={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().split('T')[0] : ''} 
                    />
                 </div>
                 <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Fin</label>
                    <input 
                        type="date" 
                        name="fecha_fin" 
                        class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                        value={torneo.fecha_fin ? new Date(torneo.fecha_fin).toISOString().split('T')[0] : ''}
                    />
                 </div>
             </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Estado</label>
                    <select name="estado" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900">
                        <option value="pendiente" selected={torneo.estado === 'pendiente'}>Pendiente (Borrador)</option>
                        <option value="activo" selected={torneo.estado === 'activo'}>Activo</option>
                        <option value="finalizado" selected={torneo.estado === 'finalizado'}>Finalizado</option>
                    </select>
                </div>
            </div>

            <!-- Playoff Configuration (Only for Grupos + Playoff) -->
            {torneo.tipo === 'grupos_eliminacion' && (
                <div id="edit-playoff-config-section" class="border-t-2 border-slate-100 pt-6 space-y-4">
                    <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Configuraci√≥n de Playoffs</h4>
                    
                    <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl">
                        <input 
                            type="checkbox" 
                            name="usa_ida_vuelta" 
                            id="edit-usa-ida-vuelta-checkbox"
                            class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                            checked={torneo.config?.playoff_config?.usa_ida_vuelta}
                        />
                        <label for="edit-usa-ida-vuelta-checkbox" class="text-xs font-bold text-slate-700 uppercase tracking-wide cursor-pointer select-none">
                            Habilitar Partidos Ida y Vuelta
                        </label>
                    </div>

                    <div id="edit-phases-selection" class={`space-y-3 pl-2 ${torneo.config?.playoff_config?.usa_ida_vuelta ? '' : 'hidden'}`}>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2">Seleccionar Fases con Ida y Vuelta</p>
                        
                        <div class="grid grid-cols-1 gap-2">
                            <label class="flex items-center gap-3 bg-white border border-slate-100 p-3 rounded-lg hover:bg-slate-50 transition-colors cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="fase_cuartos" 
                                    value="quarterfinals" 
                                    class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                                    checked={torneo.config?.playoff_config?.fases_ida_vuelta?.includes('quarterfinals')}
                                />
                                <span class="text-xs font-bold text-slate-600 uppercase">Cuartos de Final</span>
                            </label>

                            <label class="flex items-center gap-3 bg-white border border-slate-100 p-3 rounded-lg hover:bg-slate-50 transition-colors cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="fase_semis" 
                                    value="semifinals" 
                                    class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                                    checked={torneo.config?.playoff_config?.fases_ida_vuelta?.includes('semifinals')}
                                />
                                <span class="text-xs font-bold text-slate-600 uppercase">Semifinales</span>
                            </label>

                            <label class="flex items-center gap-3 bg-white border border-slate-100 p-3 rounded-lg hover:bg-slate-50 transition-colors cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="fase_final" 
                                    value="final" 
                                    class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                                    checked={torneo.config?.playoff_config?.final_ida_vuelta}
                                />
                                <span class="text-xs font-bold text-slate-600 uppercase">Final (Ida y Vuelta)</span>
                            </label>
                        </div>

                         <div class="space-y-2 mt-4 pt-4 border-t border-slate-100">
                             <div class="flex items-center gap-3">
                                <input 
                                    type="checkbox" 
                                    name="usa_gol_visitante" 
                                    id="edit-gol-visitante"
                                    class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                                    checked={torneo.config?.playoff_config?.usa_gol_visitante}
                                />
                                <label for="edit-gol-visitante" class="text-[10px] font-bold text-slate-600 uppercase cursor-pointer select-none">
                                    Gol de Visitante vale doble en empate
                                </label>
                            </div>

                            <div class="flex items-center gap-3">
                                <input 
                                    type="checkbox" 
                                    name="penales_si_empate" 
                                    id="edit-penales-empate"
                                    class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                                    checked={torneo.config?.playoff_config?.penales_si_empate_agregado}
                                />
                                <label for="edit-penales-empate" class="text-[10px] font-bold text-slate-600 uppercase cursor-pointer select-none">
                                    Penales si hay empate global
                                </label>
                            </div>
                         </div>
                    </div>
                </div>
            )}
            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all mt-4">Guardar Cambios</button>
        </form>
        </div>
    </dialog>

    <!-- 2. New Jornada -->
    <!-- 2. New Jornada -->
    <dialog id="new-jornada-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative animate-in fade-in zoom-in duration-200 backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-jornada" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-jornada" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Nueva Jornada</h3>
        
        <!-- Error Display (In-Modal) -->
        <div id="create-jornada-error" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-2xl animate-in fade-in slide-in-from-top-2 duration-200">
            <p class="text-red-800 font-bold text-sm"></p>
        </div>
        
        <form id="create-jornada-form" class="space-y-4">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">N√∫mero Jornada</label>
                <input type="number" name="numero_jornada" required min="1" value={(jornadas?.length || 0) + 1} class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-black text-xl text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Inicio</label>
                <input 
                    type="date" 
                    name="fecha_inicio" 
                    required 
                    min={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().split('T')[0] : undefined}
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Fin</label>
                <input 
                    type="date" 
                    name="fecha_fin" 
                    required 
                    min={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().split('T')[0] : undefined}
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fase (Opcional)</label>
                <input type="text" name="nombre" placeholder="Ej: Fase de Grupos" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all mt-4">Crear Jornada</button>
        </form>
    </dialog>

    <!-- 3. New Match -->
    <!-- 3. New Match -->
    <dialog id="new-match-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative animate-in fade-in zoom-in duration-200 backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-match" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-match" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Programar Partido</h3>
        
        <!-- Error Display (In-Modal) -->
        <div id="create-match-error" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-2xl animate-in fade-in slide-in-from-top-2 duration-200">
            <p class="text-red-800 font-bold text-sm"></p>
        </div>
        
        <form id="create-match-form" class="space-y-4">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Jornada</label>
                <select name="jornada_id" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900">
                    {jornadas?.map(j => <option value={j.id}>Jornada {j.numero_jornada} - {j.nombre_fase}</option>)}
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha y Hora del Partido</label>
                <input 
                    type="datetime-local" 
                    name="fecha_partido" 
                    required 
                    min={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().slice(0, 16) : undefined}
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Local</label>
                <select name="equipo_local_id" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-xs">
                    {equipos?.map(e => <option value={e.id}>{e.nombre}</option>)}
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Visitante</label>
                <select name="equipo_visitante_id" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-xs">
                    {equipos?.map(e => <option value={e.id}>{e.nombre}</option>)}
                </select>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all mt-4">Programar</button>
        </form>
    </dialog>

    <!-- Match Events Manager (React) -->
    <MatchEventsManager client:only="react" />
    
    <!-- Delete Cascade Manager (React) -->
    <DeleteCascadeManager client:only="react" />


     <dialog id="new-team-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-team" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-team" class="text-2xl font-black uppercase tracking-tighter mb-8">Inscribir Equipo</h3>
        <form id="register-team-form" class="space-y-6">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Seleccionar Equipo</label>
                <select name="equipo_id" required class="w-full bg-slate-50 border-none px-6 py-5 rounded-2xl font-bold text-slate-900">
                    <option value="">-- Seleccione un equipo --</option>
                    {allTeams?.map(team => (
                        <option value={team.id}>{team.nombre}</option>
                    ))}
                </select>
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold text-xs uppercase tracking-widest">Inscribir</button>
        </form>
        <div class="mt-4 pt-4 border-t border-slate-100 text-center">
            <p class="text-xs text-slate-400 mb-2">¬øNo encuentras el equipo?</p>
            <a href="/admin/equipos" class="text-blue-600 font-bold text-xs uppercase tracking-widest hover:underline">Crear Nuevo Equipo</a>
        </div>
    </dialog>

    <!-- 6. New News -->
    <!-- 6. New News -->
    <dialog id="new-news-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-lg relative focus:outline-none backdrop:bg-slate-900/60" role="dialog" aria-modal="true" aria-labelledby="modal-title-news" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-news" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Nueva Noticia</h3>
        <form id="create-news-form" class="space-y-4">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">T√≠tulo</label>
                <input type="text" name="titulo" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Contenido</label>
                <textarea name="contenido" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-medium text-slate-600 h-32"></textarea>
            </div>
                <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">URL Imagen (Opcional)</label>
                <input type="url" name="imagen_url" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all mt-4">Publicar</button>
        </form>
    </dialog>


    <!-- Edit Match Modal (Teams & Date) -->
    <dialog id="edit-match-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-8 shadow-2xl w-full max-w-md relative backdrop:bg-slate-900/60 focus:outline-none overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title-edit-match" tabindex="-1">
        <button class="modal-close-btn absolute top-6 right-6 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h4 id="modal-title-edit-match" class="text-xl font-black uppercase tracking-tighter mb-6 pr-10">Editar Partido</h4>
        
        <div class="h-full max-h-[70vh] overflow-y-auto pr-2 pb-6 custom-scrollbar">
            <!-- Error Display -->
            <div id="edit-match-error" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                <p class="text-red-600 text-sm font-bold"></p>
            </div>
            
            <form id="edit-match-form" class="space-y-6">
            <input type="hidden" name="id" id="edit-match-id-input" />
            
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Equipo Local</label>
                <select name="equipo_local_id" id="edit-match-local" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-sm">
                    {equipos?.map(e => {
                        const participante = participantesRaw?.find((p: any) => p.equipo_id === e.id);
                        const grupo = participante?.grupo || '';
                        return <option value={e.id} data-grupo={grupo}>{e.nombre}</option>;
                    })}
                </select>
            </div>
            
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Equipo Visitante</label>
                <select name="equipo_visitante_id" id="edit-match-visitante" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-sm">
                    {equipos?.map(e => {
                        const participante = participantesRaw?.find((p: any) => p.equipo_id === e.id);
                        const grupo = participante?.grupo || '';
                        return <option value={e.id} data-grupo={grupo}>{e.nombre}</option>;
                    })}
                </select>
            </div>
            
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha y Hora</label>
                <input 
                    type="datetime-local" 
                    name="fecha_partido" 
                    id="edit-match-fecha"
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-sm"
                />
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all">
                Guardar Cambios
            </button>
        </form>
        </div>
    </dialog>


    <!-- Edit Jornada Modal -->
    <dialog id="edit-jornada-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-lg relative focus:outline-none backdrop:bg-slate-900/60 overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title-edit-jornada" tabindex="-1">
        <button onclick="document.getElementById('edit-jornada-modal').close()" class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-edit-jornada" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Editar Jornada</h3>
        
        <div class="h-full max-h-[70vh] overflow-y-auto pr-2 pb-6 custom-scrollbar">
            <form id="edit-jornada-form" class="space-y-4">
                <input type="hidden" name="id" id="edit-jornada-id" />
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">N√∫mero de Jornada</label>
                <input type="number" name="numero_jornada" id="edit-numero-jornada" required min="1" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Nombre de Fase (Opcional)</label>
                <input type="text" name="nombre" id="edit-nombre-fase" placeholder="Ej: Fase Regular, Playoffs, etc." class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Inicio</label>
                    <input type="date" name="fecha_inicio" id="edit-fecha-inicio" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Fin</label>
                    <input type="date" name="fecha_fin" id="edit-fecha-fin" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
                </div>
            </div>
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mt-4">
                <p class="text-xs text-amber-800 font-medium">
                    ‚ö†Ô∏è <strong>Nota:</strong> Si hay partidos programados en esta jornada, aseg√∫rate de que las nuevas fechas sigan siendo v√°lidas para ellos.
                </p>
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all mt-4">Guardar Cambios</button>
        </form>
    </dialog>


  </div>

  <script define:vars={{ jornadasJSON: JSON.stringify(jornadas.map(j => ({ id: j.id, fecha_inicio: j.fecha_inicio || null, fecha_fin: j.fecha_fin || null }))), torneoInicio: torneo.fecha_inicio }}>
    // Dynamic fecha_partido validation based on selected jornada
    const jornadaSelectMatch = document.querySelector('#create-match-form select[name="jornada_id"]');
    const fechaPartidoInput = document.querySelector('#create-match-form input[name="fecha_partido"]');

    if (jornadaSelectMatch && fechaPartidoInput) {
        // Map jornada IDs to their date ranges
        const jornadasData = new Map();
        
        // Populate map from server data
        const jornadasArray = JSON.parse(jornadasJSON);
        
        jornadasArray.forEach((jornada) => {
            jornadasData.set(jornada.id, {
                fecha_inicio: jornada.fecha_inicio,
                fecha_fin: jornada.fecha_fin
            });
        });

        const updateFechaPartidoLimits = () => {
            const selectedJornadaId = jornadaSelectMatch.value;
            const jornadaInfo = jornadasData.get(selectedJornadaId);

            if (jornadaInfo && jornadaInfo.fecha_inicio && jornadaInfo.fecha_fin) {
                // Set min to start of fecha_inicio (00:00)
                const minDate = new Date(jornadaInfo.fecha_inicio);
                fechaPartidoInput.min = minDate.toISOString().slice(0, 16);

                // Set max to end of fecha_fin (23:59)
                const maxDate = new Date(jornadaInfo.fecha_fin);
                maxDate.setHours(23, 59);
                fechaPartidoInput.max = maxDate.toISOString().slice(0, 16);
            } else {
                // If jornada has no dates, fall back to tournament start date
                if (torneoInicio) {
                    fechaPartidoInput.min = new Date(torneoInicio).toISOString().slice(0, 16);
                }
                fechaPartidoInput.removeAttribute('max');
            }
        };

        // Update on jornada selection change
        jornadaSelectMatch.addEventListener('change', updateFechaPartidoLimits);
        
        // Set initial limits when modal opens
        const newMatchModal = document.getElementById('new-match-modal');
        if (newMatchModal) {
            newMatchModal.addEventListener('click', (e) => {
                if (e.target.id === 'new-match-modal') return; // Ignore backdrop clicks
                setTimeout(updateFechaPartidoLimits, 50);
            });
        }

        // Also update when the "Programar Partido" button is clicked
        const openMatchModalBtns = document.querySelectorAll('button[onclick*="new-match-modal"]');
        openMatchModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setTimeout(updateFechaPartidoLimits, 100);
            });
        });
    }
  </script>

  <script>
    import { actions } from 'astro:actions';

    declare global {
        interface Window {
            deleteItem: (type: string, id: string) => Promise<void>;
            closeModal: (id: string) => void;
            showToast: (message: string, type?: 'success' | 'error') => void;
            showConfirm: (title: string, message: string, onConfirm: () => void) => void;
            showCascadeWarning: (options: {
                affectedMatches: any[];
                totalEvents: number;
                impactMessage: string;
                onConfirm: () => void;
            }) => void;
            openEditJornadaModal: (id: string, numero: number, fase: string, inicio: string, fin: string) => void;
            openLeagueFixtureModal: () => void;
            openGroupsFixtureModal: () => void;
            openMatchManager: (matchId: string) => void;
            openEditMatchModal: (matchId: string, localId: string, visitanteId: string, fecha: string) => void;
            MATCH_DATA: {
                matches: any[];
                allEvents: any[];
                allPlayers: any[];
            };
            TORNEO_DATA: {
                estado: string;
                tipo: string;
            };
        }
    }

    // Show success messages from URL params (after page reload)
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const msg = urlParams.get('msg');
        const type = urlParams.get('type') as 'success' | 'error' | null;

        if (msg && type && typeof window.showToast === 'function') {
           window.showToast(msg, type);
            // Clean URL
            const newUrl = window.location.pathname + window.location.search.replace(/[?&](msg|type)=[^&]*/g, '').replace(/^&/, '?').replace(/\?$/, '');
            window.history.replaceState({}, '', newUrl || window.location.pathname);
        }
    });



    // Local delete function (not attached to window to avoid scope issues)
    // Local delete function (not attached to window to avoid scope issues)
    const deleteItem = async (type: string, id: string) => {
        console.log('deleteItem called', type, id); // Debug log
        try {
            let typeLabel = '';
            // Determine label
            if (type === 'Match') typeLabel = 'partido';
            else if (type === 'Jornada') typeLabel = 'jornada';
            else if (type === 'News') typeLabel = 'noticia';
            else if (type === 'TeamParticipation') typeLabel = 'inscripci√≥n de equipo';

            const entityType = (type === 'Match' || type === 'Jornada') ? type.toLowerCase() : null;
            
            // Safe confirm helper
            const safeConfirm = (title: string, msg: string, onConfirm: () => void) => {
                if (typeof window.showConfirm === 'function') {
                    window.showConfirm(title, msg, onConfirm);
                } else if (confirm(`${title}\n${msg}`)) {
                    onConfirm();
                }
            };
            
            // Safe toast helper
            const safeToast = (msg: string, type: 'success' | 'error' = 'error') => {
                if (typeof window.showToast === 'function') {
                    window.showToast(msg, type);
                } else {
                    alert(`${type === 'error' ? 'Error' : 'Success'}: ${msg}`);
                }
            };

            // Check for cascade impact if it's a match or jornada
            if (entityType) {
                console.log('Checking cascade impact for', entityType);
                try {
                    const checkFormData = new FormData();
                    checkFormData.append('type', entityType);
                    checkFormData.append('id', id);
                    
                    const { data: impactData, error: impactError } = await actions.checkDeleteImpact(checkFormData);
                    
                    if (impactError) {
                        console.error('Error checking delete impact:', impactError);
                        safeToast('Error al verificar el impacto de eliminaci√≥n', 'error');
                        return;
                    }
                    
                    // If there's an impact, show cascade warning modal
                    if (impactData?.hasImpact) {
                        const showCascadeWarning = (window as any).showCascadeWarning;
                        
                        if (typeof showCascadeWarning === 'function') {
                            // Check for Playoff Reset Scenario (Group Match with generated playoffs)
                            const isPlayoffReset = impactData.message && (
                                impactData.message.includes('Playoffs are already generated') || 
                                impactData.message.includes('invalidate the current playoff bracket') ||
                                impactData.message.includes('Group stage match deleting while playoffs exist')
                            );

                            showCascadeWarning({
                                affectedMatches: impactData.affectedMatches || [],
                                totalEvents: impactData.totalEvents || 0,
                                impactMessage: impactData.message || '',
                                showCascadeOption: isPlayoffReset,
                                onConfirm: async (cascade: boolean) => {
                                    await executeDelete(type, id, typeLabel, cascade);
                                }
                            });
                            return; // Exit, wait for modal confirmation
                        }
                    }
                    
                    // No impact or standard confirmation
                    safeConfirm(
                        `Eliminar ${typeLabel}`,
                        typeLabel === 'partido' 
                        ? '¬øEst√°s seguro de que deseas eliminar este partido? Esta acci√≥n no se puede deshacer.'
                        : '‚ö†Ô∏è ¬°ADVERTENCIA! Al eliminar esta jornada se eliminar√°n TODOS los partidos asociados a ella. ¬øEst√°s seguro de continuar?',
                        async () => {
                            await executeDelete(type, id, typeLabel);
                        }
                    );
                    
                } catch (err: any) {
                    console.error('Cascade check error:', err);
                    safeToast(err.message || 'Error al verificar el impacto', 'error');
                }
            } else {
                // Not match/jornada (e.g. News or TeamParticipation)
                let message = `¬øEst√°s seguro de que deseas eliminar ${typeLabel}? Esta acci√≥n no se puede deshacer.`;
                if (type === 'TeamParticipation') {
                     message = '¬øEst√°s seguro de desinscribir a este equipo del torneo? Si el equipo ya tiene partidos programados, la acci√≥n fallar√°.';
                }

                safeConfirm(
                    `Eliminar ${typeLabel}`,
                    message,
                    async () => {
                        await executeDelete(type, id, typeLabel);
                    }
                );
            }
        } catch (e) {
            console.error('Fatal error in deleteItem:', e);
            alert('Error inesperado al intentar eliminar. Revisa la consola.');
        }
    };

    // Attach listeners function
    function attachDeleteListeners() {
        console.log('Attaching delete listeners...');
        const buttons = document.querySelectorAll('.delete-btn-trigger');
        console.log(`Found ${buttons.length} delete buttons`);
        
        buttons.forEach(btn => {
            if (btn.getAttribute('data-listener-attached') === 'true') return;
            
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const type = btn.getAttribute('data-delete-type') || '';
                const id = btn.getAttribute('data-delete-id') || '';
                if (type && id) {
                    deleteItem(type, id);
                } else {
                    console.error('Delete button missing data attributes', btn);
                }
            });
            btn.setAttribute('data-listener-attached', 'true');
        });
    }

    // Run on load
    attachDeleteListeners();
    // Also run on Astro page swap if using View Transitions
    document.addEventListener('astro:page-load', attachDeleteListeners);

    
    // Helper function to execute the actual deletion
    async function executeDelete(type: string, id: string, typeLabel: string, cascade = false) {
        const fd = new FormData();
        if (cascade) fd.append('cascade', 'true');
        // For TeamParticipation we need torneo_id too, but action might handle it?
        // Wait, old performDelete logic:
        // const urlParts = window.location.pathname.split('/');
        // const torneoId = urlParts[urlParts.length - 1];
        // formData.append('torneo_id', torneoId);
        // formData.append('equipo_id', id);
        
        // For Match/Jornada/News: fd.append('id', id);
        
        if (type === 'TeamParticipation') {
             const urlParts = window.location.pathname.split('/');
             // Ensure we get ID correctly. Path is usually /admin/torneo/[id]
             // But sometimes /admin/torneo/[id]/...
             // Best to use the hidden input if available, or parse URL strictly?
             // Helper to get Torneo ID from URL commonly used in this file?
             // The script has access to `id` (Astro prop) if we output it?
             // No, script is client side.
             // We can find the hidden input `name="id"` in `edit-tournament-form`?
             const editForm = document.getElementById('edit-tournament-form') as HTMLFormElement;
             let torneoId = '';
             if (editForm) {
                 torneoId = (editForm.querySelector('input[name="id"]') as HTMLInputElement)?.value;
             }
             if (!torneoId) {
                  // Fallback to URL
                  const parts = window.location.pathname.split('/');
                  torneoId = parts[parts.length - 1] || parts[parts.length - 2]; 
                  // If path ends in slash, length-1 is empty.
                  if (!torneoId) torneoId = parts[parts.length - 3];
             }
             
             fd.append('torneo_id', torneoId);
             fd.append('equipo_id', id);
        } else {
            fd.append('id', id);
        }

        let result;
        if (type === 'Match') result = await actions.deleteMatch(fd);
        else if (type === 'Jornada') result = await actions.deleteJornada(fd);
        else if (type === 'News') result = await actions.deleteNews(fd);
        else if (type === 'TeamParticipation') result = await actions.unregisterTeamFromTournament(fd);
        
        if (result?.error) {
           window.showToast(result.error.message, 'error');
        } else {
            // Success: redirect with message
            let successMsg = '';
            if (type === 'Match') successMsg = 'Partido eliminado correctamente';
            else if (type === 'Jornada') successMsg = 'Jornada eliminada correctamente';
            else if (type === 'News') successMsg = 'Noticia eliminada correctamente';
            else if (type === 'TeamParticipation') successMsg = 'Equipo desinscrito correctamente';

            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('msg', successMsg);
            currentUrl.searchParams.set('type', 'success');
            window.location.href = currentUrl.toString();
        }
    }


    window.closeModal = (id: string) => {
        const dialog = document.getElementById(id) as HTMLDialogElement;
        if (dialog) dialog.close();
    };

    // Generic Form Handler with In-Modal Error Display
    const handleForm = (formId: string, actionName: string, errorDivId?: string, successMsg?: string) => {
        const form = document.getElementById(formId) as HTMLFormElement;
        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            
            // Clear previous errors
            if (errorDivId) {
                const errorDiv = document.getElementById(errorDivId);
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                    const errorText = errorDiv.querySelector('p');
                    if (errorText) errorText.textContent = '';
                }
            }
            
            // Validation override for same team
            if (formId === 'create-match-form' && formData.get('equipo_local_id') === formData.get('equipo_visitante_id')) {
                if (errorDivId) {
                    const errorDiv = document.getElementById(errorDivId);
                    if (errorDiv) {
                        const errorText = errorDiv.querySelector('p');
                        if (errorText) errorText.textContent = 'Los equipos deben ser diferentes';
                        errorDiv.classList.remove('hidden');
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
               window.showToast('Equipos deben ser diferentes', 'error');
                return;
            }

            // Type safe action call
            const action = (actions as any)[actionName];
            const { error } = await action(formData);

            if (error) {
                // Show error in modal if errorDivId provided
                if (errorDivId) {
                    const errorDiv = document.getElementById(errorDivId);
                    if (errorDiv) {
                        const errorText = errorDiv.querySelector('p');
                        if (errorText) errorText.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                // Also show toast for redundancy
               window.showToast(error.message, 'error');
            } else {
                // Success: redirect with message if provided
                if (successMsg) {
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('msg', successMsg);
                    currentUrl.searchParams.set('type', 'success');
                    window.location.href = currentUrl.toString();
                } else {
                    window.location.reload();
                }
            }
        });
    };

    handleForm('edit-tournament-form', 'updateTournament', undefined, 'Torneo actualizado correctamente');
    handleForm('create-jornada-form', 'createJornada', 'create-jornada-error', 'Jornada creada correctamente');
    handleForm('register-team-form', 'registerTeamInTournament', undefined, 'Equipo inscrito correctamente');
    handleForm('create-match-form', 'createMatch', 'create-match-error', 'Partido programado correctamente');
    handleForm('create-news-form', 'createNews', undefined, 'Noticia publicada correctamente');
    
    // Result form manual handle for data matching
    const resultForm = document.getElementById('edit-result-form') as HTMLFormElement;
    resultForm?.addEventListener('submit', async(e) => {
        e.preventDefault();
        const fd = new FormData(resultForm);
        
        // Manually construct the data to ensure correct types
        const matchId = fd.get('matchId') as string;
        const puntosLocal = parseInt(fd.get('puntos_local') as string, 10);
        const puntosVisitante = parseInt(fd.get('puntos_visitante') as string, 10);
        
        const finalizar = (document.getElementById('check-finalizar') as HTMLInputElement).checked;
        
        console.log('Submitting match result:', { matchId, puntosLocal, puntosVisitante, finalizar });
        
        // Create new FormData with correct values
        const formData = new FormData();
        formData.append('id', matchId);
        formData.append('puntos_local', puntosLocal.toString());
        formData.append('puntos_visitante', puntosVisitante.toString());
        if (finalizar) formData.append('finalizar', 'true');
        
        try {
            const { error } = await actions.updateMatchResult(formData);
            if (error) {
                console.error('Action error:', error);
                window.showToast(error.message, 'error');
            } else {
                // Success with Message
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('msg', 'Marcador actualizado correctamente');
                currentUrl.searchParams.set('type', 'success');
                window.location.href = currentUrl.toString();
            }
        } catch (err: any) {
            console.error('Caught error:', err);
            window.showToast(err.message || 'Error al actualizar marcador', 'error');
        }
    });

    // Edit Match form handler
    const editMatchForm = document.getElementById('edit-match-form') as HTMLFormElement;
    editMatchForm?.addEventListener('submit', async(e) => {
        e.preventDefault();
        const formData = new FormData(editMatchForm);
        
        // Clear previous errors
        const errorDiv = document.getElementById('edit-match-error');
        if (errorDiv) {
            errorDiv.classList.add('hidden');
            const errorText = errorDiv.querySelector('p');
            if (errorText) errorText.textContent = '';
        }
        
        // Client-side validation
        if (formData.get('equipo_local_id') === formData.get('equipo_visitante_id')) {
            if (errorDiv) {
                const errorText = errorDiv.querySelector('p');
                if (errorText) errorText.textContent = 'Los equipos deben ser diferentes';
                errorDiv.classList.remove('hidden');
            }
            window.showToast('Los equipos deben ser diferentes', 'error');
            return;
        }
        
        // Validate teams are from the same group (for group tournaments)
        const localSelect = document.getElementById('edit-match-local') as HTMLSelectElement;
        const visitanteSelect = document.getElementById('edit-match-visitante') as HTMLSelectElement;
        const localOption = localSelect.options[localSelect.selectedIndex];
        const visitanteOption = visitanteSelect.options[visitanteSelect.selectedIndex];
        const localGrupo = localOption?.getAttribute('data-grupo') || '';
        const visitanteGrupo = visitanteOption?.getAttribute('data-grupo') || '';
        
        if (localGrupo && visitanteGrupo && localGrupo !== visitanteGrupo) {
            if (errorDiv) {
                const errorText = errorDiv.querySelector('p');
                if (errorText) errorText.textContent = `Los equipos deben ser del mismo grupo. ${localOption.text} es del ${localGrupo} y ${visitanteOption.text} es del ${visitanteGrupo}`;
                errorDiv.classList.remove('hidden');
            }
            window.showToast('Los equipos deben ser del mismo grupo', 'error');
            return;
        }
        
        const { error } = await actions.updateMatch(formData);
        if (error) {
            if (errorDiv) {
                const errorText = errorDiv.querySelector('p');
                if (errorText) errorText.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
            window.showToast(error.message, 'error');
        } else {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('msg', 'Partido actualizado correctamente');
            currentUrl.searchParams.set('type', 'success');
            window.location.href = currentUrl.toString();
        }
    });

    // Open Edit Match Modal function
    window.openEditMatchModal = (matchId: string, localId: string, visitanteId: string, fecha: string) => {
        (document.getElementById('edit-match-id-input') as HTMLInputElement).value = matchId;
        
        const localSelect = document.getElementById('edit-match-local') as HTMLSelectElement;
        const visitanteSelect = document.getElementById('edit-match-visitante') as HTMLSelectElement;
        
        // Get the group from the currently selected local team
        const currentLocalOption = Array.from(localSelect.options).find(opt => opt.value === localId);
        const matchGroup = currentLocalOption?.getAttribute('data-grupo') || '';
        
        // Filter options to only show teams from the same group (if group exists)
        const filterByGroup = (select: HTMLSelectElement, selectedValue: string) => {
            Array.from(select.options).forEach(option => {
                const optionGroup = option.getAttribute('data-grupo') || '';
                // Show option if: no group assigned (non-group tournament) OR same group as match
                if (!matchGroup || optionGroup === matchGroup || optionGroup === '') {
                    option.style.display = '';
                    option.disabled = false;
                } else {
                    option.style.display = 'none';
                    option.disabled = true;
                }
            });
            select.value = selectedValue;
        };
        
        filterByGroup(localSelect, localId);
        filterByGroup(visitanteSelect, visitanteId);
        
        const fechaInput = document.getElementById('edit-match-fecha') as HTMLInputElement;
        if (fechaInput) {
            if (fecha && fecha !== 'null' && fecha !== '') {
                // Convert to datetime-local format
                fechaInput.value = new Date(fecha).toISOString().slice(0, 16);
            } else {
                // Clear the input if no fecha
                fechaInput.value = '';
            }
        }
        
        (document.getElementById('edit-match-modal') as HTMLDialogElement).showModal();
    };



    // Generic Modal Close Logic
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const dialog = btn.closest('dialog');
            if (dialog) {
                // Clear any error messages in this modal before closing
                const errorDivs = dialog.querySelectorAll('[id$="-error"]');
                errorDivs.forEach(div => {
                    div.classList.add('hidden');
                    const errorText = div.querySelector('p');
                    if (errorText) errorText.textContent = '';
                });
                dialog.close();
            }
        });
    });

    // Close on backdrop click
    document.querySelectorAll('dialog').forEach(dialog => {
        dialog.addEventListener('click', (e) => {
            const rect = dialog.getBoundingClientRect();
            const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
              rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
            if (!isInDialog) {
                // Clear errors before closing
                const errorDivs = dialog.querySelectorAll('[id$="-error"]');
                errorDivs.forEach(div => {
                    div.classList.add('hidden');
                    const errorText = div.querySelector('p');
                    if (errorText) errorText.textContent = '';
                });
                dialog.close();
            }
        });
    });

    // Automatic Fixture Generation Handler
    const generateFixtureBtn = document.getElementById('generate-fixture-btn') as HTMLButtonElement | null;
    if (generateFixtureBtn) {
        generateFixtureBtn.addEventListener('click', async () => {
            const torneoTipo = generateFixtureBtn.dataset.tipo;
            const torneoId = generateFixtureBtn.dataset.id;
            
            // New League Logic: Open Modal
            if (torneoTipo === 'liga') {
                if ((window as any).openLeagueFixtureModal) {
                    (window as any).openLeagueFixtureModal();
                } else {
                    console.error('LeagueFixtureModal not found');
                    window.showToast('Error: No se puede abrir el modal de configuraci√≥n.', 'error');
                }
                return;
            }

            // Groups + Playoff: Open Groups Modal
            if (torneoTipo === 'grupos_eliminacion') {
                if ((window as any).openGroupsFixtureModal) {
                    (window as any).openGroupsFixtureModal();
                } else {
                    console.error('GroupsFixtureModal not found');
                    window.showToast('Error: No se puede abrir el modal de configuraci√≥n de grupos.', 'error');
                }
                return;
            }

            // Existing Logic for Elimination
            const torneoNombre = generateFixtureBtn.dataset.nombre;
            
            const confirmMsg = torneoTipo === 'liga' 
                ? `¬øGenerar fixture autom√°tico para "${torneoNombre}"?\n\nSe crear√°n todas las jornadas y partidos del torneo tipo Liga (Round-Robin).`
                : `¬øGenerar fixture autom√°tico para "${torneoNombre}"?\n\nSe crear√° el bracket de eliminaci√≥n simple con todos los partidos.`;
            
            window.showConfirm(
                'Generar Fixture Autom√°tico',
                confirmMsg,
                async () => {
                    try {
                        // Show loading state
                        generateFixtureBtn.disabled = true;
                        generateFixtureBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...';
                        
                        const response = await fetch(`/api/generate-fixture/${torneoId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                action: torneoTipo === 'liga' ? 'round-robin' : 'single-elimination'
                            })
                        });
                        
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            window.location.reload();
                        } else {
                            let errorMsg = 'Error al generar fixture';
                            try {
                                const errorData = await response.json();
                                if (errorData.message) errorMsg = errorData.message;
                            } catch (e) {
                                console.error('No se pudo parsear el error', e);
                            }
                            throw new Error(errorMsg);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        generateFixtureBtn.disabled = false;
                        generateFixtureBtn.innerHTML = '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Generar Fixture Autom√°tico';
                        if (typeof window.showToast === 'function') {
                            window.showToast('Error al generar fixture. Por favor, intenta nuevamente.', 'error');
                        } else {
                            console.error('Error al generar fixture.');
                        }
                    }
                }
            );
        });
    }


    // Delete All Jornadas Handler
    const deleteAllBtn = document.getElementById('delete-all-jornadas-btn') as HTMLButtonElement | null;
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async () => {
            const torneoId = deleteAllBtn.dataset.id;
            
            window.showConfirm(
                'Eliminar Todas las Jornadas',
                '¬øEst√°s seguro de eliminar TODAS las jornadas y partidos? Esta acci√≥n no se puede deshacer.',
                async () => {
                    try {
                        deleteAllBtn.disabled = true;
                        deleteAllBtn.textContent = '‚è≥ Eliminando...';
                        
                        const response = await fetch(`/api/delete-all-jornadas/${torneoId}`, {
                            method: 'POST'
                        });
                        
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            window.location.reload();
                        } else {
                            throw new Error('Error al eliminar jornadas');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        deleteAllBtn.disabled = false;
                        deleteAllBtn.textContent = 'üóëÔ∏è Eliminar Todas';
                        if (typeof window.showToast === 'function') {
                            window.showToast('Error al eliminar jornadas. Por favor, intenta nuevamente.', 'error');
                        } else {
                            console.error('Error al eliminar jornadas.');
                        }
                    }
                }
            );
        })
    }

    // Generate Playoff Handler
    const generatePlayoffBtn = document.getElementById('generate-playoff-btn') as HTMLButtonElement | null;
    if (generatePlayoffBtn) {
        generatePlayoffBtn.addEventListener('click', async () => {
            const torneoId = generatePlayoffBtn.dataset.id;
            const nombre = generatePlayoffBtn.dataset.nombre;
            
            window.showConfirm(
                'Generar Fase Playoff',
                `¬øEst√°s listo para generar los playoffs del torneo "${nombre}"?\n\nSe verificar√°n los resultados de la fase de grupos y se crear√°n los cruces eliminatorios.`,
                async () => {
                    try {
                        generatePlayoffBtn.disabled = true;
                        generatePlayoffBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...';
                        
                        const result = await actions.generatePlayoffFromGroups({ torneoId: torneoId! });
                        
                        if (result.data && result.data.success) {
                            if (typeof window.showToast === 'function') {
                                window.showToast('Playoff generado correctamente!', 'success');
                            }
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            throw new Error(result.error?.message || result.data?.message || 'Error desconocido');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        generatePlayoffBtn.disabled = false;
                        generatePlayoffBtn.innerHTML = '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg> Generar Playoff';
                        
                        if (typeof window.showToast === 'function') {
                            window.showToast(error instanceof Error ? error.message : 'Error al generar playoff', 'error');
                        } else {
                            alert(error instanceof Error ? error.message : 'Error al generar playoff');
                        }
                    }
                }
            );
        });
    }

    // Edit Jornada Modal Logic
    function openEditJornadaModal(id: string, numeroJornada: number, nombreFase: string, fechaInicio: string, fechaFin: string) {
        const modal = document.getElementById('edit-jornada-modal') as HTMLDialogElement;
        const form = document.getElementById('edit-jornada-form') as HTMLFormElement;
        
        if (!modal || !form) return;

        // Populate form
        (document.getElementById('edit-jornada-id') as HTMLInputElement).value = id;
        (document.getElementById('edit-numero-jornada') as HTMLInputElement).value = numeroJornada.toString();
        (document.getElementById('edit-nombre-fase') as HTMLInputElement).value = nombreFase;
        (document.getElementById('edit-fecha-inicio') as HTMLInputElement).value = fechaInicio;
        (document.getElementById('edit-fecha-fin') as HTMLInputElement).value = fechaFin;

        modal.showModal();
    }

    async function handleEditJornada(e: Event) {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
        const modal = document.getElementById('edit-jornada-modal') as HTMLDialogElement;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';

        try {
            const result = await actions.updateJornada(formData);

            if (result.data) {
                // Redirect with success message
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('msg', 'Jornada actualizada correctamente');
                currentUrl.searchParams.set('type', 'success');
                window.location.href = currentUrl.toString();
                
            } else if (result.error) {
                throw new Error(result.error.message);
            }
        } catch (error) {
            console.error('Error:', error);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Guardar Cambios';
            
            // For errors while modal is open, we try to show toast.
            // Note: If modal is Top Layer, toast might be behind.
            if (typeof window.showToast === 'function') {
                window.showToast(error instanceof Error ? error.message : 'Error al actualizar jornada', 'error');
            } else {
                console.error('Error al actualizar jornada:', error);
            }
        }
    }

    // Make functions global
    (window as any).openEditJornadaModal = openEditJornadaModal;

    // Jornada Navigation
    const jornadasNav = document.getElementById('jornadas-nav');
    if (jornadasNav) {
        // ... existing jornada nav logic ...
    }

    // Group Filter Logic
    const groupFilterBtns = document.querySelectorAll('.group-filter-btn');
    if (groupFilterBtns.length > 0) {
        groupFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state
                groupFilterBtns.forEach(b => {
                    b.classList.remove('bg-slate-900', 'text-white', 'shadow-lg');
                    b.classList.add('bg-slate-50', 'text-slate-400');
                });
                btn.classList.remove('bg-slate-50', 'text-slate-400');
                btn.classList.add('bg-slate-900', 'text-white', 'shadow-lg');

                const selectedGroup = (btn as HTMLElement).dataset.group;
                
                // Filter matches
                const allMatches = document.querySelectorAll('.match-card');
                let visibleCount = 0;

                allMatches.forEach(match => {
                    const m = match as HTMLElement;
                    if (selectedGroup === 'all') {
                        m.style.display = '';
                        visibleCount++;
                    } else {
                        const localGroup = m.dataset.groupLocal;
                        const visitorGroup = m.dataset.groupVisitor;
                        // Show if either team belongs to the group (covers inter-group if any, mainly intra-group)
                        if (localGroup === selectedGroup || visitorGroup === selectedGroup) {
                            m.style.display = '';
                            visibleCount++;
                        } else {
                            m.style.display = 'none';
                        }
                    }
                });
            });
        });
    }

    // Initialize logic if not already present...
    // But since this is inside the script tag, assume it runs on load.

    // Handle edit jornada form submission
    const editJornadaForm = document.getElementById('edit-jornada-form');
    if (editJornadaForm) {
        editJornadaForm.addEventListener('submit', handleEditJornada);
    }

    // Matchday Tabs Logic
    const tabBtns = document.querySelectorAll('.jornada-tab-btn');
    const containers = document.querySelectorAll('.jornada-container');

    // Function to activate a specific tab (by ID or Index)
    function activateTab(targetId: string) {
        // 1. Reset all buttons
        tabBtns.forEach(b => {
            b.classList.remove('bg-slate-900', 'text-white', 'shadow-lg');
            b.classList.add('bg-slate-50', 'text-slate-400', 'hover:bg-slate-100');
        });

        // 2. Activate target button
        const btn = document.querySelector(`.jornada-tab-btn[data-target="${targetId}"]`);
        if (btn) {
            btn.classList.remove('bg-slate-50', 'text-slate-400', 'hover:bg-slate-100');
            btn.classList.add('bg-slate-900', 'text-white', 'shadow-lg');
            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        // 3. Show target container
        containers.forEach(container => {
            if (container.id === targetId) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        });
    }

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = (btn as HTMLElement).dataset.target;
            if (targetId) {
                activateTab(targetId);
                
                // Update URL without reloading
                const url = new URL(window.location.href);
                // Extract clean ID (remove 'jornada-' prefix if needed, or keep as is.
                // The IDs are like 'jornada-UUID'. Let's store just the UUID if possible, or the whole string.
                // Let's store the UUID for cleaner URLs: ?jornada=UUID
                const jornadaId = targetId.replace('jornada-', '');
                url.searchParams.set('jornada', jornadaId);
                window.history.replaceState({}, '', url);
            }
        });
    });

    // Restore tab from URL on load
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const jornadaId = urlParams.get('jornada');
        if (jornadaId) {
            const targetId = `jornada-${jornadaId}`;
            // Verify if exists
            if (document.getElementById(targetId)) {
                activateTab(targetId);
            }
        }
    });

    // Match Events Manager Logic
    window.openMatchManager = (matchId) => {
        console.log('Opening match manager for:', matchId);
        try {
            if (!window.MATCH_DATA) {
                console.error('MATCH_DATA not found on window object');
                return;
            }
            
            const { matches, allEvents, allPlayers } = window.MATCH_DATA;
            // console.log('Data available:', { matchesCount: matches?.length, eventsCount: allEvents?.length, playersCount: allPlayers?.length });

            const match = matches.find(m => m.id === matchId);
            if (!match) {
                console.error('Match not found in data:', matchId);
                return;
            }
            
            const events = allEvents ? allEvents.filter(e => e.partido_id === matchId) : [];
            
            console.log('Dispatching event with:', { match, eventsCount: events.length });
            
            // Dispatch event to open React modal
            window.dispatchEvent(new CustomEvent('open-match-manager', {
                detail: { 
                    match, 
                    events, 
                    allPlayers,
                    torneoEstado: window.TORNEO_DATA?.estado || 'activo',
                    torneoTipo: window.TORNEO_DATA?.tipo || 'todos_contra_todos'
                }
            }));
        } catch (e) {
            console.error('Error in openMatchManager:', e);
            alert('Error al abrir el gestor de eventos. Revisa la consola.');
        }
    };

    (window as any).openMatchManager = window.openMatchManager;

    // --- Delete Logic ---




    window.deleteItem = async (type: string, id: string) => {
        if (type !== 'Tournament') return;

        window.showConfirm(
            'Eliminar Torneo',
            '¬øEst√°s seguro de que deseas eliminar este torneo? Se borrar√°n todos los partidos, jornadas y configuraciones asociadas. Esta acci√≥n NO se puede deshacer.',
            async () => {
                const fd = new FormData();
                fd.append('id', id);

                const result = await actions.deleteTournament(fd);

                if (result?.error) {
                    window.showToast(result.error.message, 'error');
                } else {
                    window.location.href = '/admin/dashboard?msg=Torneo eliminado correctamente&type=success';
                }
            }
        );
    };

    // Playoff Config Toggle (Edit Modal)
    const editUsaIdaVueltaCheckbox = document.getElementById('edit-usa-ida-vuelta-checkbox');
    const editPhasesSelection = document.getElementById('edit-phases-selection');

    if (editUsaIdaVueltaCheckbox && editPhasesSelection) {
        editUsaIdaVueltaCheckbox.addEventListener('change', (e) => {
            if ((e.target as HTMLInputElement).checked) {
                editPhasesSelection.classList.remove('hidden');
            } else {
                editPhasesSelection.classList.add('hidden');
            }
        });
    }

  </script>

  <ConfirmationModal />
  <LeagueFixtureModal torneoId={id} />
  <GroupsFixtureModal torneoId={id} totalEquipos={equipos.length} equipos={equipos} />

  <script define:vars={{ matches, allEvents, allPlayers, torneoEstado: torneo.estado, torneoTipo: torneo.tipo }}>
     window.MATCH_DATA = { matches, allEvents, allPlayers };
     window.TORNEO_DATA = { estado: torneoEstado, tipo: torneoTipo };
  </script>
  
</AdminSidebarLayout>
