---
import AdminSidebarLayout from '../../../layouts/AdminSidebarLayout.astro';
import SmartImage from '../../../components/SmartImage.astro';
import StandingsTable from '../../../components/StandingsTable.astro';
import MatchEventsManager from '../../../components/MatchEventsManager.tsx';
import { supabase } from '../../../lib/supabase';
import { calculateStandings } from '../../../lib/standings';

const { id } = Astro.params;
const tab = Astro.url.searchParams.get('tab') || 'dashboard';

if (!id) return Astro.redirect('/admin/dashboard');

// Interfaces
interface Torneo {
  id: string;
  nombre: string;
  descripcion: string | null;
  imagen_portada: string | null;
  logo_url: string | null;
  fecha_inicio: string;
  estado: string;
  tipo: 'liga' | 'eliminacion_simple' | 'grupos_eliminacion';
  config: {
    double_round?: boolean;
    use_seeding?: boolean;
  } | null;
}

interface Equipo {
  id: string;
  nombre: string;
  logo_url: string | null;
  creado_at: string;
}

interface Jornada {
  id: string;
  numero_jornada: number;
  nombre_fase: string | null;
  torneo_id: string;
  fecha_inicio?: string;
  fecha_fin?: string;
}

interface Partido {
  id: string;
  equipo_local_id: string | null;
  equipo_visitante_id: string | null;
  puntos_local: number | null;
  puntos_visitante: number | null;
  estado_partido: 'pendiente' | 'en_curso' | 'finalizado';
  fecha_partido: string | null;
  jornada_id: string;
  local?: Equipo;
  visitante?: Equipo;
  jornada?: Jornada;
}

interface Noticia {
  id: string;
  titulo: string;
  contenido: string | null;
  imagen_url: string | null;
  created_at: string;
}

// 1. Fetch Tournament
const { data: torneoRaw, error: tError } = await supabase
  .from('torneos')
  .select('*')
  .eq('id', id)
  .single();

if (tError || !torneoRaw) return Astro.redirect('/admin/dashboard');

const torneo = torneoRaw as Torneo;

// 2. Fetch Helper Data (Jornadas, Teams)
const { data: jornadasRaw } = await supabase
  .from('jornadas')
  .select('*')
  .eq('torneo_id', id)
  .order('numero_jornada', { ascending: true });

const jornadas = (jornadasRaw || []) as Jornada[];

const { data: participantesRaw } = await supabase
  .from('torneo_participantes')
  .select(`
    equipo:equipos (
      id,
      nombre,
      logo_url,
      creado_at
    )
  `)
  .eq('torneo_id', id);

const equipos = (participantesRaw?.map((p: any) => p.equipo).filter(Boolean) || []).sort((a: any, b: any) => a.nombre.localeCompare(b.nombre)) as Equipo[];

// Fetch ALL teams for the registration dropdown
const { data: allTeamsRaw } = await supabase
  .from('equipos')
  .select('id, nombre, logo_url')
  .order('nombre');

const allTeams = (allTeamsRaw || []) as Equipo[];

// 3. Fetch Matches
const jornadaIds = jornadas.map(j => j.id);
let matches: Partido[] = [];

if (jornadaIds.length > 0) {
    const { data: m } = await supabase
        .from('partidos')
        .select(`
            *,
            local:equipo_local_id(id, nombre, logo_url),
            visitante:equipo_visitante_id(id, nombre, logo_url),
            jornada:jornada_id(id, numero_jornada, nombre_fase)
        `)
        .in('jornada_id', jornadaIds)
        .order('fecha_partido', { ascending: false });
    matches = (m || []) as Partido[];
}

// 4. Fetch Match Events
const matchIds = matches.map(m => m.id);
let allEvents: any[] = [];

if (matchIds.length > 0) {
    const { data: eventsRaw } = await supabase
        .from('eventos_partido')
        .select(`
            *,
            jugador:jugador_cedula(numero_cedula, nombre, dorsal)
        `)
        .in('partido_id', matchIds)
        .order('minuto', { ascending: true });
    allEvents = eventsRaw || [];
}

// 5. Fetch Players from all teams in tournament
const equipoIds = equipos.map(e => e.id);
let allPlayers: any[] = [];

if (equipoIds.length > 0) {
    const { data: playersRaw } = await supabase
        .from('deportistas')
        .select('numero_cedula, nombre, dorsal, equipo_id')
        .in('equipo_id', equipoIds);
    allPlayers = playersRaw || [];
}

// 6. Fetch News
const { data: noticiasRaw } = await supabase
    .from('noticias')
    .select('*')
    .eq('torneo_id', id)
    .order('created_at', { ascending: false });

const noticias = (noticiasRaw || []) as Noticia[];

// 7. Calculate Standings
const standings = calculateStandings(equipos, matches);

---

<AdminSidebarLayout title={`Admin: ${torneo.nombre}`}>
  <div class="space-y-8 pb-20">
    
    <!-- Header -->
    <div class="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-6">
            <div class="w-20 h-20 rounded-2xl bg-slate-900 shadow-lg flex-shrink-0">
                <SmartImage 
                    entityId={torneo.id} 
                    entityType="tournament" 
                    currentImage={torneo.logo_url} 
                    fallbackInitial={torneo.nombre[0]}
                    bucket="logos" 
                    className="w-full h-full rounded-2xl"
                />
            </div>
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <span class={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${torneo.estado === 'activo' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>
                        {torneo.estado}
                    </span>
                    <span class="text-slate-400 text-xs font-bold uppercase">{Array.isArray(equipos) ? equipos.length : 0} Equipos</span>
                </div>
                <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter margin-0 leading-none">{torneo.nombre}</h1>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('edit-tournament-modal').showModal()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-xs font-black uppercase tracking-widest transition-all">
                Configuraci√≥n
            </button>
            <a href={`/torneo/${id}`} target="_blank" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 transition-all">
                Ver P√∫blico
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-slate-200">
        <nav class="flex space-x-8 -mb-px overflow-x-auto">
            <a href="?tab=dashboard" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'dashboard' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Dashboard
            </a>
            <a href="?tab=jornadas" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'jornadas' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Jornadas y Partidos
            </a>
            <a href="?tab=equipos" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'equipos' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Equipos
            </a>
            <a href="?tab=noticias" class={`py-4 px-2 border-b-2 font-black uppercase text-xs tracking-widest ${tab === 'noticias' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                Noticias
            </a>
        </nav>
    </div>

    <!-- DASHBOARD TAB -->
    {tab === 'dashboard' && (
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-2 duration-300">
            <!-- Posiciones Preview -->
            <div class="space-y-4">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Tabla General</h3>
                <StandingsTable standings={standings} />
            </div>

            <!-- Recent Matches -->
            <div class="space-y-4">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">√öltimos Resultados</h3>
                <div class="space-y-3">
                    {matches.slice(0, 5).map((match: Partido) => (
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center group hover:border-blue-200 transition-colors cursor-pointer" onclick={`openEditResultModal('${match.id}', '${match.local?.nombre}', '${match.visitante?.nombre}', ${match.puntos_local || 0}, ${match.puntos_visitante || 0})`}>
                            <div class="flex items-center gap-4 text-xs font-bold text-slate-600">
                                <span class="bg-slate-100 px-2 py-1 rounded text-[9px] uppercase tracking-widest">{match.jornada?.nombre_fase || 'Jornada ' + match.jornada?.numero_jornada}</span>
                                <span>{match.local?.nombre}</span>
                                <span class="font-black text-slate-900">{match.puntos_local ?? '-'}</span>
                                <span class="text-slate-300">vs</span>
                                <span class="font-black text-slate-900">{match.puntos_visitante ?? '-'}</span>
                                <span>{match.visitante?.nombre}</span>
                            </div>
                            <svg class="w-4 h-4 text-slate-300 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </div>
                    ))}
                     {matches.length === 0 && <p class="text-slate-400 text-sm">No hay partidos registrados.</p>}
                </div>
            </div>
        </div>
    )}

    <!-- JORNADAS TAB -->
    {tab === 'jornadas' && (

        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
             <div class="flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Gesti√≥n de Partidos</h3>
                <div class="flex gap-2">
                    {jornadas.length === 0 ? (
                        <button 
                            id="generate-fixture-btn" 
                            data-id={id}
                            data-tipo={torneo.tipo}
                            data-nombre={torneo.nombre}
                            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/30 hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            Generar Fixture Autom√°tico
                        </button>
                    ) : (
                        <button 
                            id="delete-all-jornadas-btn"
                            data-id={id}
                            class="px-4 py-2 bg-white border border-red-200 hover:border-red-500 hover:bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                        >
                            üóëÔ∏è Eliminar Todas
                        </button>
                    )}
                    <button onclick="document.getElementById('new-jornada-modal').showModal()" class="px-4 py-2 bg-white border border-slate-200 hover:border-blue-500 text-slate-600 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                        + Nueva Jornada
                    </button>
                    <button onclick="document.getElementById('new-match-modal').showModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all">
                        + Programar Partido
                    </button>
                </div>
             </div>

             {jornadas && jornadas.length > 0 ? (
                <div class="space-y-6">
                    <!-- Horizontal Scroll Navigation -->
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-2 sticky top-4 z-20">
                         <div class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide" id="jornadas-nav">
                            {jornadas.map((jornada, index) => (
                                <button 
                                    data-target={`jornada-${jornada.id}`}
                                    class={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all whitespace-nowrap jornada-tab-btn ${index === 0 ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                                >
                                    Jornada {jornada.numero_jornada}
                                </button>
                            ))}
                         </div>
                    </div>

                    <!-- Match Containers -->
                    <div class="space-y-4 min-h-[400px]">
                        {jornadas.map((jornada, index) => (
                            <div id={`jornada-${jornada.id}`} class={`jornada-container bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden animate-in fade-in duration-300 ${index !== 0 ? 'hidden' : ''}`}>
                                <div class="bg-slate-50/50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                                    <h4 class="font-black text-slate-600 uppercase tracking-widest text-xs flex items-center gap-2">
                                        <span class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded text-[10px]">J{jornada.numero_jornada}</span>
                                        {jornada.nombre_fase || 'Fase Regular'}
                                        <span class="text-slate-300 font-normal mx-2">|</span>
                                        <span class="text-slate-400 font-normal">
                                            {jornada.fecha_inicio ? new Date(jornada.fecha_inicio).toLocaleDateString(undefined, { timeZone: 'UTC' }) : 'Sin fecha'} - {jornada.fecha_fin ? new Date(jornada.fecha_fin).toLocaleDateString(undefined, { timeZone: 'UTC' }) : 'Sin fecha'}
                                        </span>
                                    </h4>
                                    <div class="flex items-center gap-2">
                                        <button 
                                            onclick={`openEditJornadaModal('${jornada.id}', ${jornada.numero_jornada}, '${jornada.nombre_fase || ''}', '${jornada.fecha_inicio || ''}', '${jornada.fecha_fin || ''}')`}
                                            class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-200 transition-colors"
                                            title="Editar jornada"
                                        >
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button 
                                            onclick={`deleteItem('Jornada', '${jornada.id}')`}
                                            class="px-3 py-1.5 text-red-500 hover:bg-red-50 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors"
                                            title="Eliminar jornada"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                                <div class="divide-y divide-slate-50">
                                    {matches.filter((m: Partido) => m.jornada_id === jornada.id).length > 0 ? 
                                        matches.filter((m: Partido) => m.jornada_id === jornada.id).map((match: Partido) => (
                                            <div class="p-4 flex items-center justify-between hover:bg-blue-50/20 transition-colors group">
                                                <div class="flex items-center gap-4 w-full md:w-2/3">
                                                    <div class="text-center w-14 flex-shrink-0">
                                                        {match.fecha_partido ? (
                                                            <>
                                                                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{new Date(match.fecha_partido).toLocaleDateString(undefined, {weekday: 'short'})}</div>
                                                                <div class="text-lg font-black text-slate-900 leading-none">{new Date(match.fecha_partido).getDate()}</div>
                                                                <div class="text-[9px] font-bold text-slate-400 uppercase">{new Date(match.fecha_partido).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                            </>
                                                        ) : (
                                                            <div class="text-[10px] font-black text-slate-300 uppercase tracking-widest leading-tight">Por<br/>Definir</div>
                                                        )}
                                                    </div>
                                                    
                                                    <div class="flex flex-col gap-2 w-full">
                                                        <!-- Local -->
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex items-center gap-3">
                                                                <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center p-0.5">
                                                                     {match.local?.logo_url ? <img src={match.local.logo_url} class="w-full h-full object-contain" /> : <span class="text-[10px] font-black text-slate-300">{match.local?.nombre[0]}</span>}
                                                                </div>
                                                                <span class={`font-bold text-sm ${match.puntos_local > match.puntos_visitante ? 'text-slate-900' : 'text-slate-600'}`}>{match.local?.nombre}</span>
                                                            </div>
                                                            <span class="font-black text-slate-900 text-lg">{match.puntos_local ?? '-'}</span>
                                                        </div>
                                                        <!-- Visitante -->
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex items-center gap-3">
                                                                 <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center p-0.5">
                                                                     {match.visitante?.logo_url ? <img src={match.visitante.logo_url} class="w-full h-full object-contain" /> : <span class="text-[10px] font-black text-slate-300">{match.visitante?.nombre[0]}</span>}
                                                                </div>
                                                                <span class={`font-bold text-sm ${match.puntos_visitante > match.puntos_local ? 'text-slate-900' : 'text-slate-600'}`}>{match.visitante?.nombre}</span>
                                                            </div>
                                                            <span class="font-black text-slate-900 text-lg">{match.puntos_visitante ?? '-'}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="hidden md:flex flex-col items-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onclick={`openEditMatchModal('${match.id}', '${match.equipo_local_id}', '${match.equipo_visitante_id}', '${match.fecha_partido || ''}')`} class="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 w-full text-center">
                                                        ‚öôÔ∏è Editar Partido
                                                    </button>
                                                    <button onclick={`openMatchManager('${match.id}')`} class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-200 w-full text-center">
                                                        üìä Goles y Eventos
                                                    </button>
                                                    <button onclick={`deleteItem('Match', '${match.id}')`} class="px-3 py-1.5 text-red-500 hover:bg-red-50 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors w-full text-center">
                                                        Eliminar
                                                    </button>
                                                </div>
                                            </div>
                                        )) : (
                                        <div class="py-12 flex flex-col items-center justify-center text-center">
                                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
                                                <svg class="w-8 h-8 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                            </div>
                                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">No hay partidos en esta jornada</p>
                                            <button onclick="document.getElementById('new-match-modal').showModal()" class="text-blue-600 font-black uppercase text-[10px] tracking-widest hover:underline">+ Programar Partido</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
             ) : (
                <div class="py-20 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                    <p class="text-slate-400 font-bold mb-4">No hay jornadas creadas</p>
                    <button onclick="document.getElementById('new-jornada-modal').showModal()" class="text-blue-600 font-black uppercase text-xs tracking-widest hover:underline">Crear Primera Jornada</button>
                </div>
             )}
        </div>
    )}

    <!-- EQUIPOS TAB -->
    {tab === 'equipos' && (
        <div class="animate-in fade-in slide-in-from-bottom-2 duration-300 space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Equipos Inscritos</h3>
                <button onclick="document.getElementById('new-team-modal').showModal()" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-slate-800 transition-all">
                    + Inscribir Equipo
                </button>
            </div>
            
            <div class="overflow-x-auto bg-white rounded-2xl border border-slate-100 shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Equipo</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Fecha Registro</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {equipos?.map((equipo: Equipo) => (
                            <tr class="hover:bg-blue-50/50 transition-colors group">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center font-black text-slate-400 text-sm overflow-hidden flex-shrink-0">
                                            {equipo.logo_url ? (
                                                <img src={equipo.logo_url} class="w-full h-full object-cover" alt={equipo.nombre} />
                                            ) : (
                                                equipo.nombre.substring(0, 2).toUpperCase()
                                            )}
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-900 group-hover:text-blue-600 transition-colors">{equipo.nombre}</h4>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ID: {equipo.id.split('-')[0]}...</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex flex-col">
                                        <span class="font-bold text-slate-700 text-sm">{new Date(equipo.creado_at).toLocaleDateString()}</span>
                                        <span class="text-[10px] text-slate-400 font-bold">{new Date(equipo.creado_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <a 
                                            href={`/admin/equipos/${equipo.id}?torneoId=${id}`} 
                                            class="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all flex items-center gap-2"
                                        >
                                            Gestionar
                                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                        </a>
                                        <button 
                                            onclick={`deleteItem('TeamParticipation', '${equipo.id}')`}
                                            class="p-2 bg-white border border-slate-200 text-slate-400 rounded-lg hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all"
                                            title="Desinscribir del torneo"
                                        >
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                        {(!equipos || equipos.length === 0) && (
                             <tr>
                                <td colspan="3" class="px-6 py-12 text-center bg-slate-50/50 border-2 border-dashed border-slate-200 rounded-b-2xl">
                                    <p class="text-slate-400 font-bold mb-2">No hay equipos inscritos</p>
                                    <button onclick="document.getElementById('new-team-modal').showModal()" class="text-blue-600 font-black uppercase text-xs tracking-widest hover:underline">Inscribir Primer Equipo</button>
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    )}

    <!-- NOTICIAS TAB -->
    {tab === 'noticias' && (
        <div class="animate-in fade-in slide-in-from-bottom-2 duration-300 space-y-6">
             <div class="flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-900 uppercase tracking-tighter">Noticias y Anuncios</h3>
                <button onclick="document.getElementById('new-news-modal').showModal()" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-slate-800 transition-all">
                    + Nueva Noticia
                </button>
            </div>
             <div class="grid grid-cols-1 gap-4">
                {noticias?.map((noticia: Noticia) => (
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex gap-6 group hover:border-blue-200 transition-all relative">
                         {noticia.imagen_url && (
                            <div class="w-32 h-24 rounded-2xl bg-slate-100 overflow-hidden flex-shrink-0">
                                <img src={noticia.imagen_url} class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                            </div>
                        )}
                        <div class="flex-1">
                             <div class="flex justify-between items-start">
                                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-lg text-[10px] uppercase font-black tracking-widest mb-2 inline-block">
                                    {new Date(noticia.created_at).toLocaleDateString()}
                                </span>
                                <button onclick={`deleteItem('News', '${noticia.id}')`} class="text-slate-300 hover:text-red-500 transition-colors p-1">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                             </div>
                            <h4 class="font-bold text-lg text-slate-900 leading-tight mb-2">{noticia.titulo}</h4>
                            <p class="text-sm text-slate-500 line-clamp-2">{noticia.contenido}</p>
                        </div>
                    </div>
                ))}
                 {(!noticias || noticias.length === 0) && (
                    <div class="py-20 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                        <p class="text-slate-400 font-bold mb-4">No hay noticias publicadas</p>
                        <button onclick="document.getElementById('new-news-modal').showModal()" class="text-blue-600 font-black uppercase text-xs tracking-widest hover:underline">Crear Primera Noticia</button>
                    </div>
                )}
             </div>
        </div>
    )}

    <!-- ... MODALS ... -->
    <!-- (No changes to modals html, jumping to script where deleteItem is defined) -->
    <!-- I will use a separate replace_file_content for script updates to avoid huge context -->
<script>
// ...
</script>

    <!-- MODALS -->

    <!-- 1. Edit Tournament -->
    <dialog id="edit-tournament-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-lg relative animate-in fade-in zoom-in duration-200 backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-edit" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-edit" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Configurar Torneo</h3>
        <form id="edit-tournament-form" class="space-y-4">
            <input type="hidden" name="id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Nombre</label>
                <input type="text" name="nombre" value={torneo.nombre} required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Descripci√≥n</label>
                <textarea name="descripcion" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-medium text-slate-600 h-24">{torneo.descripcion}</textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Estado</label>
                    <select name="estado" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900">
                        <option value="draft" selected={torneo.estado === 'draft'}>Borrador</option>
                        <option value="activo" selected={torneo.estado === 'activo'}>Activo</option>
                        <option value="finalizado" selected={torneo.estado === 'finalizado'}>Finalizado</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all mt-4">Guardar Cambios</button>
        </form>
    </dialog>

    <!-- 2. New Jornada -->
    <!-- 2. New Jornada -->
    <dialog id="new-jornada-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative animate-in fade-in zoom-in duration-200 backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-jornada" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-jornada" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Nueva Jornada</h3>
        
        <!-- Error Display (In-Modal) -->
        <div id="create-jornada-error" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-2xl animate-in fade-in slide-in-from-top-2 duration-200">
            <p class="text-red-800 font-bold text-sm"></p>
        </div>
        
        <form id="create-jornada-form" class="space-y-4">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">N√∫mero Jornada</label>
                <input type="number" name="numero_jornada" required min="1" value={(jornadas?.length || 0) + 1} class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-black text-xl text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Inicio</label>
                <input 
                    type="date" 
                    name="fecha_inicio" 
                    required 
                    min={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().split('T')[0] : undefined}
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Fin</label>
                <input 
                    type="date" 
                    name="fecha_fin" 
                    required 
                    min={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().split('T')[0] : undefined}
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fase (Opcional)</label>
                <input type="text" name="nombre" placeholder="Ej: Fase de Grupos" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all mt-4">Crear Jornada</button>
        </form>
    </dialog>

    <!-- 3. New Match -->
    <!-- 3. New Match -->
    <dialog id="new-match-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative animate-in fade-in zoom-in duration-200 backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-match" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-match" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Programar Partido</h3>
        
        <!-- Error Display (In-Modal) -->
        <div id="create-match-error" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-2xl animate-in fade-in slide-in-from-top-2 duration-200">
            <p class="text-red-800 font-bold text-sm"></p>
        </div>
        
        <form id="create-match-form" class="space-y-4">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Jornada</label>
                <select name="jornada_id" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900">
                    {jornadas?.map(j => <option value={j.id}>Jornada {j.numero_jornada} - {j.nombre_fase}</option>)}
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha y Hora del Partido</label>
                <input 
                    type="datetime-local" 
                    name="fecha_partido" 
                    required 
                    min={torneo.fecha_inicio ? new Date(torneo.fecha_inicio).toISOString().slice(0, 16) : undefined}
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" 
                />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Local</label>
                <select name="equipo_local_id" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-xs">
                    {equipos?.map(e => <option value={e.id}>{e.nombre}</option>)}
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Visitante</label>
                <select name="equipo_visitante_id" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-xs">
                    {equipos?.map(e => <option value={e.id}>{e.nombre}</option>)}
                </select>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all mt-4">Programar</button>
        </form>
    </dialog>

    <!-- Match Events Manager (React) -->
    <MatchEventsManager client:only="react" />

     <dialog id="new-team-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-team" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-team" class="text-2xl font-black uppercase tracking-tighter mb-8">Inscribir Equipo</h3>
        <form id="register-team-form" class="space-y-6">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Seleccionar Equipo</label>
                <select name="equipo_id" required class="w-full bg-slate-50 border-none px-6 py-5 rounded-2xl font-bold text-slate-900">
                    <option value="">-- Seleccione un equipo --</option>
                    {allTeams?.map(team => (
                        <option value={team.id}>{team.nombre}</option>
                    ))}
                </select>
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold text-xs uppercase tracking-widest">Inscribir</button>
        </form>
        <div class="mt-4 pt-4 border-t border-slate-100 text-center">
            <p class="text-xs text-slate-400 mb-2">¬øNo encuentras el equipo?</p>
            <a href="/admin/equipos" class="text-blue-600 font-bold text-xs uppercase tracking-widest hover:underline">Crear Nuevo Equipo</a>
        </div>
    </dialog>

    <!-- 6. New News -->
    <!-- 6. New News -->
    <dialog id="new-news-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-lg relative focus:outline-none backdrop:bg-slate-900/60" role="dialog" aria-modal="true" aria-labelledby="modal-title-news" tabindex="-1">
        <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-news" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Nueva Noticia</h3>
        <form id="create-news-form" class="space-y-4">
            <input type="hidden" name="torneo_id" value={id} />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">T√≠tulo</label>
                <input type="text" name="titulo" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Contenido</label>
                <textarea name="contenido" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-medium text-slate-600 h-32"></textarea>
            </div>
                <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">URL Imagen (Opcional)</label>
                <input type="url" name="imagen_url" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all mt-4">Publicar</button>
        </form>
    </dialog>

    <!-- Match Result Modal -->
    <dialog id="edit-result-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-sm relative backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-result" tabindex="-1">
        <button onclick="document.getElementById('edit-result-modal').close()" class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-result" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Actualizar Marcador</h3>
        <form id="edit-result-form" class="space-y-6">
            <input type="hidden" name="matchId" id="edit-match-id" />
            
            <div class="flex items-center justify-between gap-4">
                <div class="text-center w-1/2">
                    <label id="edit-label-local" class="block text-xs font-bold text-slate-500 mb-2 truncate">Local</label>
                    <input type="number" name="puntos_local" id="edit-goles-local" min="0" required class="w-full bg-slate-50 border-none rounded-2xl py-4 text-center font-black text-3xl text-slate-900" />
                </div>
                <div class="text-slate-300 font-black text-xl">-</div>
                <div class="text-center w-1/2">
                    <label id="edit-label-visitante" class="block text-xs font-bold text-slate-500 mb-2 truncate">Visitante</label>
                    <input type="number" name="puntos_visitante" id="edit-goles-visitante" min="0" required class="w-full bg-slate-50 border-none rounded-2xl py-4 text-center font-black text-3xl text-slate-900" />
                </div>
            </div>

            <div class="flex items-center gap-3 p-4 bg-blue-50 rounded-2xl border border-blue-100">
                <input type="checkbox" name="finalizar" id="check-finalizar" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300" />
                <label for="check-finalizar" class="text-xs font-bold text-blue-800 uppercase tracking-wide cursor-pointer select-none">
                    Marcador Final (Finalizar Partido)
                </label>
            </div>
            
            <p class="text-[10px] text-slate-400 text-center px-4">
                Si marcas "Finalizar", el ganador avanzar√° autom√°ticamente a la siguiente ronda en torneos de eliminaci√≥n.
            </p>

            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all">
                Guardar Resultado
            </button>
        </form>
    </dialog>

    <!-- Edit Match Modal (Teams & Date) -->
    <dialog id="edit-match-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-8 shadow-2xl w-full max-w-md relative backdrop:bg-slate-900/60 focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="modal-title-edit-match" tabindex="-1">
        <button class="modal-close-btn absolute top-6 right-6 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h4 id="modal-title-edit-match" class="text-xl font-black uppercase tracking-tighter mb-6 pr-10">Editar Partido</h4>
        
        <!-- Error Display -->
        <div id="edit-match-error" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-xl">
            <p class="text-red-600 text-sm font-bold"></p>
        </div>
        
        <form id="edit-match-form" class="space-y-6">
            <input type="hidden" name="id" id="edit-match-id-input" />
            
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Equipo Local</label>
                <select name="equipo_local_id" id="edit-match-local" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-sm">
                    {equipos?.map(e => <option value={e.id}>{e.nombre}</option>)}
                </select>
            </div>
            
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Equipo Visitante</label>
                <select name="equipo_visitante_id" id="edit-match-visitante" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-sm">
                    {equipos?.map(e => <option value={e.id}>{e.nombre}</option>)}
                </select>
            </div>
            
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha y Hora</label>
                <input 
                    type="datetime-local" 
                    name="fecha_partido" 
                    id="edit-match-fecha"
                    class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900 text-sm"
                />
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all">
                Guardar Cambios
            </button>
        </form>
    </dialog>


    <!-- Edit Jornada Modal -->
    <dialog id="edit-jornada-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[3rem] p-10 shadow-2xl w-full max-w-lg relative focus:outline-none backdrop:bg-slate-900/60" role="dialog" aria-modal="true" aria-labelledby="modal-title-edit-jornada" tabindex="-1">
        <button onclick="document.getElementById('edit-jornada-modal').close()" class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <h3 id="modal-title-edit-jornada" class="text-2xl font-black uppercase tracking-tighter mb-8 text-slate-900">Editar Jornada</h3>
        <form id="edit-jornada-form" class="space-y-4">
            <input type="hidden" name="id" id="edit-jornada-id" />
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">N√∫mero de Jornada</label>
                <input type="number" name="numero_jornada" id="edit-numero-jornada" required min="1" class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Nombre de Fase (Opcional)</label>
                <input type="text" name="nombre" id="edit-nombre-fase" placeholder="Ej: Fase Regular, Playoffs, etc." class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Inicio</label>
                    <input type="date" name="fecha_inicio" id="edit-fecha-inicio" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-4">Fecha Fin</label>
                    <input type="date" name="fecha_fin" id="edit-fecha-fin" required class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl font-bold text-slate-900" />
                </div>
            </div>
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mt-4">
                <p class="text-xs text-amber-800 font-medium">
                    ‚ö†Ô∏è <strong>Nota:</strong> Si hay partidos programados en esta jornada, aseg√∫rate de que las nuevas fechas sigan siendo v√°lidas para ellos.
                </p>
            </div>
            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:scale-[1.02] transition-all mt-4">Guardar Cambios</button>
        </form>
    </dialog>


  </div>

  <script define:vars={{ jornadasJSON: JSON.stringify(jornadas.map(j => ({ id: j.id, fecha_inicio: j.fecha_inicio || null, fecha_fin: j.fecha_fin || null }))), torneoInicio: torneo.fecha_inicio }}>
    // Dynamic fecha_partido validation based on selected jornada
    const jornadaSelectMatch = document.querySelector('#create-match-form select[name="jornada_id"]');
    const fechaPartidoInput = document.querySelector('#create-match-form input[name="fecha_partido"]');

    if (jornadaSelectMatch && fechaPartidoInput) {
        // Map jornada IDs to their date ranges
        const jornadasData = new Map();
        
        // Populate map from server data
        const jornadasArray = JSON.parse(jornadasJSON);
        
        jornadasArray.forEach((jornada) => {
            jornadasData.set(jornada.id, {
                fecha_inicio: jornada.fecha_inicio,
                fecha_fin: jornada.fecha_fin
            });
        });

        const updateFechaPartidoLimits = () => {
            const selectedJornadaId = jornadaSelectMatch.value;
            const jornadaInfo = jornadasData.get(selectedJornadaId);

            if (jornadaInfo && jornadaInfo.fecha_inicio && jornadaInfo.fecha_fin) {
                // Set min to start of fecha_inicio (00:00)
                const minDate = new Date(jornadaInfo.fecha_inicio);
                fechaPartidoInput.min = minDate.toISOString().slice(0, 16);

                // Set max to end of fecha_fin (23:59)
                const maxDate = new Date(jornadaInfo.fecha_fin);
                maxDate.setHours(23, 59);
                fechaPartidoInput.max = maxDate.toISOString().slice(0, 16);
            } else {
                // If jornada has no dates, fall back to tournament start date
                if (torneoInicio) {
                    fechaPartidoInput.min = new Date(torneoInicio).toISOString().slice(0, 16);
                }
                fechaPartidoInput.removeAttribute('max');
            }
        };

        // Update on jornada selection change
        jornadaSelectMatch.addEventListener('change', updateFechaPartidoLimits);
        
        // Set initial limits when modal opens
        const newMatchModal = document.getElementById('new-match-modal');
        if (newMatchModal) {
            newMatchModal.addEventListener('click', (e) => {
                if (e.target.id === 'new-match-modal') return; // Ignore backdrop clicks
                setTimeout(updateFechaPartidoLimits, 50);
            });
        }

        // Also update when the "Programar Partido" button is clicked
        const openMatchModalBtns = document.querySelectorAll('button[onclick*="new-match-modal"]');
        openMatchModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setTimeout(updateFechaPartidoLimits, 100);
            });
        });
    }
  </script>

  <script>
    import { actions } from 'astro:actions';

    declare global {
        interface Window {
            openEditResultModal: (matchId: string, localName: string, visitanteName: string, gLocal: number, gVisitante: number) => void;
            deleteItem: (type: string, id: string) => Promise<void>;
            closeModal: (id: string) => void;
            showToast: (message: string, type?: 'success' | 'error') => void;
            showConfirm: (title: string, message: string, onConfirm: () => void) => void;
        }
    }

    // Show success messages from URL params (after page reload)
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const msg = urlParams.get('msg');
        const type = urlParams.get('type') as 'success' | 'error' | null;

        if (msg && type && typeof window.showToast === 'function') {
           window.showToast(msg, type);
            // Clean URL
            const newUrl = window.location.pathname + window.location.search.replace(/[?&](msg|type)=[^&]*/g, '').replace(/^&/, '?').replace(/\?$/, '');
            window.history.replaceState({}, '', newUrl || window.location.pathname);
        }
    });

    // Helpers
    window.openEditResultModal = (matchId: string, localName: string, visitanteName: string, gLocal: number, gVisitante: number) => {
        (document.getElementById('edit-match-id') as HTMLInputElement).value = matchId;
        (document.getElementById('edit-label-local') as HTMLElement).textContent = localName;
        (document.getElementById('edit-label-visitante') as HTMLElement).textContent = visitanteName;
        (document.getElementById('edit-goles-local') as HTMLInputElement).value = gLocal.toString();
        (document.getElementById('edit-goles-visitante') as HTMLInputElement).value = gVisitante.toString();
        (document.getElementById('edit-result-modal') as HTMLDialogElement).showModal();
    };


    window.deleteItem = async (type: string, id: string) => {
        const typeLabel = type === 'Match' ? 'partido' : 'noticia';
        
        window.showConfirm(
            `Eliminar ${typeLabel}`,
            `¬øEst√°s seguro de que deseas eliminar ${type === 'Match' ? 'este partido' : 'esta noticia'}? Esta acci√≥n no se puede deshacer.`,
            async () => {
                const fd = new FormData();
                fd.append('id', id);

                let result;
                if (type === 'Match') result = await actions.deleteMatch(fd);
                else if (type === 'News') result = await actions.deleteNews(fd);
                
                if (result?.error) {
                   window.showToast(result.error.message, 'error');
                } else {
                    // Success: redirect with message
                    const successMsg = type === 'Match' ? 'Partido eliminado correctamente' : 'Noticia eliminada correctamente';
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('msg', successMsg);
                    currentUrl.searchParams.set('type', 'success');
                    window.location.href = currentUrl.toString();
                }
            }
        );
    };

    window.closeModal = (id: string) => {
        const dialog = document.getElementById(id) as HTMLDialogElement;
        if (dialog) dialog.close();
    };

    // Generic Form Handler with In-Modal Error Display
    const handleForm = (formId: string, actionName: string, errorDivId?: string, successMsg?: string) => {
        const form = document.getElementById(formId) as HTMLFormElement;
        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            
            // Clear previous errors
            if (errorDivId) {
                const errorDiv = document.getElementById(errorDivId);
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                    const errorText = errorDiv.querySelector('p');
                    if (errorText) errorText.textContent = '';
                }
            }
            
            // Validation override for same team
            if (formId === 'create-match-form' && formData.get('equipo_local_id') === formData.get('equipo_visitante_id')) {
                if (errorDivId) {
                    const errorDiv = document.getElementById(errorDivId);
                    if (errorDiv) {
                        const errorText = errorDiv.querySelector('p');
                        if (errorText) errorText.textContent = 'Los equipos deben ser diferentes';
                        errorDiv.classList.remove('hidden');
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
               window.showToast('Equipos deben ser diferentes', 'error');
                return;
            }

            // Type safe action call
            const action = (actions as any)[actionName];
            const { error } = await action(formData);

            if (error) {
                // Show error in modal if errorDivId provided
                if (errorDivId) {
                    const errorDiv = document.getElementById(errorDivId);
                    if (errorDiv) {
                        const errorText = errorDiv.querySelector('p');
                        if (errorText) errorText.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                // Also show toast for redundancy
               window.showToast(error.message, 'error');
            } else {
                // Success: redirect with message if provided
                if (successMsg) {
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('msg', successMsg);
                    currentUrl.searchParams.set('type', 'success');
                    window.location.href = currentUrl.toString();
                } else {
                    window.location.reload();
                }
            }
        });
    };

    handleForm('edit-tournament-form', 'updateTournament', undefined, 'Torneo actualizado correctamente');
    handleForm('create-jornada-form', 'createJornada', 'create-jornada-error', 'Jornada creada correctamente');
    handleForm('register-team-form', 'registerTeamInTournament', undefined, 'Equipo inscrito correctamente');
    handleForm('create-match-form', 'createMatch', 'create-match-error', 'Partido programado correctamente');
    handleForm('create-news-form', 'createNews', undefined, 'Noticia publicada correctamente');
    
    // Result form manual handle for data matching
    const resultForm = document.getElementById('edit-result-form') as HTMLFormElement;
    resultForm?.addEventListener('submit', async(e) => {
        e.preventDefault();
        const fd = new FormData(resultForm);
        
        // Manually construct the data to ensure correct types
        const matchId = fd.get('matchId') as string;
        const puntosLocal = parseInt(fd.get('puntos_local') as string, 10);
        const puntosVisitante = parseInt(fd.get('puntos_visitante') as string, 10);
        
        const finalizar = (document.getElementById('check-finalizar') as HTMLInputElement).checked;
        
        console.log('Submitting match result:', { matchId, puntosLocal, puntosVisitante, finalizar });
        
        // Create new FormData with correct values
        const formData = new FormData();
        formData.append('id', matchId);
        formData.append('puntos_local', puntosLocal.toString());
        formData.append('puntos_visitante', puntosVisitante.toString());
        if (finalizar) formData.append('finalizar', 'true');
        
        try {
            const { error } = await actions.updateMatchResult(formData);
            if (error) {
                console.error('Action error:', error);
                window.showToast(error.message, 'error');
            } else {
                // Success with Message
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('msg', 'Marcador actualizado correctamente');
                currentUrl.searchParams.set('type', 'success');
                window.location.href = currentUrl.toString();
            }
        } catch (err: any) {
            console.error('Caught error:', err);
            window.showToast(err.message || 'Error al actualizar marcador', 'error');
        }
    });

    // Edit Match form handler
    const editMatchForm = document.getElementById('edit-match-form') as HTMLFormElement;
    editMatchForm?.addEventListener('submit', async(e) => {
        e.preventDefault();
        const formData = new FormData(editMatchForm);
        
        // Clear previous errors
        const errorDiv = document.getElementById('edit-match-error');
        if (errorDiv) {
            errorDiv.classList.add('hidden');
            const errorText = errorDiv.querySelector('p');
            if (errorText) errorText.textContent = '';
        }
        
        // Client-side validation
        if (formData.get('equipo_local_id') === formData.get('equipo_visitante_id')) {
            if (errorDiv) {
                const errorText = errorDiv.querySelector('p');
                if (errorText) errorText.textContent = 'Los equipos deben ser diferentes';
                errorDiv.classList.remove('hidden');
            }
            window.showToast('Los equipos deben ser diferentes', 'error');
            return;
        }
        
        const { error } = await actions.updateMatch(formData);
        if (error) {
            if (errorDiv) {
                const errorText = errorDiv.querySelector('p');
                if (errorText) errorText.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
            window.showToast(error.message, 'error');
        } else {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('msg', 'Partido actualizado correctamente');
            currentUrl.searchParams.set('type', 'success');
            window.location.href = currentUrl.toString();
        }
    });

    // Open Edit Match Modal function
    window.openEditMatchModal = (matchId: string, localId: string, visitanteId: string, fecha: string) => {
        (document.getElementById('edit-match-id-input') as HTMLInputElement).value = matchId;
        (document.getElementById('edit-match-local') as HTMLSelectElement).value = localId;
        (document.getElementById('edit-match-visitante') as HTMLSelectElement).value = visitanteId;
        
        if (fecha) {
            // Convert to datetime-local format
            const fechaInput = document.getElementById('edit-match-fecha') as HTMLInputElement;
            if (fechaInput) {
                fechaInput.value = new Date(fecha).toISOString().slice(0, 16);
            }
        }
        
        (document.getElementById('edit-match-modal') as HTMLDialogElement).showModal();
    };



    // Generic Modal Close Logic
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const dialog = btn.closest('dialog');
            if (dialog) {
                // Clear any error messages in this modal before closing
                const errorDivs = dialog.querySelectorAll('[id$="-error"]');
                errorDivs.forEach(div => {
                    div.classList.add('hidden');
                    const errorText = div.querySelector('p');
                    if (errorText) errorText.textContent = '';
                });
                dialog.close();
            }
        });
    });

    // Close on backdrop click
    document.querySelectorAll('dialog').forEach(dialog => {
        dialog.addEventListener('click', (e) => {
            const rect = dialog.getBoundingClientRect();
            const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
              rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
            if (!isInDialog) {
                // Clear errors before closing
                const errorDivs = dialog.querySelectorAll('[id$="-error"]');
                errorDivs.forEach(div => {
                    div.classList.add('hidden');
                    const errorText = div.querySelector('p');
                    if (errorText) errorText.textContent = '';
                });
                dialog.close();
            }
        });
    });

    // Automatic Fixture Generation Handler
    const generateFixtureBtn = document.getElementById('generate-fixture-btn') as HTMLButtonElement | null;
    if (generateFixtureBtn) {
        generateFixtureBtn.addEventListener('click', async () => {
            const torneoTipo = generateFixtureBtn.dataset.tipo;
            const torneoNombre = generateFixtureBtn.dataset.nombre;
            const torneoId = generateFixtureBtn.dataset.id;
            
            const confirmMsg = torneoTipo === 'liga' 
                ? `¬øGenerar fixture autom√°tico para "${torneoNombre}"?\n\nSe crear√°n todas las jornadas y partidos del torneo tipo Liga (Round-Robin).`
                : `¬øGenerar fixture autom√°tico para "${torneoNombre}"?\n\nSe crear√° el bracket de eliminaci√≥n simple con todos los partidos.`;
            
            window.showConfirm(
                'Generar Fixture Autom√°tico',
                confirmMsg,
                async () => {
                    try {
                        // Show loading state
                        generateFixtureBtn.disabled = true;
                        generateFixtureBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...';
                        
                        const response = await fetch(`/api/generate-fixture/${torneoId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                action: torneoTipo === 'liga' ? 'round-robin' : 'single-elimination'
                            })
                        });
                        
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            window.location.reload();
                        } else {
                            let errorMsg = 'Error al generar fixture';
                            try {
                                const errorData = await response.json();
                                if (errorData.message) errorMsg = errorData.message;
                            } catch (e) {
                                console.error('No se pudo parsear el error', e);
                            }
                            throw new Error(errorMsg);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        generateFixtureBtn.disabled = false;
                        generateFixtureBtn.innerHTML = '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Generar Fixture Autom√°tico';
                        if (typeof window.showToast === 'function') {
                            window.showToast('Error al generar fixture. Por favor, intenta nuevamente.', 'error');
                        } else {
                            console.error('Error al generar fixture.');
                        }
                    }
                }
            );
        });
    }

    // Delete All Jornadas Handler
    const deleteAllBtn = document.getElementById('delete-all-jornadas-btn') as HTMLButtonElement | null;
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async () => {
            const torneoId = deleteAllBtn.dataset.id;
            
            window.showConfirm(
                'Eliminar Todas las Jornadas',
                '¬øEst√°s seguro de eliminar TODAS las jornadas y partidos? Esta acci√≥n no se puede deshacer.',
                async () => {
                    try {
                        deleteAllBtn.disabled = true;
                        deleteAllBtn.textContent = '‚è≥ Eliminando...';
                        
                        const response = await fetch(`/api/delete-all-jornadas/${torneoId}`, {
                            method: 'POST'
                        });
                        
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            window.location.reload();
                        } else {
                            throw new Error('Error al eliminar jornadas');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        deleteAllBtn.disabled = false;
                        deleteAllBtn.textContent = 'üóëÔ∏è Eliminar Todas';
                        if (typeof window.showToast === 'function') {
                            window.showToast('Error al eliminar jornadas. Por favor, intenta nuevamente.', 'error');
                        } else {
                            console.error('Error al eliminar jornadas.');
                        }
                    }
                }
            );
        })
    }

    // Edit Jornada Modal Logic
    function openEditJornadaModal(id: string, numeroJornada: number, nombreFase: string, fechaInicio: string, fechaFin: string) {
        const modal = document.getElementById('edit-jornada-modal') as HTMLDialogElement;
        const form = document.getElementById('edit-jornada-form') as HTMLFormElement;
        
        if (!modal || !form) return;

        // Populate form
        (document.getElementById('edit-jornada-id') as HTMLInputElement).value = id;
        (document.getElementById('edit-numero-jornada') as HTMLInputElement).value = numeroJornada.toString();
        (document.getElementById('edit-nombre-fase') as HTMLInputElement).value = nombreFase;
        (document.getElementById('edit-fecha-inicio') as HTMLInputElement).value = fechaInicio;
        (document.getElementById('edit-fecha-fin') as HTMLInputElement).value = fechaFin;

        modal.showModal();
    }

    async function handleEditJornada(e: Event) {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
        const modal = document.getElementById('edit-jornada-modal') as HTMLDialogElement;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';

        try {
            const result = await actions.updateJornada(formData);

            if (result.data) {
                // Redirect with success message
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('msg', 'Jornada actualizada correctamente');
                currentUrl.searchParams.set('type', 'success');
                window.location.href = currentUrl.toString();
                
            } else if (result.error) {
                throw new Error(result.error.message);
            }
        } catch (error) {
            console.error('Error:', error);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Guardar Cambios';
            
            // For errors while modal is open, we try to show toast.
            // Note: If modal is Top Layer, toast might be behind.
            if (typeof window.showToast === 'function') {
                window.showToast(error instanceof Error ? error.message : 'Error al actualizar jornada', 'error');
            } else {
                console.error('Error al actualizar jornada:', error);
            }
        }
    }

    async function deleteItem(type: string, id: string) {
        let title = 'Eliminar Elemento';
        let message = '¬øEst√°s seguro de eliminar este elemento?';

        if (type === 'Jornada') {
            title = 'Eliminar Jornada';
            message = '¬øEst√°s seguro de eliminar esta jornada? Esta acci√≥n es irreversible y no se puede deshacer.';
        } else if (type === 'Match') {
            title = 'Eliminar Partido';
            message = '¬øEst√°s seguro de eliminar este partido?';
        } else if (type === 'News') {
            title = 'Eliminar Noticia';
            message = '¬øEst√°s seguro de eliminar esta noticia?';
        } else if (type === 'TeamParticipation') {
            title = 'Desinscribir Equipo';
            message = '¬øEst√°s seguro de desinscribir a este equipo del torneo? Si el equipo ya tiene partidos programados, la acci√≥n fallar√°.';
        }
        
        window.showConfirm(title, message, async () => {
            await performDelete(type, id);
        });
    }

    async function performDelete(type: string, id: string) {
        try {
            if (type === 'Jornada') {
                const formData = new FormData();
                formData.append('id', id);
                const result = await actions.deleteJornada(formData);
                
                if (result.data) {
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('msg', 'Jornada eliminada correctamente');
                    currentUrl.searchParams.set('type', 'success');
                    window.location.href = currentUrl.toString();
                } else if (result.error) {
                    throw new Error(result.error.message);
                }
            } else if (type === 'Match') {
                const formData = new FormData();
                formData.append('id', id);
                const result = await actions.deleteMatch(formData);
                
                if (result.data) {
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('msg', 'Partido eliminado correctamente');
                    currentUrl.searchParams.set('type', 'success');
                    window.location.href = currentUrl.toString();
                } else if (result.error) {
                    throw new Error(result.error.message);
                }
            } else if (type === 'News') {
                const formData = new FormData();
                formData.append('id', id);
                const result = await actions.deleteNews(formData);
                
                if (result.data) {
                     if (typeof window.showToast === 'function') {
                        window.showToast('Noticia eliminada correctamente', 'success');
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else if (result.error) {
                     throw new Error(result.error.message);
                }
            } else if (type === 'TeamParticipation') {
                // Get torneo_id from URL
                const urlParts = window.location.pathname.split('/');
                const torneoId = urlParts[urlParts.length - 1]; // Robust enough for now

                const formData = new FormData();
                formData.append('torneo_id', torneoId);
                formData.append('equipo_id', id);

                const result = await actions.unregisterTeamFromTournament(formData);
                
                if (result.data) {
                    if (typeof window.showToast === 'function') {
                        window.showToast('Equipo desinscrito correctamente', 'success');
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else if (result.error) {
                    throw new Error(result.error.message);
                }
            }
        } catch (error) {
            console.error('Error:', error);
            if (typeof window.showToast === 'function') {
                window.showToast(error instanceof Error ? error.message : 'Error al eliminar', 'error');
            } else {
                console.error('Error al eliminar:', error);
            }
        }
    }

    // Make functions global
    (window as any).openEditJornadaModal = openEditJornadaModal;
    (window as any).deleteItem = deleteItem;

    // Handle edit jornada form submission
    const editJornadaForm = document.getElementById('edit-jornada-form');
    if (editJornadaForm) {
        editJornadaForm.addEventListener('submit', handleEditJornada);
    }

    // Matchday Tabs Logic
    const tabBtns = document.querySelectorAll('.jornada-tab-btn');
    const containers = document.querySelectorAll('.jornada-container');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // 1. Reset all buttons
            tabBtns.forEach(b => {
                b.classList.remove('bg-slate-900', 'text-white', 'shadow-lg');
                b.classList.add('bg-slate-50', 'text-slate-400', 'hover:bg-slate-100');
            });

            // 2. Activate clicked button
            btn.classList.remove('bg-slate-50', 'text-slate-400', 'hover:bg-slate-100');
            btn.classList.add('bg-slate-900', 'text-white', 'shadow-lg');

            // 3. Show target container
            const targetId = (btn as HTMLElement).dataset.target;
            containers.forEach(container => {
                if (container.id === targetId) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });
            
            // 4. Smooth scroll to container top if needed (optional)
            // document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    // Match Events Manager Logic
    window.openMatchManager = (matchId) => {
        const { matches, allEvents, allPlayers } = window.MATCH_DATA;
        const match = matches.find(m => m.id === matchId);
        if (!match) return;
        
        const events = allEvents.filter(e => e.partido_id === matchId);
        
        // Dispatch event to open React modal
        window.dispatchEvent(new CustomEvent('open-match-manager', {
            detail: { match, events, allPlayers }
        }));
    };

    (window as any).openMatchManager = window.openMatchManager;

  </script>

  <script define:vars={{ matches, allEvents, allPlayers }}>
     window.MATCH_DATA = { matches, allEvents, allPlayers };
  </script>
  
</AdminSidebarLayout>
