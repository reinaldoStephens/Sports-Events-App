---
import AdminSidebarLayout from '../../layouts/AdminSidebarLayout.astro';
import { supabase } from '../../lib/supabase';
import { actions } from 'astro:actions';
import ToastNotification from '../../components/ToastNotification.astro';

// Fetch tournaments
const { data: torneos } = await supabase
  .from('torneos')
  .select('*')
  .order('creado_at', { ascending: false });

// Consulta rápida para contar equipos sin traer todos sus datos
const { count: totalEquipos } = await supabase
  .from('equipos')
  .select('*', { count: 'exact', head: true });

const { data: deportes } = await supabase
  .from('deportes')
  .select('id, nombre')
  .order('nombre', { ascending: true });

// Buscamos el objeto del deporte fútbol en el array
const deporteFutbol = deportes?.find(d => 
  d.nombre.toLowerCase().includes('fútbol') || 
  d.nombre.toLowerCase().includes('futbol')
);

const createResult = Astro.getActionResult(actions.createTournament);
---

<AdminSidebarLayout title="Dashboard de Torneos">
  <div class="space-y-12 relative">
    <!-- Background Decor -->
    <div class="absolute -top-20 -right-20 w-80 h-80 bg-blue-500/5 rounded-full blur-[100px] pointer-events-none"></div>
    <div class="absolute top-1/2 left-1/4 w-60 h-60 bg-indigo-500/5 rounded-full blur-[80px] pointer-events-none"></div>

    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 relative z-10">
      <div>
        <div class="flex items-center gap-2 mb-2 text-blue-600">
            <span class="w-8 h-1 bg-blue-600 rounded-full"></span>
            <span class="text-[10px] font-black uppercase tracking-[0.2em]">Centro de Control</span>
        </div>
        <h2 class="text-5xl font-black text-slate-900 tracking-tighter uppercase leading-none">Dashboard</h2>
        <p class="text-slate-400 font-medium mt-2 text-lg">Bienvenido al panel de administración oficial.</p>
      </div>
      
      <button
        onclick="document.getElementById('new-tournament-modal').showModal()"
        class="group relative bg-slate-900 text-white px-10 py-5 rounded-3xl font-black uppercase tracking-widest text-xs transition-all hover:bg-slate-800 active:scale-95 shadow-2xl shadow-slate-900/20 overflow-hidden"
      >
        <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        <div class="relative flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
            </svg>
            <span>Nuevo Torneo</span>
        </div>
      </button>
    </div>

    <!-- Tournaments List Section -->
    <div class="space-y-8 relative z-10">
      <div class="flex items-center justify-between">
          <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tight">Gestión de Torneos</h3>
          <div class="flex items-center gap-2 text-xs font-bold text-slate-400">
              <span class="w-2 h-2 rounded-full bg-blue-500"></span>
              {torneos?.length || 0} Registrados
          </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {torneos && torneos.length > 0 ? torneos.map((torneo) => (
          <a
            href={`/admin/torneo/${torneo.id}`}
            class="group bg-white rounded-[3rem] border border-slate-100 shadow-sm hover:shadow-2xl hover:-translate-y-3 transition-all duration-500 overflow-hidden flex flex-col"
          >
            <!-- Image / Header -->
            <div class="h-56 bg-slate-100 relative overflow-hidden">
              {torneo.imagen_portada ? (
                  <img src={torneo.imagen_portada} alt={torneo.nombre} class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />
              ) : (
                  <div class="w-full h-full bg-gradient-to-br from-slate-800 to-slate-950 flex items-center justify-center">
                      <div class="text-slate-700 font-black text-8xl opacity-10 uppercase tracking-tighter">{torneo.nombre[0]}</div>
                  </div>
              )}
              <div class="absolute inset-0 bg-gradient-to-t from-slate-950/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              
              <div class="absolute bottom-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-500 translate-y-4 group-hover:translate-y-0">
                  <span class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg">Gestionar Ahora</span>
              </div>
            </div>

            <!-- Content -->
            <div class="p-8 flex-1 flex flex-col">
              <div class="flex items-center gap-2 mb-4">
                  <span class={`w-2 h-2 rounded-full ${new Date(torneo.fecha_fin) >= new Date() ? 'bg-emerald-500' : 'bg-slate-300'}`}></span>
                  <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">
                    {new Date(torneo.fecha_fin) >= new Date() ? 'Activo' : 'Finalizado'}
                  </span>
              </div>

              <div class="flex items-start justify-between mb-4">
                  <h3 class="text-2xl font-black text-slate-900 truncate group-hover:text-blue-600 transition-colors uppercase tracking-tighter leading-tight flex-1" title={torneo.nombre}>
                    {torneo.nombre}
                  </h3>
                  <button 
                    type="button"
                    class="btn-delete-tournament text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-xl transition-all"
                    data-id={torneo.id}
                    data-nombre={torneo.nombre}
                    title="Eliminar Torneo"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
              </div>

              <div class="mt-auto pt-6 border-t border-slate-50 flex items-center justify-between text-slate-400">
                 <div class="flex items-center gap-2 text-xs font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>{new Date(torneo.fecha_inicio).getFullYear()}</span>
                 </div>
                 <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-all transform group-hover:rotate-45">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                 </div>
              </div>
            </div>
          </a>
        )) : (
          <div class="col-span-full py-32 text-center bg-white rounded-[4rem] border-4 border-dashed border-slate-100 overflow-hidden relative group">
              <div class="absolute inset-0 bg-blue-50/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <div class="relative z-10 max-w-sm mx-auto">
                  <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                  </div>
                  <h3 class="text-3xl font-black text-slate-900 uppercase tracking-tighter mb-4">No hay torneos</h3>
                  <p class="text-slate-400 font-medium mb-10 leading-relaxed">Tu panel está vacío por ahora. Crea un torneo para comenzar a gestionar equipos y atletas.</p>
                  <button
                      onclick="document.getElementById('new-tournament-modal').showModal()"
                      class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase tracking-widest text-[10px] hover:bg-blue-700 transition-all active:scale-95 shadow-xl shadow-blue-600/20"
                  >
                      Crear Primer Torneo
                  </button>
              </div>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- New Tournament Modal -->
  <dialog 
    id="new-tournament-modal" 
    class="fixed inset-0 z-50 m-auto w-[calc(100%-2rem)] max-w-lg bg-transparent backdrop:bg-slate-900/60 backdrop:backdrop-blur-sm open:flex open:items-center open:justify-center"
  >
    <div class="bg-white rounded-[3rem] shadow-2xl p-10 border border-slate-100 relative overflow-hidden w-full">
      <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-50 rounded-full blur-3xl opacity-50"></div>
      
      <button 
        type="button"
        onclick="document.getElementById('new-tournament-modal').close()" 
        class="absolute top-8 right-8 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 hover:text-slate-600 transition-all z-50"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <div class="relative z-10 mb-8">
        <div class="flex items-center gap-2 mb-2 text-blue-600">
          <span class="w-6 h-1 bg-blue-600 rounded-full"></span>
          <span class="text-[10px] font-black uppercase tracking-[0.2em]">Nueva Competición</span>
        </div>
        <h3 class="text-3xl font-black text-slate-900 tracking-tight uppercase">Crear Torneo</h3>
        <p class="text-slate-500 font-medium text-sm">Configura los parámetros base de la liga o copa.</p>
      </div>

      <form id="create-tournament-form" class="space-y-5 relative z-10">
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Nombre del Torneo</label>
          <input 
            type="text" 
            name="nombre" 
            required 
            placeholder="Ej: Copa Diamante 2026" 
            class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl text-slate-900 font-bold placeholder:text-slate-300 focus:ring-4 focus:ring-blue-500/10 transition-all"
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Formato</label>
            <div class="relative">
              <select 
                name="tipo" 
                required 
                class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl text-slate-900 font-bold focus:ring-4 focus:ring-blue-500/10 transition-all appearance-none cursor-pointer"
              >
                <option value="liga">Liga</option>
                <option value="eliminacion_simple">Eliminación</option>
                <option value="grupos_eliminacion">Grupos + Playoff</option>
              </select>
              <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>

          <div>
    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Deporte</label>
    <div class="relative">
      <select 
        name="deporte_id" 
        required 
        class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl text-slate-900 font-bold focus:ring-4 focus:ring-blue-500/10 transition-all appearance-none cursor-pointer"
      >
        <option value="" disabled>Seleccionar deporte...</option>
        
        {deportes?.map((deporte) => (
          <option 
            value={deporte.id} 
            selected={deporte.id === deporteFutbol?.id}
          >
            {deporte.nombre}
          </option>
        ))}
      </select>
      
      <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-slate-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>
  </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Fecha Inicio</label>
            <input 
              type="date" 
              name="fecha_inicio" 
              required 
              class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl text-slate-900 font-bold focus:ring-4 focus:ring-blue-500/10 transition-all"
            />
          </div>
          <div>
            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Fecha Fin</label>
            <input 
              type="date" 
              name="fecha_fin" 
              required 
              class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl text-slate-900 font-bold focus:ring-4 focus:ring-blue-500/10 transition-all"
            />
          </div>
        </div>

        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Imagen de Portada (URL)</label>
          <input 
            type="url" 
            name="imagen_portada" 
            placeholder="https://images.unsplash.com/foto-de-futbol" 
            class="w-full bg-slate-50 border-none px-6 py-4 rounded-2xl text-slate-900 font-bold placeholder:text-slate-300 focus:ring-4 focus:ring-blue-500/10 transition-all"
          />
        </div>

        <!-- Playoff Configuration (Only for Grupos + Playoff) -->
        <div id="playoff-config-section" class="hidden border-t-2 border-slate-100 pt-6 space-y-4">
          <div class="flex items-center gap-2 mb-3">
            <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h4 class="text-sm font-black text-slate-700 uppercase tracking-wide">Configuración de Playoffs</h4>
          </div>

          <!-- Two-Legged Ties Toggle -->
          <div class="bg-blue-50 border border-blue-100 rounded-2xl p-4">
            <label class="flex items-start gap-3 cursor-pointer group">
              <input 
                type="checkbox" 
                name="usa_ida_vuelta" 
                id="usa-ida-vuelta-checkbox"
                class="mt-1 w-5 h-5 rounded border-blue-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
              />
              <div class="flex-1">
                <span class="text-sm font-bold text-slate-900 group-hover:text-blue-600 transition-colors">Usar Partidos de Ida y Vuelta</span>
                <p class="text-xs text-slate-600 mt-1">Los playoffs se jugarán con formato profesional (local-visitante)</p>
              </div>
            </label>
          </div>

          <!-- Phase Selection (Only shown when two-legged is enabled) -->
          <div id="phases-selection" class="hidden space-y-3 pl-8 border-l-2 border-blue-200">
            <p class="text-xs font-semibold text-slate-600 mb-2">Selecciona las fases que usarán ida y vuelta:</p>
            
            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="checkbox" 
                name="fase_cuartos" 
                value="quarterfinals"
                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                checked
              />
              <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600 transition-colors">Cuartos de Final</span>
            </label>

            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="checkbox" 
                name="fase_semis" 
                value="semifinals"
                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                checked
              />
              <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600 transition-colors">Semifinales</span>
            </label>

            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="checkbox" 
                name="fase_final" 
                value="final"
                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
              />
              <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600 transition-colors">Final</span>
            </label>
          </div>

          <!-- Additional Options -->
          <div class="space-y-3 bg-slate-50 rounded-2xl p-4">
            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="checkbox" 
                name="usa_gol_visitante" 
                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
              />
              <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600 transition-colors">Regla de gol de visitante</span>
            </label>

            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="checkbox" 
                name="penales_si_empate" 
                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                checked
              />
              <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600 transition-colors">Penales si empata en agregado</span>
            </label>
          </div>
        </div>

        <button 
          type="submit" 
          class="group relative w-full bg-slate-900 text-white py-5 rounded-3xl font-black uppercase tracking-widest text-[10px] transition-all hover:bg-blue-600 active:scale-95 shadow-xl shadow-slate-900/10 overflow-hidden"
        >
          <span class="relative z-10 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
            </svg>
            Confirmar y Publicar
          </span>
        </button>
      </form>
    </div>
  </dialog>

  <style>
    /* Animación suave para el modal */
    dialog[open] {
      animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    dialog::backdrop {
      animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Quitar el borde nativo de dialog */
    dialog { border: none; }
  </style>

  <ToastNotification />

  <script>
    import { actions } from 'astro:actions';
    
    // --- Create Tournament Logic ---
    const form = document.getElementById('create-tournament-form') as HTMLFormElement;
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      submitBtn.disabled = true;
      const originalText = submitBtn.innerText;
      submitBtn.innerText = 'Procesando...';

      const { error } = await actions.createTournament(formData);
      
      if (error) {
        window.showToast('Error: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
      } else {
        // Redirect with success message to show toast after reload
        const url = new URL(window.location.href);
        url.searchParams.set('msg', '¡Torneo creado exitosamente!');
        url.searchParams.set('type', 'success');
        window.location.href = url.toString();
      }
    });

    // --- Delete Tournament Logic ---
    document.querySelectorAll('.btn-delete-tournament').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation(); // Prevent card click
        
        const id = (btn as HTMLElement).dataset.id;
        const nombre = (btn as HTMLElement).dataset.nombre;
        
        window.showConfirm(
          'Eliminar Torneo',
          `¿Estás seguro de que deseas eliminar permanentemente el torneo "${nombre}"?\n\nEsta acción eliminará todos los equipos, partidos y estadísticas asociados. NO SE PUEDE DESHACER.`,
          async () => {
            const formData = new FormData();
            formData.append('id', id!);

            try {
                const { error } = await actions.deleteTournament(formData);
                
                if (error) {
                    window.showToast('Error al eliminar: ' + error.message, 'error');
                } else {
                    // Redirect with success message
                    const url = new URL(window.location.href);
                    url.searchParams.set('msg', 'Torneo eliminado correctamente');
                    url.searchParams.set('type', 'success');
                    window.location.href = url.toString();
                }
            } catch (err) {
                window.showToast('Error inesperado al eliminar', 'error');
                console.error(err);
            }
          }
        );
      });
    });

    // --- Playoff Configuration Toggle ---
    const tipoSelect = document.querySelector('select[name="tipo"]') as HTMLSelectElement;
    const playoffSection = document.getElementById('playoff-config-section');
    const usaIdaVueltaCheckbox = document.getElementById('usa-ida-vuelta-checkbox') as HTMLInputElement;
    const phasesSelection = document.getElementById('phases-selection');

    // Show/hide playoff config based on tournament type
    tipoSelect?.addEventListener('change', () => {
      if (tipoSelect.value === 'grupos_eliminacion') {
        playoffSection?.classList.remove('hidden');
      } else {
        playoffSection?.classList.add('hidden');
      }
    });

    // Show/hide phase selection based on two-legged checkbox
    usaIdaVueltaCheckbox?.addEventListener('change', () => {
      if (usaIdaVueltaCheckbox.checked) {
        phasesSelection?.classList.remove('hidden');
      } else {
        phasesSelection?.classList.add('hidden');
      }
    });

    // --- Modal Logic ---
    const modal = document.getElementById('new-tournament-modal') as HTMLDialogElement;
    modal?.addEventListener('click', (e) => {
      const dialogDimensions = modal.getBoundingClientRect();
      if (
        e.clientX < dialogDimensions.left ||
        e.clientX > dialogDimensions.right ||
        e.clientY < dialogDimensions.top ||
        e.clientY > dialogDimensions.bottom
      ) {
        modal.close();
      }
    });
  </script>
</AdminSidebarLayout>
