---
import PublicLayout from '../../layouts/PublicLayout.astro';
import { supabase } from '../../lib/supabase';

const { id } = Astro.params;

if (!id) return Astro.redirect('/');

// Fetch Team Details with Tournament Name
const { data: equipoRaw, error: equipoError } = await supabase
  .from('equipos')
  .select(`
    *,
    participaciones:torneo_participantes(
        torneo:torneos(id, nombre)
    )
  `)
  .eq('id', id)
  .single();

if (equipoError || !equipoRaw) {
  return Astro.redirect('/');
}

const equipo = equipoRaw;
const tournaments = equipo.participaciones?.map((p: any) => p.torneo) || [];

// Fetch Athletes
const { data: deportistas } = await supabase
  .from('deportistas')
  .select('*')
  .eq('equipo_id', id)
  .order('nombre');
---

<PublicLayout title={`Plantilla: ${equipo.nombre}`}>
  <div class="space-y-12 pb-20 pt-10">
    <!-- Team Profile Header -->
    <div class="bg-white p-8 md:p-12 rounded-[3.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 flex flex-col md:flex-row items-center gap-10 relative overflow-hidden">
        <!-- Decor -->
        <div class="absolute -top-20 -left-20 w-64 h-64 bg-blue-50 rounded-full blur-3xl opacity-50"></div>
        <div class="absolute -bottom-20 -right-20 w-64 h-64 bg-indigo-50 rounded-full blur-3xl opacity-40"></div>

        <div class="relative z-10 w-32 h-32 md:w-40 md:h-40 bg-slate-50 rounded-[3rem] flex items-center justify-center border border-slate-100 overflow-hidden shadow-inner">
            {equipo.logo_url ? (
                <img src={equipo.logo_url} alt={equipo.nombre} class="w-full h-full object-cover" />
            ) : (
                <span class="text-6xl font-black text-slate-200">{equipo.nombre[0]}</span>
            )}
        </div>

        <div class="relative z-10 space-y-4 text-center md:text-left">
            <nav class="flex items-center justify-center md:justify-start gap-2 text-[10px] font-black uppercase tracking-widest text-slate-400">
                <a href="/" class="hover:text-blue-600 transition-colors">Torneos</a>
                {tournaments.length > 0 && (
                     <>
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                        <a href={`/torneo/${tournaments[0].id}`} class="hover:text-blue-600 transition-colors">{tournaments[0].nombre}</a>
                     </>
                )}
            </nav>
            <h1 class="text-4xl md:text-6xl font-black text-slate-900 tracking-tighter uppercase leading-none">{equipo.nombre}</h1>
            <div class="flex items-center justify-center md:justify-start gap-4">
                <span class="bg-blue-600 text-white px-6 py-2 rounded-full text-xs font-black uppercase tracking-widest">Team Official</span>
                <span class="text-slate-400 font-bold text-sm tracking-tight">{deportistas?.length || 0} Atletas Registrados</span>
            </div>
        </div>
    </div>

    <!-- Roster Section -->
    <div class="space-y-8">
        <h2 class="text-3xl font-black text-slate-900 uppercase tracking-tight px-2">Plantilla de Jugadores</h2>
        
        <div class="bg-white rounded-[3.5rem] border border-slate-100 shadow-xl shadow-slate-200/50 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-900">
                            <th class="px-10 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest">Nombre del Atleta</th>
                            <th class="px-10 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest">Posición</th>
                            <th class="px-10 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest text-center">Edad</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {deportistas && deportistas.length > 0 ? deportistas.map((deportista) => (
                            <tr class="hover:bg-blue-50/50 transition-colors group">
                                <td class="px-10 py-8">
                                    <div class="flex items-center gap-6">
                                        <div class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-sm font-black text-slate-300 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-inner">
                                            {deportista.nombre[0]}
                                        </div>
                                        <span class="text-xl font-black text-slate-900 uppercase tracking-tight group-hover:translate-x-1 transition-transform">{deportista.nombre}</span>
                                    </div>
                                </td>
                                <td class="px-10 py-8">
                                    <span class="text-sm font-black text-blue-600 uppercase tracking-widest bg-blue-50 px-4 py-2 rounded-xl group-hover:bg-blue-600 group-hover:text-white transition-all">
                                        {deportista.posicion || 'Universal'}
                                    </span>
                                </td>
                                <td class="px-10 py-8 text-center text-slate-500 font-bold text-lg">
                                    {deportista.edad}
                                </td>
                            </tr>
                        )) : (
                            <tr>
                                <td colspan="3" class="px-10 py-32 text-center">
                                    <div class="flex flex-col items-center gap-4">
                                        <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center shadow-inner">
                                            <svg class="h-10 w-10 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                        </div>
                                        <p class="text-slate-400 font-black uppercase tracking-widest text-xs">Plantilla no disponible aún</p>
                                    </div>
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</PublicLayout>

<style>
    /* Custom hover transition for rows */
    tr {
        cursor: default;
    }
</style>
