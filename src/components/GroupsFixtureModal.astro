---
interface Props {
  torneoId: string;
  totalEquipos: number;
  equipos: { id: string; nombre: string; logo_url?: string | null }[];
}

const { torneoId, totalEquipos, equipos } = Astro.props;
---



<dialog id="groups-fixture-modal" class="fixed inset-0 m-auto z-50 bg-white rounded-[2rem] p-10 shadow-2xl w-full max-w-lg relative backdrop:bg-slate-900/60 focus:outline-none overflow-hidden">
    <button class="modal-close-btn absolute top-8 right-8 z-10 cursor-pointer text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200 rounded-full p-1" aria-label="Cerrar">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
    
    <div class="h-full max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar pb-6">
        <div class="mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-emerald-500/30">
                <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
            </div>
            <h3 class="text-2xl font-black uppercase tracking-tighter text-slate-900">Generar Grupos + Playoff</h3>
            <p class="text-slate-500 font-medium mt-2 leading-relaxed">Configura la fase de grupos. El playoff se genera despu√©s.</p>
        </div>

        <form id="groups-fixture-form" class="space-y-6">
            <input type="hidden" name="torneoId" value={torneoId} />

            <!-- Info Banner -->
            <div class="bg-slate-50 px-5 py-4 rounded-2xl border border-slate-100 flex items-center gap-3">
                <span class="w-10 h-10 bg-slate-200 rounded-xl flex items-center justify-center font-black text-slate-500 text-sm flex-shrink-0">{totalEquipos}</span>
                <div>
                    <span class="block text-sm font-bold text-slate-700">Equipos inscritos</span>
                    <span class="text-xs text-slate-400 font-medium">Se distribuir√°n autom√°ticamente en los grupos</span>
                </div>
            </div>
            
            <!-- Number of Groups -->
            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">N√∫mero de Grupos</label>
                <div class="grid grid-cols-4 gap-2">
                    <label class="group cursor-pointer">
                        <input type="radio" name="numGrupos" value="2" checked class="peer hidden" />
                        <div class="text-center py-3 rounded-xl border-2 border-slate-100 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all hover:border-slate-200">
                            <span class="block text-lg font-black text-slate-900 peer-checked:text-emerald-600">2</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Grupos</span>
                        </div>
                    </label>
                    <label class="group cursor-pointer">
                        <input type="radio" name="numGrupos" value="4" class="peer hidden" />
                        <div class="text-center py-3 rounded-xl border-2 border-slate-100 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all hover:border-slate-200">
                            <span class="block text-lg font-black text-slate-900 peer-checked:text-emerald-600">4</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Grupos</span>
                        </div>
                    </label>
                    <label class="group cursor-pointer">
                        <input type="radio" name="numGrupos" value="6" class="peer hidden" />
                        <div class="text-center py-3 rounded-xl border-2 border-slate-100 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all hover:border-slate-200">
                            <span class="block text-lg font-black text-slate-900 peer-checked:text-emerald-600">6</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Grupos</span>
                        </div>
                    </label>
                    <label class="group cursor-pointer">
                        <input type="radio" name="numGrupos" value="8" class="peer hidden" />
                        <div class="text-center py-3 rounded-xl border-2 border-slate-100 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all hover:border-slate-200">
                            <span class="block text-lg font-black text-slate-900 peer-checked:text-emerald-600">8</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Grupos</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Classified per group -->
            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Clasificados por Grupo</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="group cursor-pointer">
                        <input type="radio" name="clasificadosPorGrupo" value="1" class="peer hidden" />
                        <div class="flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-slate-100 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all hover:border-slate-200">
                            <span class="w-8 h-8 rounded-lg bg-slate-100 peer-checked:bg-emerald-200 flex items-center justify-center font-black text-sm text-slate-500 peer-checked:text-emerald-700">1</span>
                            <div>
                                <span class="block text-sm font-bold text-slate-900">Solo el 1¬∞</span>
                                <span class="text-[10px] text-slate-400 font-medium">Top de cada grupo</span>
                            </div>
                        </div>
                    </label>
                    <label class="group cursor-pointer">
                        <input type="radio" name="clasificadosPorGrupo" value="2" checked class="peer hidden" />
                        <div class="flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-slate-100 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all hover:border-slate-200">
                            <span class="w-8 h-8 rounded-lg bg-slate-100 peer-checked:bg-emerald-200 flex items-center justify-center font-black text-sm text-slate-500 peer-checked:text-emerald-700">2</span>
                            <div>
                                <span class="block text-sm font-bold text-slate-900">Top 2</span>
                                <span class="text-[10px] text-slate-400 font-medium">1¬∞ y 2¬∞ de cada grupo</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Round Type -->
            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100 space-y-3">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Formato en Fase de Grupos</label>
                <label class="flex items-start gap-4 cursor-pointer group">
                    <input type="radio" name="roundType" value="single" checked class="mt-1 w-5 h-5 text-emerald-600 border-slate-300 focus:ring-emerald-500 transition-all" />
                    <div>
                        <span class="block text-sm font-black text-slate-900 uppercase tracking-wide group-hover:text-emerald-600 transition-colors">Solo Ida</span>
                        <span class="text-xs text-slate-400 font-medium">Todos contra todos una sola vez dentro del grupo.</span>
                    </div>
                </label>
                <div class="h-px bg-slate-200"></div>
                <label class="flex items-start gap-4 cursor-pointer group">
                    <input type="radio" name="roundType" value="double" class="mt-1 w-5 h-5 text-teal-600 border-slate-300 focus:ring-teal-500 transition-all" />
                    <div>
                        <span class="block text-sm font-black text-slate-900 uppercase tracking-wide group-hover:text-teal-600 transition-colors">Ida y Vuelta</span>
                        <span class="text-xs text-slate-400 font-medium">Partidos de local y visitante dentro del grupo.</span>
                    </div>
                </label>
            </div>

            <!-- Assignment Mode Toggle -->
            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100 space-y-3">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Asignaci√≥n de Equipos</label>
                <label class="flex items-start gap-4 cursor-pointer group">
                    <input type="radio" name="assignmentMode" value="automatic" checked class="mt-1 w-5 h-5 text-emerald-600 border-slate-300 focus:ring-emerald-500 transition-all" />
                    <div>
                        <span class="block text-sm font-black text-slate-900 uppercase tracking-wide group-hover:text-emerald-600 transition-colors">Autom√°tica</span>
                        <span class="text-xs text-slate-400 font-medium">Los equipos se distribuyen aleatoriamente entre los grupos.</span>
                    </div>
                </label>
                <div class="h-px bg-slate-200"></div>
                <label class="flex items-start gap-4 cursor-pointer group">
                    <input type="radio" name="assignmentMode" value="manual" class="mt-1 w-5 h-5 text-teal-600 border-slate-300 focus:ring-teal-500 transition-all" />
                    <div>
                        <span class="block text-sm font-black text-slate-900 uppercase tracking-wide group-hover:text-teal-600 transition-colors">Manual</span>
                        <span class="text-xs text-slate-400 font-medium">T√∫ decides qu√© equipos van en cada grupo.</span>
                    </div>
                </label>
            </div>

            <!-- Manual Assignment UI (Step 2) -->
            <div id="manual-assignment-section" class="hidden space-y-4 bg-teal-50 border-2 border-teal-200 rounded-2xl p-5">
                <div class="flex items-center gap-2 mb-2">
                    <span class="w-8 h-8 bg-teal-600 text-white rounded-lg flex items-center justify-center font-black text-sm">2</span>
                    <h4 class="text-sm font-black text-teal-900 uppercase tracking-wide">Asignar Equipos a Grupos</h4>
                </div>
                <div id="manual-teams-list" class="space-y-2">
                    <!-- Filled dynamically by JS -->
                </div>
            </div>

            <!-- Preview -->
            <div id="groups-preview" class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-sm font-medium text-emerald-800">
                <!-- Filled dynamically by JS -->
            </div>

            <button type="submit" class="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-slate-900/20 hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                <span>Generar Fase de Grupos</span>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
        </form>
    </div>
</dialog>

<script is:inline define:vars={{ equiposJSON: JSON.stringify(equipos) }}>
    // Make equipos available globally for the main script
    window.GRUPOS_EQUIPOS_DATA = JSON.parse(equiposJSON);
</script>

<script>
    import { actions } from 'astro:actions';

    const modal = document.getElementById('groups-fixture-modal') as HTMLDialogElement;
    const closeBtn = modal?.querySelector('.modal-close-btn');
    const form = document.getElementById('groups-fixture-form') as HTMLFormElement;
    const preview = document.getElementById('groups-preview') as HTMLDivElement;
    const manualSection = document.getElementById('manual-assignment-section');
    const manualTeamsList = document.getElementById('manual-teams-list');

    // Get equipos from global variable
    const equiposData = (window as any).GRUPOS_EQUIPOS_DATA || [];

    // Close modal logic
    closeBtn?.addEventListener('click', () => modal?.close());
    modal?.addEventListener('click', (e) => {
        const rect = modal.getBoundingClientRect();
        const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height && rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
        if (!isInDialog) modal.close();
    });

    // Get total teams from the hidden data
    const totalEquipos = parseInt(form?.querySelector<HTMLInputElement>('input[name="torneoId"]')?.closest('form')?.querySelector<HTMLSpanElement>('.flex.items-center.gap-3 .font-black')?.textContent || '0', 10);

    // Update preview when config changes
    function updatePreview() {
        const formData = new FormData(form);
        const numGrupos = parseInt(formData.get('numGrupos') as string) || 2;
        const clasificados = parseInt(formData.get('clasificadosPorGrupo') as string) || 2;
        const roundType = formData.get('roundType') as string;
        
        // Use actual count from DOM
        const equiposBadge = document.querySelector('#groups-fixture-form .bg-slate-50 .font-black');
        const teamsCount = parseInt(equiposBadge?.textContent || '0', 10);
        
        const equiposPorGrupo = Math.floor(teamsCount / numGrupos);
        const restante = teamsCount % numGrupos;
        const totalClasificados = numGrupos * clasificados;
        const isPow2 = totalClasificados > 0 && (totalClasificados & (totalClasificados - 1)) === 0;
        
        // Calculate playoff round name
        let playoffPhase = '';
        if (totalClasificados === 2) playoffPhase = '‚Üí Gran Final';
        else if (totalClasificados === 4) playoffPhase = '‚Üí Semifinales + Final';
        else if (totalClasificados === 8) playoffPhase = '‚Üí Cuartos + Semifinales + Final';
        else if (totalClasificados === 16) playoffPhase = '‚Üí Octavos + Cuartos + Semifinales + Final';

        const format = roundType === 'double' ? 'ida y vuelta' : 'solo ida';

        if (!isPow2 && totalClasificados > 0) {
            preview.className = 'bg-red-50 border border-red-200 rounded-2xl p-4 text-sm font-medium text-red-700';
            preview.innerHTML = `‚ö†Ô∏è <strong>${totalClasificados} clasificados</strong> no es potencia de 2. Ajusta la configuraci√≥n.`;
        } else if (teamsCount < numGrupos * 2) {
            preview.className = 'bg-amber-50 border border-amber-200 rounded-2xl p-4 text-sm font-medium text-amber-700';
            preview.innerHTML = `‚ö†Ô∏è Se necesitan al menos <strong>${numGrupos * 2} equipos</strong> para ${numGrupos} grupos.`;
        } else {
            preview.className = 'bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-sm font-medium text-emerald-800';
            let html = `<div class="space-y-1">`;
            html += `<div>üìã <strong>${teamsCount} equipos</strong> ‚Üí <strong>${numGrupos} grupos</strong> de ~${equiposPorGrupo} equipos${restante > 0 ? ` (+${restante} extra)` : ''}</div>`;
            html += `<div>üèÜ <strong>${clasificados}</strong> clasificado(s) por grupo = <strong>${totalClasificados} al playoff</strong> ${playoffPhase}</div>`;
            html += `<div>‚öΩ Formato: <strong>${format}</strong> en fase de grupos</div>`;
            html += `</div>`;
            preview.innerHTML = html;
        }
    }

    // Render manual assignment UI
    function renderManualAssignment(numGrupos: number) {
        if (!manualTeamsList) return;

        const groupNames = Array.from({ length: numGrupos }, (_, i) => String.fromCharCode(65 + i));
        
        manualTeamsList.innerHTML = equiposData.map((equipo: any) => `
            <div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-teal-100">
                <div class="flex-1 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-xs font-black overflow-hidden flex-shrink-0">
                        ${equipo.logo_url ? `<img src="${equipo.logo_url}" class="w-full h-full object-cover" alt="${equipo.nombre}" />` : equipo.nombre.substring(0, 2).toUpperCase()}
                    </div>
                    <span class="text-sm font-bold text-slate-900">${equipo.nombre}</span>
                </div>
                <select 
                    name="team_${equipo.id}_group" 
                    class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-900 focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                >
                    ${groupNames.map(name => `<option value="${name}">Grupo ${name}</option>`).join('')}
                </select>
            </div>
        `).join('');
    }

    // Listen to all radio changes
    form?.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const assignmentMode = (form?.querySelector('input[name="assignmentMode"]:checked') as HTMLInputElement)?.value;
            const numGrupos = parseInt((form?.querySelector('input[name="numGrupos"]:checked') as HTMLInputElement)?.value || '2');
            
            if (assignmentMode === 'manual' && manualSection) {
                manualSection.classList.remove('hidden');
                renderManualAssignment(numGrupos);
            } else if (manualSection) {
                manualSection.classList.add('hidden');
            }
            
            updatePreview();
        });
    });

    // Initial preview
    updatePreview();

    // Prevent double submission
    let isSubmitting = false;

    // Form submission
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Prevent double submit
        if (isSubmitting) {
            console.warn('‚ö†Ô∏è [GroupsFixtureModal] Submission already in progress, ignoring duplicate submit');
            return;
        }
        
        const formData = new FormData(form);
        const torneoId = formData.get('torneoId') as string;
        const numGrupos = parseInt(formData.get('numGrupos') as string);
        const clasificadosPorGrupo = parseInt(formData.get('clasificadosPorGrupo') as string);
        const doubleRound = formData.get('roundType') === 'double';
        const assignmentMode = formData.get('assignmentMode') as string;

        // Collect custom assignments if manual mode
        let customAssignments: Record<string, string[]> | undefined;
        if (assignmentMode === 'manual') {
            customAssignments = {};
            equiposData.forEach((equipo: any) => {
                const grupo = formData.get(`team_${equipo.id}_group`) as string;
                if (!customAssignments![grupo]) customAssignments![grupo] = [];
                customAssignments![grupo].push(equipo.id);
            });

            // Validate that all groups have at least one team
            const groupNames = Array.from({ length: numGrupos }, (_, i) => String.fromCharCode(65 + i));
            const emptyGroups = groupNames.filter(name => !customAssignments![name] || customAssignments![name].length === 0);
            
            if (emptyGroups.length > 0) {
                window.showToast(`Los siguientes grupos est√°n vac√≠os: ${emptyGroups.join(', ')}. Todos los grupos deben tener al menos un equipo.`, 'error');
                return;
            }

            // Validate that groups have at least 2 teams each (minimum for a round-robin)
            const smallGroups = groupNames.filter(name => customAssignments![name] && customAssignments![name].length < 2);
            
            if (smallGroups.length > 0) {
                window.showToast(`Los siguientes grupos tienen menos de 2 equipos: ${smallGroups.join(', ')}. Cada grupo necesita al menos 2 equipos para generar partidos.`, 'error');
                return;
            }
        }

        const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        isSubmitting = true;
        btn.innerHTML = '<span class="animate-spin mr-2">‚è≥</span> Generando grupos...';

        try {
            const result = await actions.generateGroupsPlayoff({
                torneoId,
                numGrupos,
                clasificadosPorGrupo,
                doubleRound,
                ...(customAssignments && { customAssignments }),
            });

            if (result.error) {
                window.showToast(result.error.message, 'error');
            } else if (result.data?.success) {
                const url = new URL(window.location.href);
                url.searchParams.set('msg', result.data.message || '¬°Fase de grupos generada exitosamente!');
                url.searchParams.set('type', 'success');
                window.location.href = url.toString();
            } else {
                window.showToast(result.data?.message || 'Error desconocido', 'error');
            }
        } catch (err: any) {
            window.showToast(err.message || 'Error al generar fase de grupos', 'error');
        } finally {
            btn.disabled = false;
            isSubmitting = false;
            btn.innerHTML = originalText;
            modal?.close();
        }
    });

    // Expose open function
    (window as any).openGroupsFixtureModal = () => {
        updatePreview();
        modal?.showModal();
    };
</script>
