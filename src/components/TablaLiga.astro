---
import type { Database } from '../lib/database.types';
import { calculateStandings } from '../lib/standings';

interface Props {
  torneoId: string;
  showFullStats?: boolean;
}

const { torneoId, showFullStats = true } = Astro.props;

// Obtener equipos participantes
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const response = await fetch(
  `${supabaseUrl}/rest/v1/torneo_participantes?torneo_id=eq.${torneoId}&status=eq.aprobado&select=equipo_id,equipos(*)`,
  {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${supabaseAnonKey}`,
    }
  }
);

const participantes = await response.json();
const equipos = participantes.map((p: any) => p.equipos).filter(Boolean);

// Obtener partidos finalizados
const partidosResponse = await fetch(
  `${supabaseUrl}/rest/v1/partidos?jornadas.torneo_id=eq.${torneoId}&estado_partido=eq.finalizado&select=*,jornadas!inner(torneo_id)`,
  {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${supabaseAnonKey}`,
    }
  }
);

const partidos = await partidosResponse.json();

// Calcular tabla de posiciones
const standings = calculateStandings(equipos, partidos);
---

<div class="tabla-liga-container">
  <div class="overflow-x-auto">
    <table class="tabla-liga">
      <thead>
        <tr>
          <th class="pos">#</th>
          <th class="equipo">Equipo</th>
          <th>PJ</th>
          {showFullStats && (
            <>
              <th class="hidden md:table-cell">G</th>
              <th class="hidden md:table-cell">E</th>
              <th class="hidden md:table-cell">P</th>
              <th class="hidden sm:table-cell">GF</th>
              <th class="hidden sm:table-cell">GC</th>
            </>
          )}
          <th>DG</th>
          <th class="pts">Pts</th>
        </tr>
      </thead>
      <tbody>
        {standings.map((row, index) => (
          <tr class={index < 4 ? 'clasificacion' : index >= standings.length - 2 ? 'descenso' : ''}>
            <td class="pos">{index + 1}</td>
            <td class="equipo">
              <div class="equipo-info">
                {row.equipo.logo_url || row.equipo.escudo_url ? (
                  <img 
                    src={row.equipo.logo_url || row.equipo.escudo_url || ''} 
                    alt={row.equipo.nombre}
                    class="equipo-logo"
                  />
                ) : (
                  <div class="equipo-logo-placeholder">
                    {row.equipo.nombre.charAt(0)}
                  </div>
                )}
                <span class="equipo-nombre">{row.equipo.nombre}</span>
              </div>
            </td>
            <td>{row.pj}</td>
            {showFullStats && (
              <>
                <td class="hidden md:table-cell">{row.g}</td>
                <td class="hidden md:table-cell">{row.e}</td>
                <td class="hidden md:table-cell">{row.p}</td>
                <td class="hidden sm:table-cell">{row.gf}</td>
                <td class="hidden sm:table-cell">{row.gc}</td>
              </>
            )}
            <td class={row.dg > 0 ? 'positivo' : row.dg < 0 ? 'negativo' : ''}>{row.dg > 0 ? '+' : ''}{row.dg}</td>
            <td class="pts font-bold">{row.pts}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  {standings.length === 0 && (
    <div class="empty-state">
      <p>No hay datos de clasificación disponibles. Los partidos finalizados aparecerán aquí.</p>
    </div>
  )}
</div>

<style>
  .tabla-liga-container {
    width: 100%;
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
  }

  .tabla-liga {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .tabla-liga thead {
    background: #f3f4f6;
    border-bottom: 2px solid #e5e7eb;
  }

  .tabla-liga th {
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-weight: 600;
    color: #374151;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .tabla-liga th.equipo {
    text-align: left;
  }

  .tabla-liga td {
    padding: 0.75rem 0.5rem;
    text-align: center;
    border-bottom: 1px solid #f3f4f6;
  }

  .tabla-liga tbody tr:hover {
    background: #f9fafb;
  }

  .tabla-liga tbody tr.clasificacion {
    background: #ecfdf5;
    border-left: 4px solid #10b981;
  }

  .tabla-liga tbody tr.descenso {
    background: #fef2f2;
    border-left: 4px solid #ef4444;
  }

  .pos {
    font-weight: 600;
    color: #6b7280;
    width: 3rem;
  }

  .equipo {
    text-align: left !important;
  }

  .equipo-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .equipo-logo {
    width: 2rem;
    height: 2rem;
    border-radius: 0.25rem;
    object-fit: cover;
  }

  .equipo-logo-placeholder {
    width: 2rem;
    height: 2rem;
    border-radius: 0.25rem;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #6b7280;
  }

  .equipo-nombre {
    font-weight: 500;
    color: #111827;
  }

  .pts {
    font-weight: 700;
    color: #1f2937;
    background: #f9fafb;
  }

  .positivo {
    color: #10b981;
    font-weight: 500;
  }

  .negativo {
    color: #ef4444;
    font-weight: 500;
  }

  .empty-state {
    padding: 3rem 1rem;
    text-align: center;
    color: #6b7280;
  }

  @media (max-width: 640px) {
    .tabla-liga {
      font-size: 0.75rem;
    }

    .tabla-liga th,
    .tabla-liga td {
      padding: 0.5rem 0.25rem;
    }

    .equipo-logo,
    .equipo-logo-placeholder {
      width: 1.5rem;
      height: 1.5rem;
    }

    .equipo-info {
      gap: 0.5rem;
    }
  }
</style>
